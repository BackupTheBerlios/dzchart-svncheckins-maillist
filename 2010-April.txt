From twm at mail.berlios.de  Sun Apr 11 13:22:10 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:22:10 +0200
Subject: [Dzchart-svncheckins] r420 - 3rd/jcl/1.99/trunk/source
Message-ID: <201004111122.o3BBMAhO002281@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:22:08 +0200 (Sun, 11 Apr 2010)
New Revision: 420

Added:
   3rd/jcl/1.99/trunk/source/jcld11.inc
Log:
manually copied jcdll11 from the template (don't want to use the installer)

Copied: 3rd/jcl/1.99/trunk/source/jcld11.inc (from rev 419, 3rd/jcl/1.99/tags/1/source/jcl.template.inc)



From twm at mail.berlios.de  Sun Apr 11 13:23:25 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:23:25 +0200
Subject: [Dzchart-svncheckins] r421 - 3rd/jcl/1.99/tags
Message-ID: <201004111123.o3BBNPbY002974@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:23:25 +0200 (Sun, 11 Apr 2010)
New Revision: 421

Added:
   3rd/jcl/1.99/tags/2/
Log:


Copied: 3rd/jcl/1.99/tags/2 (from rev 420, 3rd/jcl/1.99/trunk)



From twm at mail.berlios.de  Sun Apr 11 13:25:28 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:25:28 +0200
Subject: [Dzchart-svncheckins] r422 - utilities/dzLib/trunk/src
Message-ID: <201004111125.o3BBPSRH004263@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:25:28 +0200 (Sun, 11 Apr 2010)
New Revision: 422

Modified:
   utilities/dzLib/trunk/src/u_dzFileStreams.pas
Log:
* Bugfix: Handle is integer, so we must typecase INVALID_HANDLE_VALUE to integer as well

Modified: utilities/dzLib/trunk/src/u_dzFileStreams.pas
===================================================================
--- utilities/dzLib/trunk/src/u_dzFileStreams.pas	2010-04-11 11:23:25 UTC (rev 421)
+++ utilities/dzLib/trunk/src/u_dzFileStreams.pas	2010-04-11 11:25:28 UTC (rev 422)
@@ -334,7 +334,7 @@
 
 procedure TdzFile.SetFilename(const _Filename: string);
 begin
-  if Self.Handle <> Cardinal(INVALID_HANDLE_VALUE) then
+  if Self.Handle <> Integer(INVALID_HANDLE_VALUE) then
     raise EdzFile.Create(_('Cannot change filename when file is open.'));
   FFilename := _Filename;
 end;



From twm at mail.berlios.de  Sun Apr 11 13:26:04 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:26:04 +0200
Subject: [Dzchart-svncheckins] r423 - utilities/dzLib/trunk/src
Message-ID: <201004111126.o3BBQ48O004559@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:26:03 +0200 (Sun, 11 Apr 2010)
New Revision: 423

Modified:
   utilities/dzLib/trunk/src/u_dzStringUtils.pas
Log:
added CharInSet function for Delpi2007 backwards compatibility

Modified: utilities/dzLib/trunk/src/u_dzStringUtils.pas
===================================================================
--- utilities/dzLib/trunk/src/u_dzStringUtils.pas	2010-04-11 11:25:28 UTC (rev 422)
+++ utilities/dzLib/trunk/src/u_dzStringUtils.pas	2010-04-11 11:26:03 UTC (rev 423)
@@ -36,6 +36,10 @@
     '0'..'9', '?', '?', '?', '?', '?', '?', '?'];
   STANDARD_CONTROL_CHARS = [#0..' '];
 
+{$ifndef DELPHI2009_UP}
+function CharInSet(C: AnsiChar; const CharSet: TSysCharSet): Boolean;
+{$endif DELPHI2009_UP}
+
 /// <summary>
 /// function is deprecated, use ExtractStr instead
 /// </summary>
@@ -1217,5 +1221,12 @@
   end;
 end;
 
+{$ifndef DELPHI2009_UP}
+function CharInSet(C: AnsiChar; const CharSet: TSysCharSet): Boolean;
+begin
+  Result := c in CharSet;
+end;
+{$endif DELPHI2009_UP}
+
 end.
 



From twm at mail.berlios.de  Sun Apr 11 13:28:34 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:28:34 +0200
Subject: [Dzchart-svncheckins] r424 - in utilities/dzPrepBuild/trunk: . src
Message-ID: <201004111128.o3BBSY0X005769@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:28:30 +0200 (Sun, 11 Apr 2010)
New Revision: 424

Modified:
   utilities/dzPrepBuild/trunk/
   utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
Log:
* switched to tag "2" of jcl 1.99
* added various units from dzlib to project



Property changes on: utilities/dzPrepBuild/trunk
___________________________________________________________________
Name: svn:externals
   - libs/dzlib https://svn.berlios.de/svnroot/repos/dzchart/utilities/dzLib/trunk
libs/dzCmdLineParser\src https://svn.berlios.de/svnroot/repos/dzchart/utilities/dzCmdLineParser/trunk/src
libs/dzTemplates https://svn.berlios.de/svnroot/repos/dztemplates/trunk
libs/jcl https://svn.berlios.de/svnroot/repos/dzchart/3rd/jcl/1.99/tags/1

   + libs/dzlib https://svn.berlios.de/svnroot/repos/dzchart/utilities/dzLib/trunk
libs/dzCmdLineParser\src https://svn.berlios.de/svnroot/repos/dzchart/utilities/dzCmdLineParser/trunk/src
libs/dzTemplates https://svn.berlios.de/svnroot/repos/dztemplates/trunk
libs/jcl https://svn.berlios.de/svnroot/repos/dzchart/3rd/jcl/1.99/tags/2


Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 11:26:03 UTC (rev 423)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 11:28:30 UTC (rev 424)
@@ -17,7 +17,14 @@
   u_PrepBuildMain in 'u_PrepBuildMain.pas',
   u_DummyVersionInfo in 'u_DummyVersionInfo.pas',
   u_AbstractVersionInfo in 'u_AbstractVersionInfo.pas',
-  u_dzDefaultMain in '..\libs\dzCmdLineParser\src\u_dzDefaultMain.pas';
+  u_dzGetOpt in '..\libs\dzCmdLineParsersrc\u_dzGetOpt.pas',
+  u_dzDefaultMain in '..\libs\dzCmdLineParsersrc\u_dzDefaultMain.pas',
+  u_dzParamDescList in '..\libs\dzCmdLineParsersrc\u_dzParamDescList.pas',
+  u_dzParamFoundList in '..\libs\dzCmdLineParsersrc\u_dzParamFoundList.pas',
+  u_dzOptionDescList in '..\libs\dzCmdLineParsersrc\u_dzOptionDescList.pas',
+  u_dzOptionNameList in '..\libs\dzCmdLineParsersrc\u_dzOptionNameList.pas',
+  u_dzOptionFoundList in '..\libs\dzCmdLineParsersrc\u_dzOptionFoundList.pas',
+  w_dzDialog in '..\libs\dzlib\forms\w_dzDialog.pas' {f_dzDialog};
 
 {$R *_icon.res}
 {$R *_version.res}

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 11:26:03 UTC (rev 423)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 11:28:30 UTC (rev 424)
@@ -38,10 +38,6 @@
     <Borland.ProjectType />
     <BorlandProject>
 <BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readini=src\prepbuild --exec=prep.cmd</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
-      
-      
-      
-      
       <Excluded_Packages Name="$(BDS)\bin\dclofficexp100.bpl">Microsoft Office XP Sample Automation Server Wrapper Components</Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dcloffice2k100.bpl">Microsoft Office 2000 Sample Automation Server Wrapper Components</Excluded_Packages>
     </Excluded_Packages><Source><Source Name="MainSource">PrepBuild.dpr</Source></Source><VersionInfoKeys><VersionInfoKeys Name="CompanyName"></VersionInfoKeys><VersionInfoKeys Name="FileDescription"></VersionInfoKeys><VersionInfoKeys Name="FileVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="InternalName"></VersionInfoKeys><VersionInfoKeys Name="LegalCopyright"></VersionInfoKeys><VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys><VersionInfoKeys Name="OriginalFilename"></VersionInfoKeys><VersionInfoKeys Name="ProductName"></VersionInfoKeys><VersionInfoKeys Name="ProductVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="Comments"></VersionInfoKeys></VersionInfoKeys></Delphi.Personality><ModelSupport>False</ModelSupport></BorlandProject></BorlandProject>
@@ -54,7 +50,16 @@
     <DelphiCompile Include="PrepBuild.dpr">
       <MainSource>MainSource</MainSource>
     </DelphiCompile>
-    <DCCReference Include="..\libs\dzCmdLineParser\src\u_dzDefaultMain.pas" />
+    <DCCReference Include="..\libs\dzCmdLineParsersrc\u_dzDefaultMain.pas" />
+    <DCCReference Include="..\libs\dzCmdLineParsersrc\u_dzGetOpt.pas" />
+    <DCCReference Include="..\libs\dzCmdLineParsersrc\u_dzOptionDescList.pas" />
+    <DCCReference Include="..\libs\dzCmdLineParsersrc\u_dzOptionFoundList.pas" />
+    <DCCReference Include="..\libs\dzCmdLineParsersrc\u_dzOptionNameList.pas" />
+    <DCCReference Include="..\libs\dzCmdLineParsersrc\u_dzParamDescList.pas" />
+    <DCCReference Include="..\libs\dzCmdLineParsersrc\u_dzParamFoundList.pas" />
+    <DCCReference Include="..\libs\dzlib\forms\w_dzDialog.pas">
+      <Form>f_dzDialog</Form>
+    </DCCReference>
     <DCCReference Include="d_BdsProjVersionInfo.pas">
       <Form>dm_BdsProjVersionInfo</Form>
       <DesignClass>TDataModule</DesignClass>

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 11:26:03 UTC (rev 423)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 11:28:30 UTC (rev 424)
@@ -1,3 +1,3 @@
 [Version Info]
-Build=122
+Build=137
 

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 11:26:03 UTC (rev 423)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 11:28:30 UTC (rev 424)
@@ -16,12 +16,12 @@
 [Version Info Keys]
 CompanyName=dummzeuch.de
 FileDescription=commandline and IDE prebuild tool
-FileVersion=1.1.0.122
+FileVersion=1.1.0.137
 InternalName=PrepBuild
 LegalCopyright=Copyright 2002-2007 by Thomas Mueller
 LegalTrademarks=
 OriginalFilename=PrepBuild.exe
 ProductName=PrepBuild
-ProductVersion=2008-03-25
+ProductVersion=2010-04-11
 Comments=Use at your own risk
 



From twm at mail.berlios.de  Sun Apr 11 13:33:12 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:33:12 +0200
Subject: [Dzchart-svncheckins] r425 - in utilities/dzPrepBuild/trunk: .
	buildtools src
Message-ID: <201004111133.o3BBXC2i007668@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:32:50 +0200 (Sun, 11 Apr 2010)
New Revision: 425

Added:
   utilities/dzPrepBuild/trunk/buildtools/prep.cmd
Removed:
   utilities/dzPrepBuild/trunk/prep.cmd
Modified:
   utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
Log:
* moved prep.cmd to buildtools subdir
* update prepbuild.exe in buildtools subdir

Modified: utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
===================================================================
(Binary files differ)

Copied: utilities/dzPrepBuild/trunk/buildtools/prep.cmd (from rev 419, utilities/dzPrepBuild/trunk/prep.cmd)
===================================================================
--- utilities/dzPrepBuild/trunk/prep.cmd	2010-03-27 12:27:00 UTC (rev 419)
+++ utilities/dzPrepBuild/trunk/buildtools/prep.cmd	2010-04-11 11:32:50 UTC (rev 425)
@@ -0,0 +1,3 @@
+ at echo off
+%~dp0\PrepBuild --writerc=%dzProject%_Version.rc --updateini=%dzProject% --MajorVer=%dzVersion.MajorVer% --MinorVer=%dzVersion.MinorVer% --Release=%dzVersion.Release% --Build=%dzVersion.Build% --FileDesc="%dzVersion.FileDesc%" --InternalName="%dzVersion.InternalName%" --OriginalName="%dzVersion.OriginalName%" --Product="%dzVersion.Product%" --ProductVersion="%dzDate%" --Company="%dzVersion.Company%" --Copyright="%dzVersion.Copyright%" --Trademark="%dzVersion.Trademark%" --Comments="%dzVersion.Comments%"
+brcc32 %dzProject%_Version.rc

Deleted: utilities/dzPrepBuild/trunk/prep.cmd
===================================================================
--- utilities/dzPrepBuild/trunk/prep.cmd	2010-04-11 11:28:30 UTC (rev 424)
+++ utilities/dzPrepBuild/trunk/prep.cmd	2010-04-11 11:32:50 UTC (rev 425)
@@ -1,26 +0,0 @@
- at echo off
-echo dzDate=%dzDate%
-echo dzTime=%dzTime%
-echo dzDateTime=%dzDateTime%
-echo dzMyDocuments=%dzMyDocuments%
-echo dzPrepBuild=%dzPrepBuild%
-
-echo dzProject=%dzProject%
-
-echo NajorVer=%dzVersion.MajorVer%
-echo MinorVer=%dzVersion.MinorVer%
-echo Release=%dzVersion.Release%
-echo Build=%dzVersion.Build%
-echo FileDesc=%dzVersion.FileDesc%
-echo InternalName=%dzVersion.InternalName%
-echo OriginalName=%dzVersion.OriginalName%
-echo Product=%dzVersion.Product%
-echo ProductVersion=%dzVersion.ProductVersion%
-echo Company=%dzVersion.Company%
-echo Copyright=%dzVersion.Copyright%
-echo Trademark=%dzVersion.Trademark%
-echo Comments=%dzVersion.Comments%
-
- at echo on
-..\buildtools\PrepBuild --writerc=%dzProject%_Version.rc --updateini=%dzProject% --MajorVer=%dzVersion.MajorVer% --MinorVer=%dzVersion.MinorVer% --Release=%dzVersion.Release% --Build=%dzVersion.Build% --FileDesc="%dzVersion.FileDesc%" --InternalName="%dzVersion.InternalName%" --OriginalName="%dzVersion.OriginalName%" --Product="%dzVersion.Product%" --ProductVersion="%dzDate%" --Company="%dzVersion.Company%" --Copyright="%dzVersion.Copyright%" --Trademark="%dzVersion.Trademark%" --Comments="%dzVersion.Comments%"
-brcc32 %dzProject%_Version.rc

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 11:28:30 UTC (rev 424)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 11:32:50 UTC (rev 425)
@@ -38,13 +38,17 @@
     <Borland.ProjectType />
     <BorlandProject>
 <BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readini=src\prepbuild --exec=prep.cmd</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
+      
+      
+      
+      
       <Excluded_Packages Name="$(BDS)\bin\dclofficexp100.bpl">Microsoft Office XP Sample Automation Server Wrapper Components</Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dcloffice2k100.bpl">Microsoft Office 2000 Sample Automation Server Wrapper Components</Excluded_Packages>
     </Excluded_Packages><Source><Source Name="MainSource">PrepBuild.dpr</Source></Source><VersionInfoKeys><VersionInfoKeys Name="CompanyName"></VersionInfoKeys><VersionInfoKeys Name="FileDescription"></VersionInfoKeys><VersionInfoKeys Name="FileVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="InternalName"></VersionInfoKeys><VersionInfoKeys Name="LegalCopyright"></VersionInfoKeys><VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys><VersionInfoKeys Name="OriginalFilename"></VersionInfoKeys><VersionInfoKeys Name="ProductName"></VersionInfoKeys><VersionInfoKeys Name="ProductVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="Comments"></VersionInfoKeys></VersionInfoKeys></Delphi.Personality><ModelSupport>False</ModelSupport></BorlandProject></BorlandProject>
   </ProjectExtensions>
   <Import Project="$(MSBuildBinPath)\Borland.Delphi.Targets" />
   <PropertyGroup>
-    <PreBuildEvent>..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --exec=..\prep.cmd $(SAVE)</PreBuildEvent>
+    <PreBuildEvent>..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
   </PropertyGroup>
   <ItemGroup>
     <DelphiCompile Include="PrepBuild.dpr">

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 11:28:30 UTC (rev 424)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 11:32:50 UTC (rev 425)
@@ -1,3 +1,3 @@
 [Version Info]
-Build=137
+Build=138
 

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 11:28:30 UTC (rev 424)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 11:32:50 UTC (rev 425)
@@ -16,7 +16,7 @@
 [Version Info Keys]
 CompanyName=dummzeuch.de
 FileDescription=commandline and IDE prebuild tool
-FileVersion=1.1.0.137
+FileVersion=1.1.0.138
 InternalName=PrepBuild
 LegalCopyright=Copyright 2002-2007 by Thomas Mueller
 LegalTrademarks=



From twm at mail.berlios.de  Sun Apr 11 13:40:30 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:40:30 +0200
Subject: [Dzchart-svncheckins] r426 - in
	utilities/dzPrepBuild/trunk/buildtools: . templates
Message-ID: <201004111140.o3BBeU61008715@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:40:26 +0200 (Sun, 11 Apr 2010)
New Revision: 426

Added:
   utilities/dzPrepBuild/trunk/buildtools/!ReadMe.txt
   utilities/dzPrepBuild/trunk/buildtools/MakeJclDbg.exe
   utilities/dzPrepBuild/trunk/buildtools/templates/
   utilities/dzPrepBuild/trunk/buildtools/templates/Build_ScriptTemplate.cmd
   utilities/dzPrepBuild/trunk/buildtools/templates/Template_Icon.rc
   utilities/dzPrepBuild/trunk/buildtools/templates/Template_version.ini
Log:
* added templates Template_Icon.rc and Template_version.ini
* added readme on how to add to pre- and post-build events
* added MakeJclDbg.exe for adding .map file to executable


Added: utilities/dzPrepBuild/trunk/buildtools/!ReadMe.txt
===================================================================
--- utilities/dzPrepBuild/trunk/buildtools/!ReadMe.txt	2010-04-11 11:32:50 UTC (rev 425)
+++ utilities/dzPrepBuild/trunk/buildtools/!ReadMe.txt	2010-04-11 11:40:26 UTC (rev 426)
@@ -0,0 +1,5 @@
+Pre-Build events:
+..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --exec=..\buildtools\prep.cmd $(SAVE)
+
+(optional) Post-Build events:
+..\buildtools\makejcldbg -e $(OUTPUTDIR)\$(OUTPUTNAME).map

Added: utilities/dzPrepBuild/trunk/buildtools/MakeJclDbg.exe
===================================================================
(Binary files differ)


Property changes on: utilities/dzPrepBuild/trunk/buildtools/MakeJclDbg.exe
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: utilities/dzPrepBuild/trunk/buildtools/templates/Build_ScriptTemplate.cmd
===================================================================
--- utilities/dzPrepBuild/trunk/buildtools/templates/Build_ScriptTemplate.cmd	2010-04-11 11:32:50 UTC (rev 425)
+++ utilities/dzPrepBuild/trunk/buildtools/templates/Build_ScriptTemplate.cmd	2010-04-11 11:40:26 UTC (rev 426)
@@ -0,0 +1,8 @@
+ at rem builds a project using msbuild
+ at rem Copy this to the project's root directory and
+ at rem change the <projectname> below
+call "%ProgramFiles%\CodeGear\RAD Studio\5.0\bin\rsvars.bat"
+pushd src
+msbuild <projectname>.dproj
+pause
+popd

Added: utilities/dzPrepBuild/trunk/buildtools/templates/Template_Icon.rc
===================================================================
--- utilities/dzPrepBuild/trunk/buildtools/templates/Template_Icon.rc	2010-04-11 11:32:50 UTC (rev 425)
+++ utilities/dzPrepBuild/trunk/buildtools/templates/Template_Icon.rc	2010-04-11 11:40:26 UTC (rev 426)
@@ -0,0 +1 @@
+MAINICON ICON LOADONCALL MOVEABLE DISCARDABLE IMPURE <programname>.ico

Added: utilities/dzPrepBuild/trunk/buildtools/templates/Template_version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/buildtools/templates/Template_version.ini	2010-04-11 11:32:50 UTC (rev 425)
+++ utilities/dzPrepBuild/trunk/buildtools/templates/Template_version.ini	2010-04-11 11:40:26 UTC (rev 426)
@@ -0,0 +1,18 @@
+[Version Info]
+AutoIncBuild=0
+Build=0
+MajorVer=1
+MinorVer=0
+Release=0
+
+[Version Info Keys]
+FileVersion=1.0.0.0
+ProductVersion=
+FileDescription=<file description here>
+OriginalFilename=<filename here>
+Comments=
+CompanyName=<your company name here>
+InternalName=<internal name here>
+LegalCopyright=<your copyright here>
+LegalTrademarks=<your trademark here
+ProductName=<productname here>



From twm at mail.berlios.de  Sun Apr 11 13:49:46 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:49:46 +0200
Subject: [Dzchart-svncheckins] r427 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111149.o3BBnko9009173@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:49:44 +0200 (Sun, 11 Apr 2010)
New Revision: 427

Added:
   utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini
Modified:
   utilities/dzPrepBuild/trunk/src/
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
Log:
added SVN_Version_template.ini (to be used with subwcrev later)


Property changes on: utilities/dzPrepBuild/trunk/src
___________________________________________________________________
Name: svn:ignore
   - PrepBuild.dsk
PrepBuild.res
PrepBuild_Version.rc
PrepBuild_Version.RES

   + PrepBuild.dsk
PrepBuild.res
PrepBuild_Version.rc
PrepBuild_Version.RES
SVN_Version.ini


Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 11:40:26 UTC (rev 426)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 11:49:44 UTC (rev 427)
@@ -1,3 +1,3 @@
 [Version Info]
-Build=138
+Build=139
 

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 11:40:26 UTC (rev 426)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 11:49:44 UTC (rev 427)
@@ -16,9 +16,9 @@
 [Version Info Keys]
 CompanyName=dummzeuch.de
 FileDescription=commandline and IDE prebuild tool
-FileVersion=1.1.0.138
+FileVersion=1.1.0.139
 InternalName=PrepBuild
-LegalCopyright=Copyright 2002-2007 by Thomas Mueller
+LegalCopyright=Copyright 2002-2010 by Thomas Mueller
 LegalTrademarks=
 OriginalFilename=PrepBuild.exe
 ProductName=PrepBuild

Added: utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini	2010-04-11 11:40:26 UTC (rev 426)
+++ utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini	2010-04-11 11:49:44 UTC (rev 427)
@@ -0,0 +1,3 @@
+[SVN]
+MainVersionRange=$WCRANGE$$WCMODS? modified:$
+URL=$WCURL$



From twm at mail.berlios.de  Sun Apr 11 13:51:58 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 13:51:58 +0200
Subject: [Dzchart-svncheckins] r428 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111151.o3BBpwlX009301@sheep.berlios.de>

Author: twm
Date: 2010-04-11 13:51:57 +0200 (Sun, 11 Apr 2010)
New Revision: 428

Modified:
   utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini
Log:
renamed entry to VersionRange

Modified: utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini	2010-04-11 11:49:44 UTC (rev 427)
+++ utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini	2010-04-11 11:51:57 UTC (rev 428)
@@ -1,3 +1,3 @@
 [SVN]
-MainVersionRange=$WCRANGE$$WCMODS? modified:$
+VersionRange=$WCRANGE$$WCMODS? modified:$
 URL=$WCURL$



From twm at mail.berlios.de  Sun Apr 11 14:02:52 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 14:02:52 +0200
Subject: [Dzchart-svncheckins] r429 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111202.o3BC2qdQ009941@sheep.berlios.de>

Author: twm
Date: 2010-04-11 14:02:50 +0200 (Sun, 11 Apr 2010)
New Revision: 429

Modified:
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
   utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini
Log:
* added subwcrev to pre-build event
* redirected FileVersion to PrepBuild_BuildNo.ini so PrepBuild_Version.ini changes less often
* moved information about local modifications to its own entry rather than appending it to the version range

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 11:51:57 UTC (rev 428)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 12:02:50 UTC (rev 429)
@@ -38,17 +38,14 @@
     <Borland.ProjectType />
     <BorlandProject>
 <BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readini=src\prepbuild --exec=prep.cmd</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
-      
-      
-      
-      
       <Excluded_Packages Name="$(BDS)\bin\dclofficexp100.bpl">Microsoft Office XP Sample Automation Server Wrapper Components</Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dcloffice2k100.bpl">Microsoft Office 2000 Sample Automation Server Wrapper Components</Excluded_Packages>
     </Excluded_Packages><Source><Source Name="MainSource">PrepBuild.dpr</Source></Source><VersionInfoKeys><VersionInfoKeys Name="CompanyName"></VersionInfoKeys><VersionInfoKeys Name="FileDescription"></VersionInfoKeys><VersionInfoKeys Name="FileVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="InternalName"></VersionInfoKeys><VersionInfoKeys Name="LegalCopyright"></VersionInfoKeys><VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys><VersionInfoKeys Name="OriginalFilename"></VersionInfoKeys><VersionInfoKeys Name="ProductName"></VersionInfoKeys><VersionInfoKeys Name="ProductVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="Comments"></VersionInfoKeys></VersionInfoKeys></Delphi.Personality><ModelSupport>False</ModelSupport></BorlandProject></BorlandProject>
   </ProjectExtensions>
   <Import Project="$(MSBuildBinPath)\Borland.Delphi.Targets" />
   <PropertyGroup>
-    <PreBuildEvent>..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
+    <PreBuildEvent>subwcrev .. SVN_Version_template.ini SVN_Version.ini
+..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
   </PropertyGroup>
   <ItemGroup>
     <DelphiCompile Include="PrepBuild.dpr">

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 11:51:57 UTC (rev 428)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 12:02:50 UTC (rev 429)
@@ -1,3 +1,4 @@
 [Version Info]
-Build=139
+Build=143
+FileVersion=1.1.0.143
 

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 11:51:57 UTC (rev 428)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 12:02:50 UTC (rev 429)
@@ -16,7 +16,7 @@
 [Version Info Keys]
 CompanyName=dummzeuch.de
 FileDescription=commandline and IDE prebuild tool
-FileVersion=1.1.0.139
+FileVersion=redirect:PrepBuild_BuildNo.ini,Version Info,FileVersion
 InternalName=PrepBuild
 LegalCopyright=Copyright 2002-2010 by Thomas Mueller
 LegalTrademarks=

Modified: utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini	2010-04-11 11:51:57 UTC (rev 428)
+++ utilities/dzPrepBuild/trunk/src/SVN_Version_template.ini	2010-04-11 12:02:50 UTC (rev 429)
@@ -1,3 +1,4 @@
 [SVN]
-VersionRange=$WCRANGE$$WCMODS? modified:$
 URL=$WCURL$
+VersionRange=$WCRANGE$
+LocalModifications=$WCMODS?yes:no$



From twm at mail.berlios.de  Sun Apr 11 14:56:36 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 14:56:36 +0200
Subject: [Dzchart-svncheckins] r430 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111256.o3BCuaZG014286@sheep.berlios.de>

Author: twm
Date: 2010-04-11 14:56:34 +0200 (Sun, 11 Apr 2010)
New Revision: 430

Modified:
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
   utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas
Log:
minor changes (reordered fields/properties, corrected comments)

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 12:02:50 UTC (rev 429)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 12:56:34 UTC (rev 430)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=143
-FileVersion=1.1.0.143
+Build=144
+FileVersion=1.1.0.144
 

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 12:02:50 UTC (rev 429)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 12:56:34 UTC (rev 430)
@@ -24,4 +24,7 @@
 ProductName=PrepBuild
 ProductVersion=2010-04-11
 Comments=Use at your own risk
+SVNURL=https://twm at svn.berlios.de/svnroot/repos/dzchart/utilities/dzPrepBuild/trunk
+SVNVersionRange=427:429
+SVNLocalModifications=no
 

Modified: utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas	2010-04-11 12:02:50 UTC (rev 429)
+++ utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas	2010-04-11 12:56:34 UTC (rev 430)
@@ -9,18 +9,19 @@
 type
   TAbstractVersionInfo = class(TInterfacedObject)
   private
+    FMajorVer: integer;
+    FMinorVer: integer;
+    FRelease: integer;
+    FBuild: integer;
+
     FFileVersion: string;
     FProductVersion: string;
     FProductName: string;
-    FMinorVer: integer;
     FLegalTrademarks: string;
-    FRelease: integer;
     FLegalCopyright: string;
-    FMajorVer: integer;
     FCompanyName: string;
     FAutoIncBuild: boolean;
     FFileDescription: string;
-    FBuild: integer;
     FInternalName: string;
     FOriginalFilename: string;
     FComments: string;
@@ -62,7 +63,12 @@
     procedure UpdateFileVersion;
     //
     property AutoIncBuild: boolean read GetAutoIncBuild write SetAutoIncBuild;
+    //
+    property MajorVer: integer read GetMajorVer write SetMajorVer;
+    property MinorVer: integer read GetMinorVer write SetMinorVer;
+    property Release: integer read GetRelease write SetRelease;
     property Build: integer read GetBuild write SetBuild;
+    //
     property Comments: string read GetComments write SetComments;
     property CompanyName: string read GetCompanyName write SetCompanyName;
     property FileDescription: string read GetFileDescription write SetFileDescription;
@@ -70,12 +76,9 @@
     property InternalName: string read GetInternalName write SetInternalName;
     property LegalCopyright: string read GetLegalCopyright write SetLegalCopyright;
     property LegalTrademarks: string read GetLegalTrademarks write SetLegalTrademarks;
-    property MajorVer: integer read GetMajorVer write SetMajorVer;
-    property MinorVer: integer read GetMinorVer write SetMinorVer;
     property OriginalFilename: string read GetOriginalFilename write SetOriginalFilename;
     property ProductName: string read GetProductName write SetProductName;
     property ProductVersion: string read GetProductVersion write SetProductVersion;
-    property Release: integer read GetRelease write SetRelease;
   end;
 
 implementation
@@ -83,7 +86,12 @@
 procedure TAbstractVersionInfo.Assign(const _VersionInfo: IVersionInfo);
 begin
   AutoIncBuild := _VersionInfo.AutoIncBuild;
+
+  MajorVer := _VersionInfo.MajorVer;
+  MinorVer := _VersionInfo.MinorVer;
+  Release := _VersionInfo.Release;
   Build := _VersionInfo.Build;
+
   Comments := _VersionInfo.Comments;
   CompanyName := _VersionInfo.CompanyName;
   FileDescription := _VersionInfo.FileDescription;
@@ -91,12 +99,9 @@
   InternalName := _VersionInfo.InternalName;
   LegalCopyright := _VersionInfo.LegalCopyright;
   LegalTrademarks := _VersionInfo.LegalTrademarks;
-  MajorVer := _VersionInfo.MajorVer;
-  MinorVer := _VersionInfo.MinorVer;
   OriginalFilename := _VersionInfo.OriginalFilename;
   ProductName := _VersionInfo.ProductName;
   ProductVersion := _VersionInfo.ProductVersion;
-  Release := _VersionInfo.Release;
 end;
 
 function TAbstractVersionInfo.GetAutoIncBuild: boolean;

Modified: utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas	2010-04-11 12:02:50 UTC (rev 429)
+++ utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas	2010-04-11 12:56:34 UTC (rev 430)
@@ -9,7 +9,7 @@
   u_IniVersionInfo;
 
 type
-  {: This is a specialized versoin of TIniVersionInfo which readds a
+  {: This is a specialized version of TIniVersionInfo which reads a
      <projectname>.dof file, that was used by Delphi up to version 7. }
   TDofVersionInfo = class(TIniVersionInfo, IVersionInfo)
   private

Modified: utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas	2010-04-11 12:02:50 UTC (rev 429)
+++ utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas	2010-04-11 12:56:34 UTC (rev 430)
@@ -106,6 +106,10 @@
 begin
   AutoIncBuild := ReadBool(FInfoSection, 'AutoIncBuild', False);
   Build := ReadInteger(FInfoSection, 'Build', 0);
+  MajorVer := ReadInteger(FInfoSection, 'MajorVer', 0);
+  MinorVer := ReadInteger(FInfoSection, 'MinorVer', 0);
+  Release := ReadInteger(FInfoSection, 'Release', 0);
+
   Comments := ReadString(FInfoKeysSection, 'Comments', '');
   CompanyName := ReadString(FInfoKeysSection, 'CompanyName', '');
   FileDescription := ReadString(FInfoKeysSection, 'FileDescription', '');
@@ -113,12 +117,9 @@
   InternalName := ReadString(FInfoKeysSection, 'InternalName', '');
   LegalCopyright := ReadString(FInfoKeysSection, 'LegalCopyright', '');
   LegalTrademarks := ReadString(FInfoKeysSection, 'LegalTrademarks', '');
-  MajorVer := ReadInteger(FInfoSection, 'MajorVer', 0);
-  MinorVer := ReadInteger(FInfoSection, 'MinorVer', 0);
   OriginalFilename := ReadString(FInfoKeysSection, 'OriginalFilename', '');
   ProductName := ReadString(FInfoKeysSection, 'ProductName', '');
   ProductVersion := ReadString(FInfoKeysSection, 'ProductVersion', '');
-  Release := ReadInteger(FInfoSection, 'Release', 0);
 end;
 
 procedure TIniVersionInfo.WriteValues;



From twm at mail.berlios.de  Sun Apr 11 15:55:38 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 15:55:38 +0200
Subject: [Dzchart-svncheckins] r431 - utilities/dzLib/trunk/src
Message-ID: <201004111355.o3BDtctA019288@sheep.berlios.de>

Author: twm
Date: 2010-04-11 15:55:37 +0200 (Sun, 11 Apr 2010)
New Revision: 431

Added:
   utilities/dzLib/trunk/src/u_dzJclUtils.pas
Log:
new unit u_dzJclUtils.pas

Added: utilities/dzLib/trunk/src/u_dzJclUtils.pas
===================================================================
--- utilities/dzLib/trunk/src/u_dzJclUtils.pas	2010-04-11 12:56:34 UTC (rev 430)
+++ utilities/dzLib/trunk/src/u_dzJclUtils.pas	2010-04-11 13:55:37 UTC (rev 431)
@@ -0,0 +1,202 @@
+unit u_dzJclUtils;
+
+interface
+
+uses
+  SysUtils,
+  Classes,
+  Forms,
+  JclFileUtils;
+
+type
+  TAbstractFileEnumHandler = class
+  public
+    procedure HandleFile(const _Directory: string; const _FileInfo: TSearchRec); virtual; abstract;
+  end;
+
+type
+  TFileEnumCollector = class(TAbstractFileEnumHandler)
+  private
+    FList: TStrings;
+  public
+    constructor Create(_List: TStrings);
+    procedure HandleFile(const _Directory: string; const _FileInfo: TSearchRec); override;
+  end;
+
+type
+  TDirEnumHandler = class
+  private
+    FFileHandler: TAbstractFileEnumHandler;
+    FOnHandleDirectory: TFileHandler;
+    procedure doOnHandleDirectory(const _DirName: string);
+  public
+    constructor Create(_FileHandler: TAbstractFileEnumHandler);
+    procedure HandleDirectory(const _DirName: string);
+    property OnHandleDirectory: TFileHandler read FOnHandleDirectory write FOnHandleDirectory;
+  end;
+
+procedure SigEnumDirectories(const _Root: string; const _HandleDirectory: TFileHandler;
+  const _IncludeHiddenDirectories: Boolean = false; const _SubDirectoriesMask: string = '');
+
+///<summary> appends ' - [fileversion projectversion] to the form's caption
+///          @param Caption is used instead of the original caption, if not empty </summary>
+procedure TForm_AppendVersion(_frm: TForm; _Caption: string = '');
+
+///<summary> gets the file version from the executables version information </summary>
+function TApplication_GetFileVersion: string;
+
+///<summary> gets the product name from the executables version information </summary>
+function TApplication_GetProductName: string;
+
+///<summary> gets the product version from the executables version information </summary>
+function TApplication_GetProductVersion: string;
+
+implementation
+
+uses
+  JclStrings;
+
+constructor TFileEnumCollector.Create(_List: TStrings);
+begin
+  inherited Create;
+  FList := _List;
+end;
+
+procedure TFileEnumCollector.HandleFile(const _Directory: string; const _FileInfo: TSearchRec);
+begin
+  FList.Append(_Directory + _FileInfo.Name);
+end;
+
+{ TEnumDirRecursiveHandler }
+
+constructor TDirEnumHandler.Create(_FileHandler: TAbstractFileEnumHandler);
+begin
+  inherited Create;
+  FFileHandler := _FileHandler;
+end;
+
+procedure TDirEnumHandler.doOnHandleDirectory(const _DirName: string);
+begin
+  if Assigned(FOnHandleDirectory) then
+    FOnHandleDirectory(_DirName);
+end;
+
+procedure TDirEnumHandler.HandleDirectory(const _DirName: string);
+begin
+  doOnHandleDirectory(_DirName);
+  JclFileUtils.EnumFiles(_DirName + '*.*', FFileHandler.HandleFile);
+end;
+
+// copied from JclFileUtils and modified
+
+procedure SigEnumDirectories(const _Root: string; const _HandleDirectory: TFileHandler;
+  const _IncludeHiddenDirectories: Boolean = false; const _SubDirectoriesMask: string = '');
+
+  function CanonicalizedSearchPath(const _Directory: string): string;
+  begin
+// twm: removed, because it strips one backslash:  Result := PathCanonicalize(_Directory);
+    Result := _Directory;
+  // avoid changing "X:" (current directory on drive X:) into "X:\" (root dir.)
+    if Result[Length(Result)] <> ':' then
+      Result := PathAddSeparator(Result);
+  // strip leading "./" resp. ".\"
+    if Pos('.' + DirDelimiter, Result) = 1 then
+      Result := Copy(Result, 3, Length(Result) - 2);
+  end;
+
+var
+  RootDir: string;
+  Attr: Integer;
+
+  procedure Process(const _Directory: string);
+  var
+    DirInfo: TSearchRec;
+    SubDir: string;
+    Found: Boolean;
+  begin
+    _HandleDirectory(_Directory);
+    Found := SysUtils.FindFirst(_Directory + '*', Attr, DirInfo) = 0;
+    try
+
+      while Found do begin
+        if (DirInfo.Name <> '.') and (DirInfo.Name <> '..') and
+          (DirInfo.Attr and faDirectory <> 0) then begin
+          SubDir := _Directory + DirInfo.Name + DirDelimiter;
+          if (_SubDirectoriesMask = '') or StrMatches(_SubDirectoriesMask, SubDir, Length(RootDir)) then
+            Process(SubDir);
+        end;
+        Found := FindNext(DirInfo) = 0;
+      end;
+    finally
+      FindClose(DirInfo);
+    end;
+  end;
+
+begin
+  Assert(Assigned(_HandleDirectory));
+  RootDir := CanonicalizedSearchPath(_Root);
+
+  if _IncludeHiddenDirectories then
+    Attr := faDirectory + faHidden // no effect on Linux
+  else
+    Attr := faDirectory;
+
+  Process(RootDir);
+end;
+
+procedure TForm_AppendVersion(_frm: TForm; _Caption: string = '');
+var
+  VersionInfo: TJclFileVersionInfo;
+  Version: string;
+begin
+  VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
+  try
+    Version := VersionInfo.FileVersion + ' ' + VersionInfo.ProductVersion;
+  finally
+    FreeAndNil(VersionInfo);
+  end;
+
+  if _Caption = '' then
+    _Caption := _frm.Caption;
+
+  _frm.Caption := _Caption + ' - [' + Version + ']';
+end;
+
+function TApplication_GetFileVersion: string;
+var
+  VersionInfo: TJclFileVersionInfo;
+begin
+  VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
+  try
+    Result := VersionInfo.FileVersion;
+  finally
+    FreeAndNil(VersionInfo);
+  end;
+end;
+
+function TApplication_GetProductName: string;
+var
+  VersionInfo: TJclFileVersionInfo;
+begin
+  VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
+  try
+    Result := VersionInfo.ProductName;
+  finally
+    FreeAndNil(VersionInfo);
+  end;
+end;
+
+function TApplication_GetProductVersion: string;
+var
+  VersionInfo: TJclFileVersionInfo;
+begin
+  VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
+  try
+    Result := VersionInfo.ProductVersion;
+  finally
+    FreeAndNil(VersionInfo);
+  end;
+end;
+
+end.
+



From twm at mail.berlios.de  Sun Apr 11 15:59:27 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 15:59:27 +0200
Subject: [Dzchart-svncheckins] r432 - in utilities/dzPrepBuild/trunk:
	buildtools src
Message-ID: <201004111359.o3BDxRAD019732@sheep.berlios.de>

Author: twm
Date: 2010-04-11 15:59:09 +0200 (Sun, 11 Apr 2010)
New Revision: 432

Added:
   utilities/dzPrepBuild/trunk/src/i_VersionInfoAccess.pas
   utilities/dzPrepBuild/trunk/src/u_VersionInfo.pas
Removed:
   utilities/dzPrepBuild/trunk/src/i_VersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas
Modified:
   utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
   utilities/dzPrepBuild/trunk/buildtools/prep.cmd
   utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
   utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_CentralIniVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_DummyVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
Log:
* split container for version info from reading/writing code
* version 1.2

Modified: utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
===================================================================
(Binary files differ)

Modified: utilities/dzPrepBuild/trunk/buildtools/prep.cmd
===================================================================
--- utilities/dzPrepBuild/trunk/buildtools/prep.cmd	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/buildtools/prep.cmd	2010-04-11 13:59:09 UTC (rev 432)
@@ -1,3 +1,3 @@
- at echo off
+ at echo on
 %~dp0\PrepBuild --writerc=%dzProject%_Version.rc --updateini=%dzProject% --MajorVer=%dzVersion.MajorVer% --MinorVer=%dzVersion.MinorVer% --Release=%dzVersion.Release% --Build=%dzVersion.Build% --FileDesc="%dzVersion.FileDesc%" --InternalName="%dzVersion.InternalName%" --OriginalName="%dzVersion.OriginalName%" --Product="%dzVersion.Product%" --ProductVersion="%dzDate%" --Company="%dzVersion.Company%" --Copyright="%dzVersion.Copyright%" --Trademark="%dzVersion.Trademark%" --Comments="%dzVersion.Comments%"
 brcc32 %dzProject%_Version.rc

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 13:59:09 UTC (rev 432)
@@ -10,13 +10,13 @@
   Forms,
   oxmldom,
   d_BdsProjVersionInfo in 'd_BdsProjVersionInfo.pas' {dm_BdsProjVersionInfo: TDataModule},
-  i_VersionInfo in 'i_VersionInfo.pas',
+  i_VersionInfoAccess in 'i_VersionInfoAccess.pas',
   u_DofVersionInfo in 'u_DofVersionInfo.pas',
   u_IniVersionInfo in 'u_IniVersionInfo.pas',
   u_CentralIniVersionInfo in 'u_CentralIniVersionInfo.pas',
   u_PrepBuildMain in 'u_PrepBuildMain.pas',
   u_DummyVersionInfo in 'u_DummyVersionInfo.pas',
-  u_AbstractVersionInfo in 'u_AbstractVersionInfo.pas',
+  u_VersionInfo in 'u_VersionInfo.pas',
   u_dzGetOpt in '..\libs\dzCmdLineParsersrc\u_dzGetOpt.pas',
   u_dzDefaultMain in '..\libs\dzCmdLineParsersrc\u_dzDefaultMain.pas',
   u_dzParamDescList in '..\libs\dzCmdLineParsersrc\u_dzParamDescList.pas',
@@ -24,7 +24,8 @@
   u_dzOptionDescList in '..\libs\dzCmdLineParsersrc\u_dzOptionDescList.pas',
   u_dzOptionNameList in '..\libs\dzCmdLineParsersrc\u_dzOptionNameList.pas',
   u_dzOptionFoundList in '..\libs\dzCmdLineParsersrc\u_dzOptionFoundList.pas',
-  w_dzDialog in '..\libs\dzlib\forms\w_dzDialog.pas' {f_dzDialog};
+  w_dzDialog in '..\libs\dzlib\forms\w_dzDialog.pas' {f_dzDialog},
+  u_dzJclUtils in '..\libs\dzlib\src\u_dzJclUtils.pas';
 
 {$R *_icon.res}
 {$R *_version.res}

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 13:59:09 UTC (rev 432)
@@ -37,7 +37,7 @@
     <Borland.Personality>Delphi.Personality</Borland.Personality>
     <Borland.ProjectType />
     <BorlandProject>
-<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readini=src\prepbuild --exec=prep.cmd</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
+<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readini=src\prepbuild --exec=buildtools\prep.cmd</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dclofficexp100.bpl">Microsoft Office XP Sample Automation Server Wrapper Components</Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dcloffice2k100.bpl">Microsoft Office 2000 Sample Automation Server Wrapper Components</Excluded_Packages>
     </Excluded_Packages><Source><Source Name="MainSource">PrepBuild.dpr</Source></Source><VersionInfoKeys><VersionInfoKeys Name="CompanyName"></VersionInfoKeys><VersionInfoKeys Name="FileDescription"></VersionInfoKeys><VersionInfoKeys Name="FileVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="InternalName"></VersionInfoKeys><VersionInfoKeys Name="LegalCopyright"></VersionInfoKeys><VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys><VersionInfoKeys Name="OriginalFilename"></VersionInfoKeys><VersionInfoKeys Name="ProductName"></VersionInfoKeys><VersionInfoKeys Name="ProductVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="Comments"></VersionInfoKeys></VersionInfoKeys></Delphi.Personality><ModelSupport>False</ModelSupport></BorlandProject></BorlandProject>
@@ -61,16 +61,17 @@
     <DCCReference Include="..\libs\dzlib\forms\w_dzDialog.pas">
       <Form>f_dzDialog</Form>
     </DCCReference>
+    <DCCReference Include="..\libs\dzlib\src\u_dzJclUtils.pas" />
     <DCCReference Include="d_BdsProjVersionInfo.pas">
       <Form>dm_BdsProjVersionInfo</Form>
       <DesignClass>TDataModule</DesignClass>
     </DCCReference>
-    <DCCReference Include="i_VersionInfo.pas" />
-    <DCCReference Include="u_AbstractVersionInfo.pas" />
+    <DCCReference Include="i_VersionInfoAccess.pas" />
     <DCCReference Include="u_CentralIniVersionInfo.pas" />
     <DCCReference Include="u_DofVersionInfo.pas" />
     <DCCReference Include="u_DummyVersionInfo.pas" />
     <DCCReference Include="u_IniVersionInfo.pas" />
     <DCCReference Include="u_PrepBuildMain.pas" />
+    <DCCReference Include="u_VersionInfo.pas" />
   </ItemGroup>
 </Project>
\ No newline at end of file

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 13:59:09 UTC (rev 432)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=144
-FileVersion=1.1.0.144
+Build=215
+FileVersion=1.2.0.215
 

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 13:59:09 UTC (rev 432)
@@ -1,17 +1,9 @@
 [Version Info]
-IncludeVerInfo=1
-AutoIncBuild=0
 MajorVer=1
-MinorVer=1
+MinorVer=2
 Release=0
 Build=redirect:PrepBuild_BuildNo.ini,Version Info,Build
-Debug=0
-PreRelease=0
-Special=0
-Private=0
-DLL=0
-Locale=1033
-CodePage=1252
+AutoIncBuild=0
 
 [Version Info Keys]
 CompanyName=dummzeuch.de

Modified: utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -10,10 +10,11 @@
   XMLIntf,
   msxmldom,
   XMLDoc,
-  i_VersionInfo;
+  u_VersionInfo,
+  i_VersionInfoAccess;
 
 type
-  Tdm_BdsProjVersionInfo = class(TDataModule, IVersionInfo)
+  Tdm_BdsProjVersionInfo = class(TDataModule, IVersionInfoAccess)
     ProjDoc: TXMLDocument;
   private
     FProjectName: string;
@@ -28,59 +29,10 @@
     function QueryInterface(const IID: TGUID; out Obj): HResult; override; stdcall;
     function _AddRef: integer; stdcall;
     function _Release: integer; stdcall;
-  protected
   protected // implementation of IVersionInfo
-    function GetBuild: integer;
-    procedure SetBuild(_Build: integer);
-    function GetMajorVer: integer;
-    procedure SetMajorVer(_MajorVer: integer);
-    function GetMinorVer: integer;
-    procedure SetMinorVer(_MinorVer: integer);
-    function GetRelease: integer;
-    procedure SetRelease(_Release: integer);
-    function GetCompanyName: string;
-    procedure SetCompanyName(_CompanyName: string);
-    function GetFileDescription: string;
-    procedure SetFileDescription(_FileDescription: string);
-    function GetFileVersion: string;
-    procedure SetFileVersion(_FileVersion: string);
-    function GetInternalName: string;
-    procedure SetInternalName(_InternalName: string);
-    function GetLegalCopyright: string;
-    procedure SetLegalCopyright(_LegalCopyright: string);
-    function GetLegalTrademarks: string;
-    procedure SetLegalTrademarks(_LegalTrademarks: string);
-    function GetOriginalFilename: string;
-    procedure SetOriginalFilename(_OriginalFilename: string);
-    function GetProductName: string;
-    procedure SetProductName(_ProductName: string);
-    function GetProductVersion: string;
-    procedure SetProductVersion(_ProductVersion: string);
-    function GetAutoIncBuild: boolean;
-    procedure SetAutoIncBuild(_AutoIncBuild: boolean);
-    function GetComments: string;
-    procedure SetComments(const _Comments: string);
-  //
-    procedure Assign(const _VersionInfo: IVersionInfo); reintroduce;
-    procedure UpdateFile;
-    procedure UpdateFileVersion;
     function VerInfoFilename: string;
-  //
-    property AutoIncBuild: boolean read GetAutoIncBuild write SetAutoIncBuild;
-    property Build: integer read GetBuild write SetBuild;
-    property Comments: string read GetComments write SetComments;
-    property CompanyName: string read GetCompanyName write SetCompanyName;
-    property FileDescription: string read GetFileDescription write SetFileDescription;
-    property FileVersion: string read GetFileVersion write SetFileVersion;
-    property InternalName: string read GetInternalName write SetInternalName;
-    property LegalCopyright: string read GetLegalCopyright write SetLegalCopyright;
-    property LegalTrademarks: string read GetLegalTrademarks write SetLegalTrademarks;
-    property MajorVer: integer read GetMajorVer write SetMajorVer;
-    property MinorVer: integer read GetMinorVer write SetMinorVer;
-    property OriginalFilename: string read GetOriginalFilename write SetOriginalFilename;
-    property ProductName: string read GetProductName write SetProductName;
-    property ProductVersion: string read GetProductVersion write SetProductVersion;
-    property Release: integer read GetRelease write SetRelease;
+    procedure ReadFromFile(_VerInfo: TVersionInfo);
+    procedure WriteToFile(_VerInfo: TVersionInfo);
   protected
     FBdsProjFile: string;
     FVersionInfo: IXMLNode;
@@ -89,7 +41,6 @@
     constructor Create(const _Project: string); reintroduce;
     destructor Destroy; override;
     class function FilenameFor(const _Project: string): string;
-
   end;
 
 implementation
@@ -102,25 +53,6 @@
 
 { Tdm_BdsProjVersionInfo }
 
-procedure Tdm_BdsProjVersionInfo.Assign(const _VersionInfo: IVersionInfo);
-begin
-  AutoIncBuild := _VersionInfo.AutoIncBuild;
-  Build := _VersionInfo.Build;
-  Comments := _VersionInfo.Comments;
-  CompanyName := _VersionInfo.CompanyName;
-  FileDescription := _VersionInfo.FileDescription;
-  FileVersion := _VersionInfo.FileVersion;
-  InternalName := _VersionInfo.InternalName;
-  LegalCopyright := _VersionInfo.LegalCopyright;
-  LegalTrademarks := _VersionInfo.LegalTrademarks;
-  MajorVer := _VersionInfo.MajorVer;
-  MinorVer := _VersionInfo.MinorVer;
-  OriginalFilename := _VersionInfo.OriginalFilename;
-  ProductName := _VersionInfo.ProductName;
-  ProductVersion := _VersionInfo.ProductVersion;
-  Release := _VersionInfo.Release;
-end;
-
 function Tdm_BdsProjVersionInfo.GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
 var
   Node: IXMLNode;
@@ -195,156 +127,47 @@
   Result := ChangeFileExt(_Project, '.bdsproj');
 end;
 
-function Tdm_BdsProjVersionInfo.GetAutoIncBuild: boolean;
+procedure Tdm_BdsProjVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
 begin
-  Result := SameText(GetVersionInfo('AutoIncBuild'), 'True');
-end;
+  _VerInfo.AutoIncBuild := SameText(GetVersionInfo('AutoIncBuild'), 'True');
 
-function Tdm_BdsProjVersionInfo.GetBuild: integer;
-begin
-  Result := StrToIntDef(GetVersionInfo('Build'), 0);
-end;
+  _VerInfo.MajorVer := StrToIntDef(GetVersionInfo('MajorVer'), 0);
+  _VerInfo.MinorVer := StrToIntDef(GetVersionInfo('MinorVer'), 0);
+  _VerInfo.Release := StrToIntDef(GetVersionInfo('Release'), 0);
+  _VerInfo.Build := StrToIntDef(GetVersionInfo('Build'), 0);
 
-function Tdm_BdsProjVersionInfo.GetComments: string;
-begin
-  Result := GetVersionInfoKey('Comments');
+  _VerInfo.Comments := GetVersionInfoKey('Comments');
+  _VerInfo.CompanyName := GetVersionInfoKey('CompanyName');
+  _VerInfo.FileDescription := GetVersionInfoKey('FileDescription');
+  _VerInfo.FileVersion := GetVersionInfoKey('FileVersion');
+  _VerInfo.InternalName := GetVersionInfoKey('InternalName');
+  _VerInfo.LegalCopyright := GetVersionInfoKey('LegalCopyright');
+  _VerInfo.LegalTrademarks := GetVersionInfoKey('LegalTrademarks');
+  _VerInfo.OriginalFilename := GetVersionInfoKey('OriginalFilename');
+  _VerInfo.ProductName := GetVersionInfoKey('ProductName');
+  _VerInfo.ProductVersion := GetVersionInfoKey('ProductVersion');
 end;
 
-function Tdm_BdsProjVersionInfo.GetCompanyName: string;
+procedure Tdm_BdsProjVersionInfo.WriteToFile(_VerInfo: TVersionInfo);
 begin
-  Result := GetVersionInfoKey('CompanyName');
+  SetVersionInfo('AutoIncBuild', IfThen(_VerInfo.AutoIncBuild, 'True', 'False'));
+  SetVersionInfo('Build', IntToStr(_VerInfo.Build));
+  SetVersionInfoKey('Comments', _VerInfo.Comments);
+  SetVersionInfoKey('CompanyName', _VerInfo.CompanyName);
+  SetVersionInfoKey('FileDescription', _VerInfo.FileDescription);
+  SetVersionInfoKey('FileVersion', _VerInfo.FileVersion);
+  SetVersionInfoKey('InternalName', _VerInfo.InternalName);
+  SetVersionInfoKey('LegalCopyright', _VerInfo.LegalCopyright);
+  SetVersionInfoKey('LegalTrademarks', _VerInfo.LegalTrademarks);
+  SetVersionInfo('MajorVer', IntToStr(_VerInfo.MajorVer));
+  SetVersionInfo('MinorVer', IntToStr(_VerInfo.MinorVer));
+  SetVersionInfoKey('OriginalFilename', _VerInfo.OriginalFilename);
+  SetVersionInfoKey('ProductName', _VerInfo.ProductName);
+  SetVersionInfoKey('ProductVersion', _VerInfo.ProductVersion);
+  SetVersionInfo('Release', IntToStr(_VerInfo.Release));
+  ProjDoc.SaveToFile(FBdsProjFile);
 end;
 
-function Tdm_BdsProjVersionInfo.GetFileDescription: string;
-begin
-  Result := GetVersionInfoKey('FileDescription');
-end;
-
-function Tdm_BdsProjVersionInfo.GetFileVersion: string;
-begin
-  Result := GetVersionInfoKey('FileVersion');
-end;
-
-function Tdm_BdsProjVersionInfo.GetInternalName: string;
-begin
-  Result := GetVersionInfoKey('InternalName');
-end;
-
-function Tdm_BdsProjVersionInfo.GetLegalCopyright: string;
-begin
-  Result := GetVersionInfoKey('LegalCopyright');
-end;
-
-function Tdm_BdsProjVersionInfo.GetLegalTrademarks: string;
-begin
-  Result := GetVersionInfoKey('LegalTrademarks');
-end;
-
-function Tdm_BdsProjVersionInfo.GetMajorVer: integer;
-begin
-  Result := StrToIntDef(GetVersionInfo('MajorVer'), 0);
-end;
-
-function Tdm_BdsProjVersionInfo.GetMinorVer: integer;
-begin
-  Result := StrToIntDef(GetVersionInfo('MinorVer'), 0);
-end;
-
-function Tdm_BdsProjVersionInfo.GetOriginalFilename: string;
-begin
-  Result := GetVersionInfoKey('OriginalFilename');
-end;
-
-function Tdm_BdsProjVersionInfo.GetProductName: string;
-begin
-  Result := GetVersionInfoKey('ProductName');
-end;
-
-function Tdm_BdsProjVersionInfo.GetProductVersion: string;
-begin
-  Result := GetVersionInfoKey('ProductVersion');
-end;
-
-function Tdm_BdsProjVersionInfo.GetRelease: integer;
-begin
-  Result := StrToIntDef(GetVersionInfo('Release'), 0);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetAutoIncBuild(_AutoIncBuild: boolean);
-begin
-  SetVersionInfo('AutoIncBuild', IfThen(_AutoIncBuild, 'True', 'False'));
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetBuild(_Build: integer);
-begin
-  SetVersionInfo('Build', IntToStr(_Build));
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetComments(const _Comments: string);
-begin
-  SetVersionInfoKey('Comments', _Comments);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetCompanyName(_CompanyName: string);
-begin
-  SetVersionInfoKey('CompanyName', _CompanyName);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetFileDescription(_FileDescription: string);
-begin
-  SetVersionInfoKey('FileDescription', _FileDescription);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetFileVersion(_FileVersion: string);
-begin
-  SetVersionInfoKey('FileVersion', _FileVersion);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetInternalName(_InternalName: string);
-begin
-  SetVersionInfoKey('InternalName', _InternalName);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetLegalCopyright(_LegalCopyright: string);
-begin
-  SetVersionInfoKey('LegalCopyright', _LegalCopyright);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetLegalTrademarks(_LegalTrademarks: string);
-begin
-  SetVersionInfoKey('LegalTrademarks', _LegalTrademarks);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetMajorVer(_MajorVer: integer);
-begin
-  SetVersionInfo('MajorVer', IntToStr(_MajorVer));
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetMinorVer(_MinorVer: integer);
-begin
-  SetVersionInfo('MinorVer', IntToStr(_MinorVer));
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetOriginalFilename(_OriginalFilename: string);
-begin
-  SetVersionInfoKey('OriginalFilename', _OriginalFilename);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetProductName(_ProductName: string);
-begin
-  SetVersionInfoKey('ProductName', _ProductName);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetProductVersion(_ProductVersion: string);
-begin
-  SetVersionInfoKey('ProductVersion', _ProductVersion);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetRelease(_Release: integer);
-begin
-  SetVersionInfo('Release', IntToStr(_Release));
-end;
-
 procedure Tdm_BdsProjVersionInfo.SetVersionInfo(const _Name, _Value: string);
 begin
   SetChildNodeContent(FVersionInfo, 'VersionInfo', _Name, _Value);
@@ -355,16 +178,6 @@
   SetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name, _Value);
 end;
 
-procedure Tdm_BdsProjVersionInfo.UpdateFile;
-begin
-  ProjDoc.SaveToFile(FBdsProjFile);
-end;
-
-procedure Tdm_BdsProjVersionInfo.UpdateFileVersion;
-begin
-  FileVersion := Format('%d.%d.%d.%d', [MajorVer, MinorVer, Release, Build]);
-end;
-
 function Tdm_BdsProjVersionInfo.VerInfoFilename: string;
 begin
   Result := FilenameFor(FProjectName);

Deleted: utilities/dzPrepBuild/trunk/src/i_VersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/i_VersionInfo.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/i_VersionInfo.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -1,70 +0,0 @@
-unit i_VersionInfo;
-
-interface
-
-uses
-  SysUtils;
-
-type
-  ENoVersionInfo = class(Exception);
-
-type
-  IVersionInfo = interface ['{C228DED6-C3B2-43C0-B061-28EA5D2EB93C}']
-    function GetBuild: integer;
-    procedure SetBuild(_Build: integer);
-    function GetMajorVer: integer;
-    procedure SetMajorVer(_MajorVer: integer);
-    function GetMinorVer: integer;
-    procedure SetMinorVer(_MinorVer: integer);
-    function GetRelease: integer;
-    procedure SetRelease(_Release: integer);
-    function GetCompanyName: string;
-    procedure SetCompanyName(_CompanyName: string);
-    function GetFileDescription: string;
-    procedure SetFileDescription(_FileDescription: string);
-    function GetFileVersion: string;
-    procedure SetFileVersion(_FileVersion: string);
-    function GetInternalName: string;
-    procedure SetInternalName(_InternalName: string);
-    function GetLegalCopyright: string;
-    procedure SetLegalCopyright(_LegalCopyright: string);
-    function GetLegalTrademarks: string;
-    procedure SetLegalTrademarks(_LegalTrademarks: string);
-    function GetOriginalFilename: string;
-    procedure SetOriginalFilename(_OriginalFilename: string);
-    function GetProductName: string;
-    procedure SetProductName(_ProductName: string);
-    function GetProductVersion: string;
-    procedure SetProductVersion(_ProductVersion: string);
-    function GetAutoIncBuild: boolean;
-    procedure SetAutoIncBuild(_AutoIncBuild: boolean);
-    function GetComments: string;
-    procedure SetComments(const _Comments: string);
-  //
-    procedure Assign(const _VersionInfo: IVersionInfo);
-    procedure UpdateFileVersion;
-    procedure UpdateFile;
-  //
-    function VerInfoFilename: string;
-  //
-    property AutoIncBuild: boolean read GetAutoIncBuild write SetAutoIncBuild;
-    property Build: integer read GetBuild write SetBuild;
-    property Comments: string read GetComments write SetComments;
-    property CompanyName: string read GetCompanyName write SetCompanyName;
-    property FileDescription: string read GetFileDescription write SetFileDescription;
-    property FileVersion: string read GetFileVersion write SetFileVersion;
-    property InternalName: string read GetInternalName write SetInternalName;
-    property LegalCopyright: string read GetLegalCopyright write SetLegalCopyright;
-    property LegalTrademarks: string read GetLegalTrademarks write SetLegalTrademarks;
-    property MajorVer: integer read GetMajorVer write SetMajorVer;
-    property MinorVer: integer read GetMinorVer write SetMinorVer;
-    property OriginalFilename: string read GetOriginalFilename write SetOriginalFilename;
-    property ProductName: string read GetProductName write SetProductName;
-    property ProductVersion: string read GetProductVersion write SetProductVersion;
-    property Release: integer read GetRelease write SetRelease;
-  end;
-
-implementation
-
-end.
-

Copied: utilities/dzPrepBuild/trunk/src/i_VersionInfoAccess.pas (from rev 431, utilities/dzPrepBuild/trunk/src/i_VersionInfo.pas)
===================================================================
--- utilities/dzPrepBuild/trunk/src/i_VersionInfo.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/i_VersionInfoAccess.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -0,0 +1,21 @@
+unit i_VersionInfoAccess;
+
+interface
+
+uses
+  SysUtils,
+  u_VersionInfo;
+
+type
+  ENoVersionInfo = class(Exception);
+
+type
+  IVersionInfoAccess = interface ['{57B36255-0A4B-4F62-9007-B4D211C2185D}']
+    procedure ReadFromFile(_VerInfo: TVersionInfo);
+    procedure WriteToFile(_VerInfo: TVersionInfo);
+  end;
+
+implementation
+
+end.
+

Deleted: utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -1,263 +0,0 @@
-unit u_AbstractVersionInfo;
-
-interface
-
-uses
-  SysUtils,
-  i_VersionInfo;
-
-type
-  TAbstractVersionInfo = class(TInterfacedObject)
-  private
-    FMajorVer: integer;
-    FMinorVer: integer;
-    FRelease: integer;
-    FBuild: integer;
-
-    FFileVersion: string;
-    FProductVersion: string;
-    FProductName: string;
-    FLegalTrademarks: string;
-    FLegalCopyright: string;
-    FCompanyName: string;
-    FAutoIncBuild: boolean;
-    FFileDescription: string;
-    FInternalName: string;
-    FOriginalFilename: string;
-    FComments: string;
-  protected
-    procedure Assign(const _VersionInfo: IVersionInfo); virtual;
-    function GetAutoIncBuild: Boolean; virtual;
-    function GetBuild: Integer; virtual;
-    function GetComments: string; virtual;
-    function GetCompanyName: string; virtual;
-    function GetFileDescription: string; virtual;
-    function GetFileVersion: string; virtual;
-    function GetInternalName: string; virtual;
-    function GetLegalCopyright: string; virtual;
-    function GetLegalTrademarks: string; virtual;
-    function GetMajorVer: Integer; virtual;
-    function GetMinorVer: Integer; virtual;
-    function GetOriginalFilename: string;
-    function GetProductName: string; virtual;
-    function GetProductVersion: string; virtual;
-    function GetRelease: Integer; virtual;
-    procedure SetAutoIncBuild(_AutoIncBuild: Boolean); virtual;
-    procedure SetBuild(_Build: Integer); virtual;
-    procedure SetComments(const _Comments: string); virtual;
-    procedure SetCompanyName(_CompanyName: string); virtual;
-    procedure SetFileDescription(_FileDescription: string); virtual;
-    procedure SetFileVersion(_FileVersion: string); virtual;
-    procedure SetInternalName(_InternalName: string); virtual;
-    procedure SetLegalCopyright(_LegalCopyright: string); virtual;
-    procedure SetLegalTrademarks(_LegalTrademarks: string); virtual;
-    procedure SetMajorVer(_MajorVer: Integer); virtual;
-    procedure SetMinorVer(_MinorVer: Integer); virtual;
-    procedure SetOriginalFilename(_OriginalFilename: string); virtual;
-    procedure SetProductName(_ProductName: string); virtual;
-    procedure SetProductVersion(_ProductVersion: string); virtual;
-    procedure SetRelease(_Release: Integer); virtual;
-    //
-    procedure UpdateFile; virtual; abstract;
-    function VerInfoFilename: string; virtual; abstract;
-    procedure UpdateFileVersion;
-    //
-    property AutoIncBuild: boolean read GetAutoIncBuild write SetAutoIncBuild;
-    //
-    property MajorVer: integer read GetMajorVer write SetMajorVer;
-    property MinorVer: integer read GetMinorVer write SetMinorVer;
-    property Release: integer read GetRelease write SetRelease;
-    property Build: integer read GetBuild write SetBuild;
-    //
-    property Comments: string read GetComments write SetComments;
-    property CompanyName: string read GetCompanyName write SetCompanyName;
-    property FileDescription: string read GetFileDescription write SetFileDescription;
-    property FileVersion: string read GetFileVersion write SetFileVersion;
-    property InternalName: string read GetInternalName write SetInternalName;
-    property LegalCopyright: string read GetLegalCopyright write SetLegalCopyright;
-    property LegalTrademarks: string read GetLegalTrademarks write SetLegalTrademarks;
-    property OriginalFilename: string read GetOriginalFilename write SetOriginalFilename;
-    property ProductName: string read GetProductName write SetProductName;
-    property ProductVersion: string read GetProductVersion write SetProductVersion;
-  end;
-
-implementation
-
-procedure TAbstractVersionInfo.Assign(const _VersionInfo: IVersionInfo);
-begin
-  AutoIncBuild := _VersionInfo.AutoIncBuild;
-
-  MajorVer := _VersionInfo.MajorVer;
-  MinorVer := _VersionInfo.MinorVer;
-  Release := _VersionInfo.Release;
-  Build := _VersionInfo.Build;
-
-  Comments := _VersionInfo.Comments;
-  CompanyName := _VersionInfo.CompanyName;
-  FileDescription := _VersionInfo.FileDescription;
-  FileVersion := _VersionInfo.FileVersion;
-  InternalName := _VersionInfo.InternalName;
-  LegalCopyright := _VersionInfo.LegalCopyright;
-  LegalTrademarks := _VersionInfo.LegalTrademarks;
-  OriginalFilename := _VersionInfo.OriginalFilename;
-  ProductName := _VersionInfo.ProductName;
-  ProductVersion := _VersionInfo.ProductVersion;
-end;
-
-function TAbstractVersionInfo.GetAutoIncBuild: boolean;
-begin
-  Result := FAutoIncBuild;
-end;
-
-function TAbstractVersionInfo.GetBuild: integer;
-begin
-  Result := FBuild;
-end;
-
-function TAbstractVersionInfo.GetComments: string;
-begin
-  Result := FComments;
-end;
-
-function TAbstractVersionInfo.GetCompanyName: string;
-begin
-  Result := FCompanyName;
-end;
-
-function TAbstractVersionInfo.GetFileDescription: string;
-begin
-  Result := FFileDescription;
-end;
-
-function TAbstractVersionInfo.GetFileVersion: string;
-begin
-  Result := FFileVersion;
-end;
-
-function TAbstractVersionInfo.GetInternalName: string;
-begin
-  Result := FInternalName;
-end;
-
-function TAbstractVersionInfo.GetLegalCopyright: string;
-begin
-  Result := FLegalCopyright;
-end;
-
-function TAbstractVersionInfo.GetLegalTrademarks: string;
-begin
-  Result := FLegalTrademarks;
-end;
-
-function TAbstractVersionInfo.GetMajorVer: integer;
-begin
-  Result := FMajorVer;
-end;
-
-function TAbstractVersionInfo.GetMinorVer: integer;
-begin
-  Result := FMinorVer;
-end;
-
-function TAbstractVersionInfo.GetOriginalFilename: string;
-begin
-  Result := FOriginalFilename;
-end;
-
-function TAbstractVersionInfo.GetProductName: string;
-begin
-  Result := FProductName;
-end;
-
-function TAbstractVersionInfo.GetProductVersion: string;
-begin
-  Result := FProductVersion;
-end;
-
-function TAbstractVersionInfo.GetRelease: integer;
-begin
-  Result := FRelease;
-end;
-
-procedure TAbstractVersionInfo.SetAutoIncBuild(_AutoIncBuild: boolean);
-begin
-  FAutoIncBuild := _AutoIncBuild;
-end;
-
-procedure TAbstractVersionInfo.SetBuild(_Build: integer);
-begin
-  FBuild := _Build;
-end;
-
-procedure TAbstractVersionInfo.SetComments(const _Comments: string);
-begin
-  FComments := _Comments;
-end;
-
-procedure TAbstractVersionInfo.SetCompanyName(_CompanyName: string);
-begin
-  FCompanyName := _CompanyName;
-end;
-
-procedure TAbstractVersionInfo.SetFileDescription(_FileDescription: string);
-begin
-  FFileDescription := _FileDescription;
-end;
-
-procedure TAbstractVersionInfo.SetFileVersion(_FileVersion: string);
-begin
-  FFileVersion := _FileVersion;
-end;
-
-procedure TAbstractVersionInfo.SetInternalName(_InternalName: string);
-begin
-  FInternalName := _InternalName;
-end;
-
-procedure TAbstractVersionInfo.SetLegalCopyright(_LegalCopyright: string);
-begin
-  FLegalCopyright := _LegalCopyright;
-end;
-
-procedure TAbstractVersionInfo.SetLegalTrademarks(_LegalTrademarks: string);
-begin
-  FLegalTrademarks := _LegalTrademarks;
-end;
-
-procedure TAbstractVersionInfo.SetMajorVer(_MajorVer: integer);
-begin
-  FMajorVer := _MajorVer;
-end;
-
-procedure TAbstractVersionInfo.SetMinorVer(_MinorVer: integer);
-begin
-  FMinorVer := _MinorVer;
-end;
-
-procedure TAbstractVersionInfo.SetOriginalFilename(_OriginalFilename: string);
-begin
-  FOriginalFilename := _OriginalFilename;
-end;
-
-procedure TAbstractVersionInfo.SetProductName(_ProductName: string);
-begin
-  FProductName := _ProductName;
-end;
-
-procedure TAbstractVersionInfo.SetProductVersion(_ProductVersion: string);
-begin
-  FProductVersion := _ProductVersion;
-end;
-
-procedure TAbstractVersionInfo.SetRelease(_Release: integer);
-begin
-  FRelease := _Release;
-end;
-
-procedure TAbstractVersionInfo.UpdateFileVersion;
-begin
-  FileVersion := Format('%d.%d.%d.%d', [MajorVer, MinorVer, Release, Build]);
-end;
-
-end.
-

Modified: utilities/dzPrepBuild/trunk/src/u_CentralIniVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_CentralIniVersionInfo.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/u_CentralIniVersionInfo.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -3,7 +3,7 @@
 interface
 
 uses
-  i_VersionInfo,
+  i_VersionInfoAccess,
   u_IniVersionInfo;
 
 type
@@ -18,14 +18,14 @@
      used to maintain/increment a central build number for several branches of
      a project where the files have different version numbers but the build
      number should be increased for a build of any of these versions. }
-  TCentralVersionInfo = class(TIniVersionInfo, IVersionInfo)
+  TCentralVersionInfo = class(TIniVersionInfo, IVersionInfoAccess)
   private
     FProjectName: string;
     procedure GetRedirIdentInfo(const _RedirString: string; out _Filename, _Section, _Ident: string);
     procedure GetRedirSectionInfo(_Redir: string; out _Filename, _Section: string);
     procedure AdjustFilename(var _Filename: string);
   protected
-    function VerInfoFilename: string; override;
+    function VerInfoFilename: string;
     //
     function ReadString(const _Section, _Ident: string; _Default: string): string; override;
     procedure WriteString(const _Section, _Ident: string; _Value: string); override;

Modified: utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -5,17 +5,18 @@
 uses
   SysUtils,
   IniFiles,
-  i_VersionInfo,
+  i_VersionInfoAccess,
+  u_VersionInfo,
   u_IniVersionInfo;
 
 type
   {: This is a specialized version of TIniVersionInfo which reads a
      <projectname>.dof file, that was used by Delphi up to version 7. }
-  TDofVersionInfo = class(TIniVersionInfo, IVersionInfo)
+  TDofVersionInfo = class(TIniVersionInfo, IVersionInfoAccess)
   private
     FProjectName: string;
   protected
-    function VerInfoFilename: string; override;
+    function VerInfoFilename: string;
   public
     {: Creates a TDofVersionInfo instance. Succeeds, if the file exists
        and IncludeVerInfo is <> 0

Modified: utilities/dzPrepBuild/trunk/src/u_DummyVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_DummyVersionInfo.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/u_DummyVersionInfo.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -3,29 +3,18 @@
 interface
 
 uses
-  i_VersionInfo,
-  u_AbstractVersionInfo;
+  i_VersionInfoAccess,
+  u_VersionInfo;
 
-type
-  TDummyVersionInfo = class(TAbstractVersionInfo, IVersionInfo)
-  protected
-    procedure UpdateFile; override;
-    function VerInfoFilename: string; override;
-  end;
+//type
+//  TDummyVersionInfo = class(TInterfacedObject, IVersionInfoAccess)
+//  protected
+//  end;
 
 implementation
 
 { TDummyVersionInfo }
 
-procedure TDummyVersionInfo.UpdateFile;
-begin
-  // ignore
-end;
 
-function TDummyVersionInfo.VerInfoFilename: string;
-begin
-  Result := '';
-end;
-
 end.
 

Modified: utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -5,14 +5,13 @@
 uses
   SysUtils,
   IniFiles,
-  i_VersionInfo,
-  u_AbstractVersionInfo;
+  u_VersionInfo;
 
 type
   {: Tries to read a <projectname>.ini file, succeeds, if it exists
      @param Project is the project name (*.dpr file without extension)
      @param VersionInfo is a TVersionInfoRec record which will be filled with the version info }
-  TIniVersionInfo = class(TAbstractVersionInfo)
+  TIniVersionInfo = class(TInterfacedObject)
   protected
     FIniFile: TMemIniFile;
     FInfoSection: string;
@@ -23,11 +22,10 @@
     procedure WriteString(const _Section, _Ident: string; _Value: string); virtual;
     function ReadBool(const _Section, _Ident: string; _Default: boolean): boolean; virtual;
     procedure WriteBool(const _Section, _Ident: string; _Value: boolean); virtual;
-    procedure ReadValues;
-    procedure WriteValues;
   private
   protected // implementation of IVersionInfo
-    procedure UpdateFile; override;
+    procedure ReadFromFile(_VerInfo: TVersionInfo);
+    procedure WriteToFile(_VerInfo: TVersionInfo);
   public
     {: Creates a TIniVersionInfo instance.
        @param FullFilename is the full filename including path and extension of
@@ -46,7 +44,8 @@
 implementation
 
 uses
-  u_dzTranslator;
+  u_dzTranslator,
+  i_VersionInfoAccess;
 
 { TIniVersionInfo }
 
@@ -59,7 +58,6 @@
   FInfoSection := _InfoSection;
   FInfoKeysSection := _InfoKeysSection;
   FIniFile := TMemIniFile.Create(_FullFilename);
-  ReadValues;
 end;
 
 destructor TIniVersionInfo.Destroy;
@@ -102,48 +100,44 @@
   FIniFile.WriteString(_Section, _Ident, _Value);
 end;
 
-procedure TIniVersionInfo.ReadValues;
+procedure TIniVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
 begin
-  AutoIncBuild := ReadBool(FInfoSection, 'AutoIncBuild', False);
-  Build := ReadInteger(FInfoSection, 'Build', 0);
-  MajorVer := ReadInteger(FInfoSection, 'MajorVer', 0);
-  MinorVer := ReadInteger(FInfoSection, 'MinorVer', 0);
-  Release := ReadInteger(FInfoSection, 'Release', 0);
+  _VerInfo.AutoIncBuild := ReadBool(FInfoSection, 'AutoIncBuild', False);
 
-  Comments := ReadString(FInfoKeysSection, 'Comments', '');
-  CompanyName := ReadString(FInfoKeysSection, 'CompanyName', '');
-  FileDescription := ReadString(FInfoKeysSection, 'FileDescription', '');
-  FileVersion := ReadString(FInfoKeysSection, 'FileVersion', '');
-  InternalName := ReadString(FInfoKeysSection, 'InternalName', '');
-  LegalCopyright := ReadString(FInfoKeysSection, 'LegalCopyright', '');
-  LegalTrademarks := ReadString(FInfoKeysSection, 'LegalTrademarks', '');
-  OriginalFilename := ReadString(FInfoKeysSection, 'OriginalFilename', '');
-  ProductName := ReadString(FInfoKeysSection, 'ProductName', '');
-  ProductVersion := ReadString(FInfoKeysSection, 'ProductVersion', '');
-end;
+  _VerInfo.Build := ReadInteger(FInfoSection, 'Build', 0);
+  _VerInfo.MajorVer := ReadInteger(FInfoSection, 'MajorVer', 0);
+  _VerInfo.MinorVer := ReadInteger(FInfoSection, 'MinorVer', 0);
+  _VerInfo.Release := ReadInteger(FInfoSection, 'Release', 0);
 
-procedure TIniVersionInfo.WriteValues;
-begin
-  WriteBool(FInfoSection, 'AutoIncBuild', AutoIncBuild);
-  WriteInteger(FInfoSection, 'Build', Build);
-  WriteString(FInfoKeysSection, 'Comments', Comments);
-  WriteString(FInfoKeysSection, 'CompanyName', CompanyName);
-  WriteString(FInfoKeysSection, 'FileDescription', FileDescription);
-  WriteString(FInfoKeysSection, 'FileVersion', FileVersion);
-  WriteString(FInfoKeysSection, 'InternalName', InternalName);
-  WriteString(FInfoKeysSection, 'LegalCopyright', LegalCopyright);
-  WriteString(FInfoKeysSection, 'LegalTrademarks', LegalTrademarks);
-  WriteInteger(FInfoSection, 'MajorVer', MajorVer);
-  WriteInteger(FInfoSection, 'MinorVer', MinorVer);
-  WriteString(FInfoKeysSection, 'OriginalFilename', OriginalFilename);
-  WriteString(FInfoKeysSection, 'ProductName', ProductName);
-  WriteString(FInfoKeysSection, 'ProductVersion', ProductVersion);
-  WriteInteger(FInfoSection, 'Release', Release);
+  _VerInfo.Comments := ReadString(FInfoKeysSection, 'Comments', '');
+  _VerInfo.CompanyName := ReadString(FInfoKeysSection, 'CompanyName', '');
+  _VerInfo.FileDescription := ReadString(FInfoKeysSection, 'FileDescription', '');
+  _VerInfo.FileVersion := ReadString(FInfoKeysSection, 'FileVersion', '');
+  _VerInfo.InternalName := ReadString(FInfoKeysSection, 'InternalName', '');
+  _VerInfo.LegalCopyright := ReadString(FInfoKeysSection, 'LegalCopyright', '');
+  _VerInfo.LegalTrademarks := ReadString(FInfoKeysSection, 'LegalTrademarks', '');
+  _VerInfo.OriginalFilename := ReadString(FInfoKeysSection, 'OriginalFilename', '');
+  _VerInfo.ProductName := ReadString(FInfoKeysSection, 'ProductName', '');
+  _VerInfo.ProductVersion := ReadString(FInfoKeysSection, 'ProductVersion', '');
 end;
 
-procedure TIniVersionInfo.UpdateFile;
+procedure TIniVersionInfo.WriteToFile(_VerInfo: TVersionInfo);
 begin
-  WriteValues;
+  WriteBool(FInfoSection, 'AutoIncBuild', _VerInfo.AutoIncBuild);
+  WriteInteger(FInfoSection, 'Build', _VerInfo.Build);
+  WriteString(FInfoKeysSection, 'Comments', _VerInfo.Comments);
+  WriteString(FInfoKeysSection, 'CompanyName', _VerInfo.CompanyName);
+  WriteString(FInfoKeysSection, 'FileDescription', _VerInfo.FileDescription);
+  WriteString(FInfoKeysSection, 'FileVersion', _VerInfo.FileVersion);
+  WriteString(FInfoKeysSection, 'InternalName', _VerInfo.InternalName);
+  WriteString(FInfoKeysSection, 'LegalCopyright', _VerInfo.LegalCopyright);
+  WriteString(FInfoKeysSection, 'LegalTrademarks', _VerInfo.LegalTrademarks);
+  WriteInteger(FInfoSection, 'MajorVer', _VerInfo.MajorVer);
+  WriteInteger(FInfoSection, 'MinorVer', _VerInfo.MinorVer);
+  WriteString(FInfoKeysSection, 'OriginalFilename', _VerInfo.OriginalFilename);
+  WriteString(FInfoKeysSection, 'ProductName', _VerInfo.ProductName);
+  WriteString(FInfoKeysSection, 'ProductVersion', _VerInfo.ProductVersion);
+  WriteInteger(FInfoSection, 'Release', _VerInfo.Release);
   FIniFile.UpdateFile;
 end;
 

Modified: utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 13:55:37 UTC (rev 431)
+++ utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -8,13 +8,14 @@
   StrUtils,
   u_dzDefaultMain,
   u_dzGetOpt,
-  i_VersionInfo;
+  u_VersionInfo,
+  i_VersionInfoAccess;
 
 type
   TPrepBuildMain = class(TDefaultMain)
   private
-    function HandleExecOption(const _Command: string; _VersionInfo: IVersionInfo; const _Project: string): integer;
-    procedure WriteRcFile(const _Project: string; _VersionInfo: IVersionInfo; const _Icon: string);
+    function HandleExecOption(const _Command: string; _VersionInfo: TVersionInfo; const _Project: string): integer;
+    procedure WriteRcFile(const _Project: string; _VersionInfo: TVersionInfo; const _Icon: string);
     procedure DumpCmd;
   protected
     procedure InitCmdLineParser; override;
@@ -28,6 +29,7 @@
 uses
   u_dzTranslator,
   u_dzExecutor,
+  u_dzJclUtils,
   u_dzShellApiUtils,
   u_DofVersionInfo,
   d_BdsProjVersionInfo,
@@ -42,7 +44,7 @@
   SysUtils.DateTimeToString(Result, _Format, _dt);
 end;
 
-procedure TPrepBuildMain.WriteRcFile(const _Project: string; _VersionInfo: IVersionInfo; const _Icon: string);
+procedure TPrepBuildMain.WriteRcFile(const _Project: string; _VersionInfo: TVersionInfo; const _Icon: string);
 var
   t: TextFile;
 begin
@@ -89,7 +91,7 @@
   end;
 end;
 
-function TPrepBuildMain.HandleExecOption(const _Command: string; _VersionInfo: IVersionInfo; const _Project: string): integer;
+function TPrepBuildMain.HandleExecOption(const _Command: string; _VersionInfo: TVersionInfo; const _Project: string): integer;
 const
   DZ_MY_DOCUMENTS = 'dzMyDocuments';
   DZ_DATE = 'dzDate';
@@ -162,21 +164,24 @@
   p: PChar;
 begin
   s := StrNew(PChar(_s));
-  p := s;
-  Result := AnsiExtractQuotedStr(p, '"');
-  StrDispose(s);
+  try
+    p := s;
+    Result := AnsiExtractQuotedStr(p, '"');
+  finally
+    StrDispose(s);
+  end;
 end;
 
 function TPrepBuildMain.doExecute: integer;
 var
   Param: string;
-  ParamVersionInfo: IVersionInfo;
-  VersionInfo: IVersionInfo;
+  VerInfoAccess: IVersionInfoAccess;
+  VersionInfo: TVersionInfo;
   IntValue: integer;
   IconFile: string;
   Project: string;
 begin
-  WriteLn('dzPrepBuild');
+  WriteLn('dzPrepBuild version ' + TApplication_GetFileVersion + ' built ' + TApplication_GetProductVersion);
 
   if FGetOpt.OptionsFoundList.Count = 0 then
     Usage(_('You must supply some options.'));
@@ -186,109 +191,110 @@
 
   Project := '';
   if FGetOpt.OptionPassed('ReadDof', Project) then
-    ParamVersionInfo := TDofVersionInfo.Create(Project);
+    VerInfoAccess := TDofVersionInfo.Create(Project);
 
   if FGetOpt.OptionPassed('ReadBdsProj', Project) then begin
-    if Assigned(ParamVersionInfo) then
+    if Assigned(VerInfoAccess) then
       raise Exception.Create(_('You can only pass one of --ReadDof, --ReadBdsproj or --ReadIni'));
-    ParamVersionInfo := Tdm_BdsProjVersionInfo.Create(Project);
+    VerInfoAccess := Tdm_BdsProjVersionInfo.Create(Project);
   end;
 
   if FGetOpt.OptionPassed('ReadIni', Project) then begin
-    if Assigned(ParamVersionInfo) then
+    if Assigned(VerInfoAccess) then
       raise Exception.Create(_('You can only pass one of --ReadDof, --ReadBdsproj or --ReadIni'));
-    ParamVersionInfo := TCentralVersionInfo.Create(Project);
+    VerInfoAccess := TCentralVersionInfo.Create(Project);
   end;
 
-  VersionInfo := TDummyVersionInfo.Create;
-  if Assigned(ParamVersionInfo) then begin
-    VersionInfo.Assign(ParamVersionInfo);
-    ParamVersionInfo := nil;
-  end;
+  VersionInfo := TVersionInfo.Create;
+  try
+    if Assigned(VerInfoAccess) then begin
+      VerInfoAccess.ReadFromFile(VersionInfo);
+      VerInfoAccess := nil;
+    end;
 
-  if FGetOpt.OptionPassed('MajorVer', Param) then begin
-    if not TryStrToInt(Param, IntValue) then
-      raise Exception.Create(_('Parameter to MajorVer must be a number'));
-    VersionInfo.MajorVer := IntValue;
-  end;
+    if FGetOpt.OptionPassed('MajorVer', Param) then begin
+      if not TryStrToInt(Param, IntValue) then
+        raise Exception.Create(_('Parameter to MajorVer must be a number'));
+      VersionInfo.MajorVer := IntValue;
+    end;
 
-  if FGetOpt.OptionPassed('MinorVer', Param) then begin
-    if not TryStrToInt(Param, IntValue) then
-      raise Exception.Create(_('Parameter to MinorVer must be a number'));
-    VersionInfo.MinorVer := IntValue;
-  end;
+    if FGetOpt.OptionPassed('MinorVer', Param) then begin
+      if not TryStrToInt(Param, IntValue) then
+        raise Exception.Create(_('Parameter to MinorVer must be a number'));
+      VersionInfo.MinorVer := IntValue;
+    end;
 
-  if FGetOpt.OptionPassed('Release', Param) then begin
-    if not TryStrToInt(Param, IntValue) then
-      raise Exception.Create(_('Parameter to Release must be a number'));
-    VersionInfo.Release := IntValue;
-  end;
+    if FGetOpt.OptionPassed('Release', Param) then begin
+      if not TryStrToInt(Param, IntValue) then
+        raise Exception.Create(_('Parameter to Release must be a number'));
+      VersionInfo.Release := IntValue;
+    end;
 
-  if FGetOpt.OptionPassed('Build', Param) then begin
-    if not TryStrToInt(Param, IntValue) then
-      raise Exception.Create(_('Parameter to Build must be a number'));
-    VersionInfo.Build := IntValue;
-  end;
+    if FGetOpt.OptionPassed('Build', Param) then begin
+      if not TryStrToInt(Param, IntValue) then
+        raise Exception.Create(_('Parameter to Build must be a number'));
+      VersionInfo.Build := IntValue;
+    end;
 
-  if FGetOpt.OptionPassed('FileDesc', Param) then
-    VersionInfo.FileDescription := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('FileDesc', Param) then
+      VersionInfo.FileDescription := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('InternalName', Param) then
-    VersionInfo.InternalName := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('InternalName', Param) then
+      VersionInfo.InternalName := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('OriginalName', Param) then
-    VersionInfo.OriginalFilename := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('OriginalName', Param) then
+      VersionInfo.OriginalFilename := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('Product', Param) then
-    VersionInfo.ProductName := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('Product', Param) then
+      VersionInfo.ProductName := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('ProductVersion', Param) then
-    VersionInfo.ProductVersion := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('ProductVersion', Param) then
+      VersionInfo.ProductVersion := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('Company', Param) then
-    VersionInfo.CompanyName := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('Company', Param) then
+      VersionInfo.CompanyName := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('Copyright', Param) then
-    VersionInfo.LegalCopyright := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('Copyright', Param) then
+      VersionInfo.LegalCopyright := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('Trademark', Param) then
-    VersionInfo.LegalTrademarks := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('Trademark', Param) then
+      VersionInfo.LegalTrademarks := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('Comments', Param) then
-    VersionInfo.Comments := UnquoteStr(Param);
+    if FGetOpt.OptionPassed('Comments', Param) then
+      VersionInfo.Comments := UnquoteStr(Param);
 
-  if FGetOpt.OptionPassed('IncBuild') then
-    VersionInfo.Build := VersionInfo.Build + 1;
+    if FGetOpt.OptionPassed('IncBuild') then
+      VersionInfo.Build := VersionInfo.Build + 1;
 
-  VersionInfo.UpdateFileVersion;
+    VersionInfo.UpdateFileVersion;
 
-  if FGetOpt.OptionPassed('UpdateDof', Param) then begin
-    ParamVersionInfo := TDofVersionInfo.Create(Param);
-    ParamVersionInfo.Assign(VersionInfo);
-    ParamVersionInfo.UpdateFile;
-  end;
+    if FGetOpt.OptionPassed('UpdateDof', Param) then
+      VerInfoAccess := TDofVersionInfo.Create(Param);
 
-  if FGetOpt.OptionPassed('UpdateBdsproj', Param) then begin
-    ParamVersionInfo := Tdm_BdsProjVersionInfo.Create(Param);
-    ParamVersionInfo.Assign(VersionInfo);
-    ParamVersionInfo.UpdateFile;
-  end;
+    if FGetOpt.OptionPassed('UpdateBdsproj', Param) then
+      VerInfoAccess := Tdm_BdsProjVersionInfo.Create(Param);
 
-  if FGetOpt.OptionPassed('UpdateIni', Param) then begin
-    ParamVersionInfo := TCentralVersionInfo.Create(Param);
-    ParamVersionInfo.Assign(VersionInfo);
-    ParamVersionInfo.UpdateFile;
-  end;
+    if FGetOpt.OptionPassed('UpdateIni', Param) then
+      VerInfoAccess := TCentralVersionInfo.Create(Param);
 
-  if not FGetOpt.OptionPassed('Icon', IconFile) then
-    IconFile := '';
+    if Assigned(VerInfoAccess) then begin
+      VerInfoAccess.WriteToFile(VersionInfo);
+      VerInfoAccess := nil;
+    end;
 
-  if FGetOpt.OptionPassed('WriteRc', Param) then
-    WriteRcFile(Param, VersionInfo, IconFile);
+    if not FGetOpt.OptionPassed('Icon', IconFile) then
+      IconFile := '';
 
-  if FGetOpt.OptionPassed('Exec', Param) then
-    HandleExecOption(Param, VersionInfo, Project);
+    if FGetOpt.OptionPassed('WriteRc', Param) then
+      WriteRcFile(Param, VersionInfo, IconFile);
 
+    if FGetOpt.OptionPassed('Exec', Param) then
+      HandleExecOption(Param, VersionInfo, Project);
+
+  finally
+    FreeAndNil(VersionInfo);
+  end;
+
   Result := 0;
 end;
 

Copied: utilities/dzPrepBuild/trunk/src/u_VersionInfo.pas (from rev 430, utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas)
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_AbstractVersionInfo.pas	2010-04-11 12:56:34 UTC (rev 430)
+++ utilities/dzPrepBuild/trunk/src/u_VersionInfo.pas	2010-04-11 13:59:09 UTC (rev 432)
@@ -0,0 +1,265 @@
+unit u_VersionInfo;
+
+interface
+
+uses
+  SysUtils;
+
+type
+  TVersionInfo = class
+  private
+    FMajorVer: integer;
+    FMinorVer: integer;
+    FRelease: integer;
+    FBuild: integer;
+
+    FFileVersion: string;
+    FProductVersion: string;
+    FProductName: string;
+    FLegalTrademarks: string;
+    FLegalCopyright: string;
+    FCompanyName: string;
+    FAutoIncBuild: boolean;
+    FFileDescription: string;
+    FInternalName: string;
+    FOriginalFilename: string;
+    FComments: string;
+  protected
+    function GetAutoIncBuild: boolean;
+    procedure SetAutoIncBuild(_AutoIncBuild: Boolean); virtual;
+    //
+    procedure Assign(_VersionInfo: TVersionInfo); virtual;
+    //
+    function GetMajorVer: Integer; virtual;
+    function GetMinorVer: Integer; virtual;
+    function GetRelease: Integer; virtual;
+    function GetBuild: Integer; virtual;
+    procedure SetMajorVer(_MajorVer: Integer); virtual;
+    procedure SetMinorVer(_MinorVer: Integer); virtual;
+    procedure SetRelease(_Release: Integer); virtual;
+    procedure SetBuild(_Build: Integer); virtual;
+    //
+    function GetComments: string; virtual;
+    function GetCompanyName: string; virtual;
+    function GetFileDescription: string; virtual;
+    function GetFileVersion: string; virtual;
+    function GetInternalName: string; virtual;
+    function GetLegalCopyright: string; virtual;
+    function GetLegalTrademarks: string; virtual;
+    function GetOriginalFilename: string;
+    function GetProductName: string; virtual;
+    function GetProductVersion: string; virtual;
+    procedure SetComments(const _Comments: string); virtual;
+    procedure SetCompanyName(_CompanyName: string); virtual;
+    procedure SetFileDescription(_FileDescription: string); virtual;
+    procedure SetFileVersion(_FileVersion: string); virtual;
+    procedure SetInternalName(_InternalName: string); virtual;
+    procedure SetLegalCopyright(_LegalCopyright: string); virtual;
+    procedure SetLegalTrademarks(_LegalTrademarks: string); virtual;
+    procedure SetOriginalFilename(_OriginalFilename: string); virtual;
+    procedure SetProductName(_ProductName: string); virtual;
+    procedure SetProductVersion(_ProductVersion: string); virtual;
+  public
+    procedure UpdateFileVersion;
+    //
+    property AutoIncBuild: boolean read GetAutoIncBuild write SetAutoIncBuild;
+    //
+    property MajorVer: integer read GetMajorVer write SetMajorVer;
+    property MinorVer: integer read GetMinorVer write SetMinorVer;
+    property Release: integer read GetRelease write SetRelease;
+    property Build: integer read GetBuild write SetBuild;
+    //
+    property Comments: string read GetComments write SetComments;
+    property CompanyName: string read GetCompanyName write SetCompanyName;
+    property FileDescription: string read GetFileDescription write SetFileDescription;
+    property FileVersion: string read GetFileVersion write SetFileVersion;
+    property InternalName: string read GetInternalName write SetInternalName;
+    property LegalCopyright: string read GetLegalCopyright write SetLegalCopyright;
+    property LegalTrademarks: string read GetLegalTrademarks write SetLegalTrademarks;
+    property OriginalFilename: string read GetOriginalFilename write SetOriginalFilename;
+    property ProductName: string read GetProductName write SetProductName;
+    property ProductVersion: string read GetProductVersion write SetProductVersion;
+  end;
+
+implementation
+
+{ TVersionInfo }
+
+procedure TVersionInfo.Assign(_VersionInfo: TVersionInfo);
+begin
+  AutoIncBuild := _VersionInfo.AutoIncBuild;
+
+  MajorVer := _VersionInfo.MajorVer;
+  MinorVer := _VersionInfo.MinorVer;
+  Release := _VersionInfo.Release;
+  Build := _VersionInfo.Build;
+
+  Comments := _VersionInfo.Comments;
+  CompanyName := _VersionInfo.CompanyName;
+  FileDescription := _VersionInfo.FileDescription;
+  FileVersion := _VersionInfo.FileVersion;
+  InternalName := _VersionInfo.InternalName;
+  LegalCopyright := _VersionInfo.LegalCopyright;
+  LegalTrademarks := _VersionInfo.LegalTrademarks;
+  OriginalFilename := _VersionInfo.OriginalFilename;
+  ProductName := _VersionInfo.ProductName;
+  ProductVersion := _VersionInfo.ProductVersion;
+end;
+
+function TVersionInfo.GetAutoIncBuild: boolean;
+begin
+  Result := FAutoIncBuild;
+end;
+
+function TVersionInfo.GetBuild: integer;
+begin
+  Result := FBuild;
+end;
+
+function TVersionInfo.GetComments: string;
+begin
+  Result := FComments;
+end;
+
+function TVersionInfo.GetCompanyName: string;
+begin
+  Result := FCompanyName;
+end;
+
+function TVersionInfo.GetFileDescription: string;
+begin
+  Result := FFileDescription;
+end;
+
+function TVersionInfo.GetFileVersion: string;
+begin
+  Result := FFileVersion;
+end;
+
+function TVersionInfo.GetInternalName: string;
+begin
+  Result := FInternalName;
+end;
+
+function TVersionInfo.GetLegalCopyright: string;
+begin
+  Result := FLegalCopyright;
+end;
+
+function TVersionInfo.GetLegalTrademarks: string;
+begin
+  Result := FLegalTrademarks;
+end;
+
+function TVersionInfo.GetMajorVer: integer;
+begin
+  Result := FMajorVer;
+end;
+
+function TVersionInfo.GetMinorVer: integer;
+begin
+  Result := FMinorVer;
+end;
+
+function TVersionInfo.GetOriginalFilename: string;
+begin
+  Result := FOriginalFilename;
+end;
+
+function TVersionInfo.GetProductName: string;
+begin
+  Result := FProductName;
+end;
+
+function TVersionInfo.GetProductVersion: string;
+begin
+  Result := FProductVersion;
+end;
+
+function TVersionInfo.GetRelease: integer;
+begin
+  Result := FRelease;
+end;
+
+procedure TVersionInfo.SetAutoIncBuild(_AutoIncBuild: boolean);
+begin
+  FAutoIncBuild := _AutoIncBuild;
+end;
+
+procedure TVersionInfo.SetBuild(_Build: integer);
+begin
+  FBuild := _Build;
+end;
+
+procedure TVersionInfo.SetComments(const _Comments: string);
+begin
+  FComments := _Comments;
+end;
+
+procedure TVersionInfo.SetCompanyName(_CompanyName: string);
+begin
+  FCompanyName := _CompanyName;
+end;
+
+procedure TVersionInfo.SetFileDescription(_FileDescription: string);
+begin
+  FFileDescription := _FileDescription;
+end;
+
+procedure TVersionInfo.SetFileVersion(_FileVersion: string);
+begin
+  FFileVersion := _FileVersion;
+end;
+
+procedure TVersionInfo.SetInternalName(_InternalName: string);
+begin
+  FInternalName := _InternalName;
+end;
+
+procedure TVersionInfo.SetLegalCopyright(_LegalCopyright: string);
+begin
+  FLegalCopyright := _LegalCopyright;
+end;
+
+procedure TVersionInfo.SetLegalTrademarks(_LegalTrademarks: string);
+begin
+  FLegalTrademarks := _LegalTrademarks;
+end;
+
+procedure TVersionInfo.SetMajorVer(_MajorVer: integer);
+begin
+  FMajorVer := _MajorVer;
+end;
+
+procedure TVersionInfo.SetMinorVer(_MinorVer: integer);
+begin
+  FMinorVer := _MinorVer;
+end;
+
+procedure TVersionInfo.SetOriginalFilename(_OriginalFilename: string);
+begin
+  FOriginalFilename := _OriginalFilename;
+end;
+
+procedure TVersionInfo.SetProductName(_ProductName: string);
+begin
+  FProductName := _ProductName;
+end;
+
+procedure TVersionInfo.SetProductVersion(_ProductVersion: string);
+begin
+  FProductVersion := _ProductVersion;
+end;
+
+procedure TVersionInfo.SetRelease(_Release: integer);
+begin
+  FRelease := _Release;
+end;
+
+procedure TVersionInfo.UpdateFileVersion;
+begin
+  FileVersion := Format('%d.%d.%d.%d', [MajorVer, MinorVer, Release, Build]);
+end;
+
+end.
+



From twm at mail.berlios.de  Sun Apr 11 16:13:16 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 16:13:16 +0200
Subject: [Dzchart-svncheckins] r433 - utilities/dzPrepBuild/trunk/testdata
Message-ID: <201004111413.o3BEDGo7020725@sheep.berlios.de>

Author: twm
Date: 2010-04-11 16:13:11 +0200 (Sun, 11 Apr 2010)
New Revision: 433

Added:
   utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.dproj
   utilities/dzPrepBuild/trunk/testdata/OriginalTestproject_Version.ini
   utilities/dzPrepBuild/trunk/testdata/RestoreTestproject.cmd
   utilities/dzPrepBuild/trunk/testdata/TestProject.dpr
   utilities/dzPrepBuild/trunk/testdata/Testproject.dproj
Removed:
   utilities/dzPrepBuild/trunk/testdata/copyback.cmd
Modified:
   utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.bdsproj
   utilities/dzPrepBuild/trunk/testdata/Testproject.bdsproj
Log:
testdata extended to Delphi2010 (.dproj)

Modified: utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.bdsproj
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.bdsproj	2010-04-11 13:59:09 UTC (rev 432)
+++ utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.bdsproj	2010-04-11 14:13:11 UTC (rev 433)
@@ -10,7 +10,7 @@
 	</PersonalityInfo>
 	<Delphi.Personality>
 		<Source>
-			<Source Name="MainSource">IncBuildNo.dpr</Source>
+			<Source Name="MainSource">Testproject.dpr</Source>
 		</Source>
 		<FileVersion>
 			<FileVersion Name="Version">7.0</FileVersion>

Added: utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.dproj	2010-04-11 13:59:09 UTC (rev 432)
+++ utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.dproj	2010-04-11 14:13:11 UTC (rev 433)
@@ -0,0 +1,105 @@
+?	<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
+		<PropertyGroup>
+			<ProjectGuid>{209412AC-0EC2-4F63-B92A-E78853FF142A}</ProjectGuid>
+			<MainSource>TestProject.dpr</MainSource>
+			<Config Condition="'$(Config)'==''">Debug</Config>
+			<DCC_DCCCompiler>DCC32</DCC_DCCCompiler>
+			<ProjectVersion>12.0</ProjectVersion>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Config)'=='Base' or '$(Base)'!=''">
+			<Base>true</Base>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Config)'=='Release' or '$(Cfg_1)'!=''">
+			<Cfg_1>true</Cfg_1>
+			<CfgParent>Base</CfgParent>
+			<Base>true</Base>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Config)'=='Debug' or '$(Cfg_2)'!=''">
+			<Cfg_2>true</Cfg_2>
+			<CfgParent>Base</CfgParent>
+			<Base>true</Base>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Base)'!=''">
+			<DCC_ImageBase>00400000</DCC_ImageBase>
+			<DCC_UsePackage>rtl;vcl;vcldb;dbrtl;vclx;dbxcds;dbexpress;IndySystem;IndyCore;VclSmp;IndyProtocols;dsnap;adortl;vclactnband;vclshlctrls;JvCustomD9R;JvSystemD9R;JvCoreD9R;DJcl;JvStdCtrlsD9R;dzConfigd9;PerlRegExD2005;SynEdit_R2005;SynUni_D2005;JvAppFrmD9R;JvBandsD9R;JvBDED9R;JvCmpD9R;JvCryptD9R;JvCtrlsD9R;JvDlgsD9R;JvDockingD9R;JvDotNetCtrlsD9R;JvEDID9R;JvGlobusD9R;JvHMID9R;JvInspectorD9R;JvInterpreterD9R;JvJansD9R;JvManagedThreadsD9R;JvMMD9R;JvNetD9R;JvPageCompsD9R;JvPluginD9R;JvPrintPreviewD9R;JvTimeFrameworkD9R;JvUIBD9R;JvValidatorsD9R;JvWizardD9R;JvXPCtrlsD9R</DCC_UsePackage>
+			<DCC_DebugInformation>false</DCC_DebugInformation>
+			<DCC_UnitAlias>WinTypes=Windows;WinProcs=Windows;DbiTypes=BDE;DbiProcs=BDE;DbiErrs=BDE;$(DCC_UnitAlias)</DCC_UnitAlias>
+			<DCC_Platform>x86</DCC_Platform>
+			<DCC_DependencyCheckOutputName>TestProject.exe</DCC_DependencyCheckOutputName>
+			<DCC_K>false</DCC_K>
+			<DCC_N>true</DCC_N>
+			<DCC_S>false</DCC_S>
+			<DCC_SymbolReferenceInfo>1</DCC_SymbolReferenceInfo>
+			<DCC_E>false</DCC_E>
+			<DCC_F>false</DCC_F>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Cfg_1)'!=''">
+			<DCC_Define>RELEASE;$(DCC_Define)</DCC_Define>
+			<DCC_LocalDebugSymbols>false</DCC_LocalDebugSymbols>
+			<DCC_SymbolReferenceInfo>0</DCC_SymbolReferenceInfo>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Cfg_2)'!=''">
+			<DCC_Define>DEBUG;$(DCC_Define)</DCC_Define>
+		</PropertyGroup>
+		<ItemGroup>
+			<DelphiCompile Include="TestProject.dpr">
+				<MainSource>MainSource</MainSource>
+			</DelphiCompile>
+			<BuildConfiguration Include="Base">
+				<Key>Base</Key>
+			</BuildConfiguration>
+			<BuildConfiguration Include="Debug">
+				<Key>Cfg_2</Key>
+				<CfgParent>Base</CfgParent>
+			</BuildConfiguration>
+			<BuildConfiguration Include="Release">
+				<Key>Cfg_1</Key>
+				<CfgParent>Base</CfgParent>
+			</BuildConfiguration>
+		</ItemGroup>
+		<Import Project="$(BDS)\Bin\CodeGear.Delphi.Targets" Condition="Exists('$(BDS)\Bin\CodeGear.Delphi.Targets')"/>
+		<ProjectExtensions>
+			<Borland.Personality>Delphi.Personality.12</Borland.Personality>
+			<Borland.ProjectType/>
+			<BorlandProject>
+				<Delphi.Personality>
+					<Source>
+						<Source Name="MainSource">TestProject.dpr</Source>
+					</Source>
+					<Parameters>
+						<Parameters Name="UseLauncher">False</Parameters>
+						<Parameters Name="LoadAllSymbols">True</Parameters>
+						<Parameters Name="LoadUnspecifiedSymbols">False</Parameters>
+					</Parameters>
+					<VersionInfo>
+						<VersionInfo Name="IncludeVerInfo">True</VersionInfo>
+						<VersionInfo Name="AutoIncBuild">False</VersionInfo>
+						<VersionInfo Name="MajorVer">1</VersionInfo>
+						<VersionInfo Name="MinorVer">31</VersionInfo>
+						<VersionInfo Name="Release">0</VersionInfo>
+						<VersionInfo Name="Build">0</VersionInfo>
+						<VersionInfo Name="Debug">False</VersionInfo>
+						<VersionInfo Name="PreRelease">False</VersionInfo>
+						<VersionInfo Name="Special">False</VersionInfo>
+						<VersionInfo Name="Private">False</VersionInfo>
+						<VersionInfo Name="DLL">False</VersionInfo>
+						<VersionInfo Name="Locale">1033</VersionInfo>
+						<VersionInfo Name="CodePage">1252</VersionInfo>
+					</VersionInfo>
+					<VersionInfoKeys>
+						<VersionInfoKeys Name="FileVersion"/>
+						<VersionInfoKeys Name="ProductVersion">&quot;2007-07-14&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="CompanyName">&quot;www.dummzeuch.de&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="FileDescription">&quot;Testproject&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="InternalName">&quot;testproject&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="LegalCopyright">&quot;Copyright 2002-2007 by Thomas Mueller&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="LegalTrademarks">&quot;&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="OriginalFilename">&quot;testproject.exe&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="ProductName">&quot;Testproduct&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="Comments">&quot;internal use only&quot;</VersionInfoKeys>
+					</VersionInfoKeys>
+				</Delphi.Personality>
+			</BorlandProject>
+			<ProjectFileVersion>12</ProjectFileVersion>
+		</ProjectExtensions>
+	</Project>

Copied: utilities/dzPrepBuild/trunk/testdata/OriginalTestproject_Version.ini (from rev 429, utilities/dzPrepBuild/trunk/testdata/Testproject_Version.ini)

Copied: utilities/dzPrepBuild/trunk/testdata/RestoreTestproject.cmd (from rev 429, utilities/dzPrepBuild/trunk/testdata/copyback.cmd)
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/copyback.cmd	2010-04-11 12:02:50 UTC (rev 429)
+++ utilities/dzPrepBuild/trunk/testdata/RestoreTestproject.cmd	2010-04-11 14:13:11 UTC (rev 433)
@@ -0,0 +1,4 @@
+copy OriginalTestproject.dof Testproject.dof
+copy OriginalTestproject.bdsproj Testproject.bdsproj
+copy OriginalTestproject.dproj Testproject.dproj
+copy OriginalTestproject_Version.ini Testproject_version.ini

Added: utilities/dzPrepBuild/trunk/testdata/TestProject.dpr
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/TestProject.dpr	2010-04-11 13:59:09 UTC (rev 432)
+++ utilities/dzPrepBuild/trunk/testdata/TestProject.dpr	2010-04-11 14:13:11 UTC (rev 433)
@@ -0,0 +1,4 @@
+program Testproject;
+
+begin
+end.

Modified: utilities/dzPrepBuild/trunk/testdata/Testproject.bdsproj
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/Testproject.bdsproj	2010-04-11 13:59:09 UTC (rev 432)
+++ utilities/dzPrepBuild/trunk/testdata/Testproject.bdsproj	2010-04-11 14:13:11 UTC (rev 433)
@@ -10,7 +10,7 @@
 	</PersonalityInfo>
 	<Delphi.Personality>
 		<Source>
-			<Source Name="MainSource">IncBuildNo.dpr</Source>
+			<Source Name="MainSource">Testproject.dpr</Source>
 		</Source>
 		<FileVersion>
 			<FileVersion Name="Version">7.0</FileVersion>
@@ -161,15 +161,15 @@
 		</VersionInfo>
 		<VersionInfoKeys>
 			<VersionInfoKeys Name="FileVersion"></VersionInfoKeys>
-			<VersionInfoKeys Name="ProductVersion">"2007-07-14"</VersionInfoKeys>
-			<VersionInfoKeys Name="CompanyName">"www.dummzeuch.de"</VersionInfoKeys>
-			<VersionInfoKeys Name="FileDescription">"Testproject"</VersionInfoKeys>
-			<VersionInfoKeys Name="InternalName">"testproject"</VersionInfoKeys>
-			<VersionInfoKeys Name="LegalCopyright">"Copyright 2002-2007 by Thomas Mueller"</VersionInfoKeys>
-			<VersionInfoKeys Name="LegalTrademarks">""</VersionInfoKeys>
-			<VersionInfoKeys Name="OriginalFilename">"testproject.exe"</VersionInfoKeys>
-			<VersionInfoKeys Name="ProductName">"Testproduct"</VersionInfoKeys>
-			<VersionInfoKeys Name="Comments">"internal use only"</VersionInfoKeys>
+			<VersionInfoKeys Name="ProductVersion">2007-07-14</VersionInfoKeys>
+			<VersionInfoKeys Name="CompanyName">www.dummzeuch.de</VersionInfoKeys>
+			<VersionInfoKeys Name="FileDescription">Testproject</VersionInfoKeys>
+			<VersionInfoKeys Name="InternalName">testproject</VersionInfoKeys>
+			<VersionInfoKeys Name="LegalCopyright">Copyright 2002-2007 by Thomas Mueller</VersionInfoKeys>
+			<VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys>
+			<VersionInfoKeys Name="OriginalFilename">testproject.exe</VersionInfoKeys>
+			<VersionInfoKeys Name="ProductName">Testproduct</VersionInfoKeys>
+			<VersionInfoKeys Name="Comments">internal use only</VersionInfoKeys>
 		</VersionInfoKeys>
 		<Language>
 			<Language Name="ActiveLang"></Language>

Added: utilities/dzPrepBuild/trunk/testdata/Testproject.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/Testproject.dproj	2010-04-11 13:59:09 UTC (rev 432)
+++ utilities/dzPrepBuild/trunk/testdata/Testproject.dproj	2010-04-11 14:13:11 UTC (rev 433)
@@ -0,0 +1,105 @@
+?	<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
+		<PropertyGroup>
+			<ProjectGuid>{209412AC-0EC2-4F63-B92A-E78853FF142A}</ProjectGuid>
+			<MainSource>TestProject.dpr</MainSource>
+			<Config Condition="'$(Config)'==''">Debug</Config>
+			<DCC_DCCCompiler>DCC32</DCC_DCCCompiler>
+			<ProjectVersion>12.0</ProjectVersion>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Config)'=='Base' or '$(Base)'!=''">
+			<Base>true</Base>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Config)'=='Release' or '$(Cfg_1)'!=''">
+			<Cfg_1>true</Cfg_1>
+			<CfgParent>Base</CfgParent>
+			<Base>true</Base>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Config)'=='Debug' or '$(Cfg_2)'!=''">
+			<Cfg_2>true</Cfg_2>
+			<CfgParent>Base</CfgParent>
+			<Base>true</Base>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Base)'!=''">
+			<DCC_ImageBase>00400000</DCC_ImageBase>
+			<DCC_UsePackage>rtl;vcl;vcldb;dbrtl;vclx;dbxcds;dbexpress;IndySystem;IndyCore;VclSmp;IndyProtocols;dsnap;adortl;vclactnband;vclshlctrls;JvCustomD9R;JvSystemD9R;JvCoreD9R;DJcl;JvStdCtrlsD9R;dzConfigd9;PerlRegExD2005;SynEdit_R2005;SynUni_D2005;JvAppFrmD9R;JvBandsD9R;JvBDED9R;JvCmpD9R;JvCryptD9R;JvCtrlsD9R;JvDlgsD9R;JvDockingD9R;JvDotNetCtrlsD9R;JvEDID9R;JvGlobusD9R;JvHMID9R;JvInspectorD9R;JvInterpreterD9R;JvJansD9R;JvManagedThreadsD9R;JvMMD9R;JvNetD9R;JvPageCompsD9R;JvPluginD9R;JvPrintPreviewD9R;JvTimeFrameworkD9R;JvUIBD9R;JvValidatorsD9R;JvWizardD9R;JvXPCtrlsD9R</DCC_UsePackage>
+			<DCC_DebugInformation>false</DCC_DebugInformation>
+			<DCC_UnitAlias>WinTypes=Windows;WinProcs=Windows;DbiTypes=BDE;DbiProcs=BDE;DbiErrs=BDE;$(DCC_UnitAlias)</DCC_UnitAlias>
+			<DCC_Platform>x86</DCC_Platform>
+			<DCC_DependencyCheckOutputName>TestProject.exe</DCC_DependencyCheckOutputName>
+			<DCC_K>false</DCC_K>
+			<DCC_N>true</DCC_N>
+			<DCC_S>false</DCC_S>
+			<DCC_SymbolReferenceInfo>1</DCC_SymbolReferenceInfo>
+			<DCC_E>false</DCC_E>
+			<DCC_F>false</DCC_F>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Cfg_1)'!=''">
+			<DCC_Define>RELEASE;$(DCC_Define)</DCC_Define>
+			<DCC_LocalDebugSymbols>false</DCC_LocalDebugSymbols>
+			<DCC_SymbolReferenceInfo>0</DCC_SymbolReferenceInfo>
+		</PropertyGroup>
+		<PropertyGroup Condition="'$(Cfg_2)'!=''">
+			<DCC_Define>DEBUG;$(DCC_Define)</DCC_Define>
+		</PropertyGroup>
+		<ItemGroup>
+			<DelphiCompile Include="TestProject.dpr">
+				<MainSource>MainSource</MainSource>
+			</DelphiCompile>
+			<BuildConfiguration Include="Base">
+				<Key>Base</Key>
+			</BuildConfiguration>
+			<BuildConfiguration Include="Debug">
+				<Key>Cfg_2</Key>
+				<CfgParent>Base</CfgParent>
+			</BuildConfiguration>
+			<BuildConfiguration Include="Release">
+				<Key>Cfg_1</Key>
+				<CfgParent>Base</CfgParent>
+			</BuildConfiguration>
+		</ItemGroup>
+		<Import Project="$(BDS)\Bin\CodeGear.Delphi.Targets" Condition="Exists('$(BDS)\Bin\CodeGear.Delphi.Targets')"/>
+		<ProjectExtensions>
+			<Borland.Personality>Delphi.Personality.12</Borland.Personality>
+			<Borland.ProjectType/>
+			<BorlandProject>
+				<Delphi.Personality>
+					<Source>
+						<Source Name="MainSource">TestProject.dpr</Source>
+					</Source>
+					<Parameters>
+						<Parameters Name="UseLauncher">False</Parameters>
+						<Parameters Name="LoadAllSymbols">True</Parameters>
+						<Parameters Name="LoadUnspecifiedSymbols">False</Parameters>
+					</Parameters>
+					<VersionInfo>
+						<VersionInfo Name="IncludeVerInfo">True</VersionInfo>
+						<VersionInfo Name="AutoIncBuild">False</VersionInfo>
+						<VersionInfo Name="MajorVer">1</VersionInfo>
+						<VersionInfo Name="MinorVer">31</VersionInfo>
+						<VersionInfo Name="Release">0</VersionInfo>
+						<VersionInfo Name="Build">0</VersionInfo>
+						<VersionInfo Name="Debug">False</VersionInfo>
+						<VersionInfo Name="PreRelease">False</VersionInfo>
+						<VersionInfo Name="Special">False</VersionInfo>
+						<VersionInfo Name="Private">False</VersionInfo>
+						<VersionInfo Name="DLL">False</VersionInfo>
+						<VersionInfo Name="Locale">1033</VersionInfo>
+						<VersionInfo Name="CodePage">1252</VersionInfo>
+					</VersionInfo>
+					<VersionInfoKeys>
+						<VersionInfoKeys Name="FileVersion"/>
+						<VersionInfoKeys Name="ProductVersion">&quot;2007-07-14&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="CompanyName">&quot;www.dummzeuch.de&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="FileDescription">&quot;Testproject&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="InternalName">&quot;testproject&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="LegalCopyright">&quot;Copyright 2002-2007 by Thomas Mueller&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="LegalTrademarks">&quot;&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="OriginalFilename">&quot;testproject.exe&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="ProductName">&quot;Testproduct&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="Comments">&quot;internal use only&quot;</VersionInfoKeys>
+					</VersionInfoKeys>
+				</Delphi.Personality>
+			</BorlandProject>
+			<ProjectFileVersion>12</ProjectFileVersion>
+		</ProjectExtensions>
+	</Project>

Deleted: utilities/dzPrepBuild/trunk/testdata/copyback.cmd
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/copyback.cmd	2010-04-11 13:59:09 UTC (rev 432)
+++ utilities/dzPrepBuild/trunk/testdata/copyback.cmd	2010-04-11 14:13:11 UTC (rev 433)
@@ -1,2 +0,0 @@
-copy OriginalTestproject.dof Testproject.dof
-copy OriginalTestproject.bdsproj Testproject.bdsproj



From twm at mail.berlios.de  Sun Apr 11 16:20:28 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 16:20:28 +0200
Subject: [Dzchart-svncheckins] r434 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111420.o3BEKSXI021426@sheep.berlios.de>

Author: twm
Date: 2010-04-11 16:20:26 +0200 (Sun, 11 Apr 2010)
New Revision: 434

Removed:
   utilities/dzPrepBuild/trunk/src/u_DummyVersionInfo.pas
Modified:
   utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
Log:
removed unused u_DummyVersionInfo

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 14:13:11 UTC (rev 433)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 14:20:26 UTC (rev 434)
@@ -15,7 +15,6 @@
   u_IniVersionInfo in 'u_IniVersionInfo.pas',
   u_CentralIniVersionInfo in 'u_CentralIniVersionInfo.pas',
   u_PrepBuildMain in 'u_PrepBuildMain.pas',
-  u_DummyVersionInfo in 'u_DummyVersionInfo.pas',
   u_VersionInfo in 'u_VersionInfo.pas',
   u_dzGetOpt in '..\libs\dzCmdLineParsersrc\u_dzGetOpt.pas',
   u_dzDefaultMain in '..\libs\dzCmdLineParsersrc\u_dzDefaultMain.pas',

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 14:13:11 UTC (rev 433)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 14:20:26 UTC (rev 434)
@@ -37,7 +37,7 @@
     <Borland.Personality>Delphi.Personality</Borland.Personality>
     <Borland.ProjectType />
     <BorlandProject>
-<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readini=src\prepbuild --exec=buildtools\prep.cmd</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
+<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readbdsproj=testdata\testproject --updatebdsproj=testdata\testproject</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Pack!
 ages>
       <Excluded_Packages Name="$(BDS)\bin\dclofficexp100.bpl">Microsoft Office XP Sample Automation Server Wrapper Components</Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dcloffice2k100.bpl">Microsoft Office 2000 Sample Automation Server Wrapper Components</Excluded_Packages>
     </Excluded_Packages><Source><Source Name="MainSource">PrepBuild.dpr</Source></Source><VersionInfoKeys><VersionInfoKeys Name="CompanyName"></VersionInfoKeys><VersionInfoKeys Name="FileDescription"></VersionInfoKeys><VersionInfoKeys Name="FileVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="InternalName"></VersionInfoKeys><VersionInfoKeys Name="LegalCopyright"></VersionInfoKeys><VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys><VersionInfoKeys Name="OriginalFilename"></VersionInfoKeys><VersionInfoKeys Name="ProductName"></VersionInfoKeys><VersionInfoKeys Name="ProductVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="Comments"></VersionInfoKeys></VersionInfoKeys></Delphi.Personality><ModelSupport>False</ModelSupport></BorlandProject></BorlandProject>
@@ -69,7 +69,6 @@
     <DCCReference Include="i_VersionInfoAccess.pas" />
     <DCCReference Include="u_CentralIniVersionInfo.pas" />
     <DCCReference Include="u_DofVersionInfo.pas" />
-    <DCCReference Include="u_DummyVersionInfo.pas" />
     <DCCReference Include="u_IniVersionInfo.pas" />
     <DCCReference Include="u_PrepBuildMain.pas" />
     <DCCReference Include="u_VersionInfo.pas" />

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 14:13:11 UTC (rev 433)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 14:20:26 UTC (rev 434)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=215
-FileVersion=1.2.0.215
+Build=222
+FileVersion=1.2.0.222
 

Deleted: utilities/dzPrepBuild/trunk/src/u_DummyVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_DummyVersionInfo.pas	2010-04-11 14:13:11 UTC (rev 433)
+++ utilities/dzPrepBuild/trunk/src/u_DummyVersionInfo.pas	2010-04-11 14:20:26 UTC (rev 434)
@@ -1,20 +0,0 @@
-unit u_DummyVersionInfo;
-
-interface
-
-uses
-  i_VersionInfoAccess,
-  u_VersionInfo;
-
-//type
-//  TDummyVersionInfo = class(TInterfacedObject, IVersionInfoAccess)
-//  protected
-//  end;
-
-implementation
-
-{ TDummyVersionInfo }
-
-
-end.
-

Modified: utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 14:13:11 UTC (rev 433)
+++ utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 14:20:26 UTC (rev 434)
@@ -27,15 +27,14 @@
 implementation
 
 uses
+  Dialogs,
   u_dzTranslator,
   u_dzExecutor,
   u_dzJclUtils,
   u_dzShellApiUtils,
   u_DofVersionInfo,
   d_BdsProjVersionInfo,
-  u_CentralIniVersionInfo,
-  u_DummyVersionInfo,
-  Dialogs;
+  u_CentralIniVersionInfo;
 
 { TPrepBuildMain }
 



From twm at mail.berlios.de  Sun Apr 11 16:30:25 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 16:30:25 +0200
Subject: [Dzchart-svncheckins] r435 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111430.o3BEUPsa022159@sheep.berlios.de>

Author: twm
Date: 2010-04-11 16:30:18 +0200 (Sun, 11 Apr 2010)
New Revision: 435

Added:
   utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm
   utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas
Modified:
   utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
Log:
started dproj support

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 14:20:26 UTC (rev 434)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 14:30:18 UTC (rev 435)
@@ -9,6 +9,7 @@
   SysUtils,
   Forms,
   oxmldom,
+  d_DProjVersionInfo in 'd_DProjVersionInfo.pas' {dm_DProjVersionInfo: TDataModule},
   d_BdsProjVersionInfo in 'd_BdsProjVersionInfo.pas' {dm_BdsProjVersionInfo: TDataModule},
   i_VersionInfoAccess in 'i_VersionInfoAccess.pas',
   u_DofVersionInfo in 'u_DofVersionInfo.pas',

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 14:20:26 UTC (rev 434)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 14:30:18 UTC (rev 435)
@@ -66,6 +66,10 @@
       <Form>dm_BdsProjVersionInfo</Form>
       <DesignClass>TDataModule</DesignClass>
     </DCCReference>
+    <DCCReference Include="d_DProjVersionInfo.pas">
+      <Form>dm_DProjVersionInfo</Form>
+      <DesignClass>TDataModule</DesignClass>
+    </DCCReference>
     <DCCReference Include="i_VersionInfoAccess.pas" />
     <DCCReference Include="u_CentralIniVersionInfo.pas" />
     <DCCReference Include="u_DofVersionInfo.pas" />

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 14:20:26 UTC (rev 434)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 14:30:18 UTC (rev 435)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=222
-FileVersion=1.2.0.222
+Build=224
+FileVersion=1.2.0.224
 

Copied: utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm (from rev 434, utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.dfm)
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.dfm	2010-04-11 14:20:26 UTC (rev 434)
+++ utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm	2010-04-11 14:30:18 UTC (rev 435)
@@ -0,0 +1,10 @@
+object dm_DProjVersionInfo: Tdm_DProjVersionInfo
+  OldCreateOrder = False
+  Height = 150
+  Width = 215
+  object ProjDoc: TXMLDocument
+    Left = 64
+    Top = 40
+    DOMVendorDesc = 'MSXML'
+  end
+end

Copied: utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas (from rev 434, utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas)
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas	2010-04-11 14:20:26 UTC (rev 434)
+++ utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas	2010-04-11 14:30:18 UTC (rev 435)
@@ -0,0 +1,213 @@
+unit d_DProjVersionInfo;
+
+interface
+
+uses
+  Windows,
+  SysUtils,
+  Classes,
+  xmldom,
+  XMLIntf,
+  msxmldom,
+  XMLDoc,
+  u_VersionInfo,
+  i_VersionInfoAccess;
+
+type
+  Tdm_DProjVersionInfo = class(TDataModule, IVersionInfoAccess)
+    ProjDoc: TXMLDocument;
+  private
+    FProjectName: string;
+    function GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
+    function GetVersionInfo(const _Name: string): string;
+    function GetVersionInfoKey(const _Name: string): string;
+    procedure SetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName, _Value: string);
+    procedure SetVersionInfo(const _Name, _Value: string);
+    procedure SetVersionInfoKey(const _Name, _Value: string);
+  protected // IInterface
+    FRefCount: integer;
+    function QueryInterface(const IID: TGUID; out Obj): HResult; override; stdcall;
+    function _AddRef: integer; stdcall;
+    function _Release: integer; stdcall;
+  protected // implementation of IVersionInfo
+    function VerInfoFilename: string;
+    procedure ReadFromFile(_VerInfo: TVersionInfo);
+    procedure WriteToFile(_VerInfo: TVersionInfo);
+  protected
+    FBdsProjFile: string;
+    FVersionInfo: IXMLNode;
+    FVersionInfoKeys: IXMLNode;
+  public
+    constructor Create(const _Project: string); reintroduce;
+    destructor Destroy; override;
+    class function FilenameFor(const _Project: string): string;
+  end;
+
+implementation
+
+{$R *.dfm}
+
+uses
+  StrUtils,
+  u_dzTranslator;
+
+{ Tdm_BdsProjVersionInfo }
+
+function Tdm_DProjVersionInfo.GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
+var
+  Node: IXMLNode;
+begin
+  // <VersionInfo Name="IncludeVerInfo">True</VersionInfo>
+  Node := _Parent.ChildNodes.First;
+  while Assigned(Node) do begin
+    if Node.nodeName = _NodeName then begin
+      if SameText(Node.Attributes['Name'], _AttrName) then begin
+        Result := Node.Text;
+        exit;
+      end;
+    end;
+    Node := Node.nextSibling;
+  end;
+end;
+
+function Tdm_DProjVersionInfo.GetVersionInfo(const _Name: string): string;
+begin
+  Result := GetChildNodeContent(FVersionInfo, 'VersionInfo', _Name);
+end;
+
+function Tdm_DProjVersionInfo.GetVersionInfoKey(const _Name: string): string;
+begin
+  Result := GetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name);
+end;
+
+procedure Tdm_DProjVersionInfo.SetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName, _Value: string);
+var
+  Node: IXMLNode;
+begin
+  // <*NodeName* Name="*AttrName*">*Value*</VersionInfo>
+  Node := _Parent.ChildNodes.First;
+  while Assigned(Node) do begin
+    if Node.nodeName = _NodeName then begin
+      if SameText(Node.Attributes['Name'], _AttrName) then begin
+        Node.Text := _Value;
+        exit;
+      end;
+    end;
+    Node := Node.nextSibling;
+  end;
+end;
+
+constructor Tdm_DProjVersionInfo.Create(const _Project: string);
+var
+  Project: IXMLNode;
+  ProjectExtensions: IXMLNode;
+  BorlandProject: IXMLNode;
+  DelphiPersonality: IXMLNode;
+begin
+  inherited Create(nil);
+  FProjectName := _Project;
+  FBdsProjFile := VerInfoFilename;
+  ProjDoc.FileName := FBdsProjFile;
+  ProjDoc.Active := True;
+  Project := ProjDoc.DocumentElement;
+  ProjectExtensions := Project.ChildNodes['ProjectExtensions'];
+  BorlandProject := ProjectExtensions.ChildNodes['BorlandProject'];
+  DelphiPersonality := BorlandProject.ChildNodes['Delphi.Personality'];
+  FVersionInfo := DelphiPersonality.ChildNodes['VersionInfo'];
+  FVersionInfoKeys := DelphiPersonality.ChildNodes['VersionInfoKeys'];
+
+  if not SameText(GetChildNodeContent(FVersionInfo, 'VersionInfo', 'IncludeVerInfo'), 'True') then
+    raise ENoVersionInfo.Create(_('.dproj file does not contain version information'));
+end;
+
+destructor Tdm_DProjVersionInfo.Destroy;
+begin
+  FVersionInfo := nil;
+  inherited;
+end;
+
+class function Tdm_DProjVersionInfo.FilenameFor(const _Project: string): string;
+begin
+  Result := ChangeFileExt(_Project, '.bdsproj');
+end;
+
+procedure Tdm_DProjVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
+begin
+  _VerInfo.AutoIncBuild := SameText(GetVersionInfo('AutoIncBuild'), 'True');
+
+  _VerInfo.MajorVer := StrToIntDef(GetVersionInfo('MajorVer'), 0);
+  _VerInfo.MinorVer := StrToIntDef(GetVersionInfo('MinorVer'), 0);
+  _VerInfo.Release := StrToIntDef(GetVersionInfo('Release'), 0);
+  _VerInfo.Build := StrToIntDef(GetVersionInfo('Build'), 0);
+
+  _VerInfo.Comments := GetVersionInfoKey('Comments');
+  _VerInfo.CompanyName := GetVersionInfoKey('CompanyName');
+  _VerInfo.FileDescription := GetVersionInfoKey('FileDescription');
+  _VerInfo.FileVersion := GetVersionInfoKey('FileVersion');
+  _VerInfo.InternalName := GetVersionInfoKey('InternalName');
+  _VerInfo.LegalCopyright := GetVersionInfoKey('LegalCopyright');
+  _VerInfo.LegalTrademarks := GetVersionInfoKey('LegalTrademarks');
+  _VerInfo.OriginalFilename := GetVersionInfoKey('OriginalFilename');
+  _VerInfo.ProductName := GetVersionInfoKey('ProductName');
+  _VerInfo.ProductVersion := GetVersionInfoKey('ProductVersion');
+end;
+
+procedure Tdm_DProjVersionInfo.WriteToFile(_VerInfo: TVersionInfo);
+begin
+  SetVersionInfo('AutoIncBuild', IfThen(_VerInfo.AutoIncBuild, 'True', 'False'));
+  SetVersionInfo('Build', IntToStr(_VerInfo.Build));
+  SetVersionInfoKey('Comments', _VerInfo.Comments);
+  SetVersionInfoKey('CompanyName', _VerInfo.CompanyName);
+  SetVersionInfoKey('FileDescription', _VerInfo.FileDescription);
+  SetVersionInfoKey('FileVersion', _VerInfo.FileVersion);
+  SetVersionInfoKey('InternalName', _VerInfo.InternalName);
+  SetVersionInfoKey('LegalCopyright', _VerInfo.LegalCopyright);
+  SetVersionInfoKey('LegalTrademarks', _VerInfo.LegalTrademarks);
+  SetVersionInfo('MajorVer', IntToStr(_VerInfo.MajorVer));
+  SetVersionInfo('MinorVer', IntToStr(_VerInfo.MinorVer));
+  SetVersionInfoKey('OriginalFilename', _VerInfo.OriginalFilename);
+  SetVersionInfoKey('ProductName', _VerInfo.ProductName);
+  SetVersionInfoKey('ProductVersion', _VerInfo.ProductVersion);
+  SetVersionInfo('Release', IntToStr(_VerInfo.Release));
+  ProjDoc.SaveToFile(FBdsProjFile);
+end;
+
+procedure Tdm_DProjVersionInfo.SetVersionInfo(const _Name, _Value: string);
+begin
+  SetChildNodeContent(FVersionInfo, 'VersionInfo', _Name, _Value);
+end;
+
+procedure Tdm_DProjVersionInfo.SetVersionInfoKey(const _Name, _Value: string);
+begin
+  SetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name, _Value);
+end;
+
+function Tdm_DProjVersionInfo.VerInfoFilename: string;
+begin
+  Result := FilenameFor(FProjectName);
+end;
+
+// standard TInterfacedObject implementation of IInterface
+
+function Tdm_DProjVersionInfo.QueryInterface(const IID: TGUID; out Obj): HResult;
+begin
+  if GetInterface(IID, Obj) then
+    Result := S_OK
+  else
+    Result := E_NOINTERFACE
+end;
+
+function Tdm_DProjVersionInfo._AddRef: integer;
+begin
+  Result := InterlockedIncrement(FRefCount);
+end;
+
+function Tdm_DProjVersionInfo._Release: integer;
+begin
+  Result := InterlockedDecrement(FRefCount);
+  if Result = 0 then
+    Destroy;
+end;
+
+end.
+



From twm at mail.berlios.de  Sun Apr 11 17:03:13 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 17:03:13 +0200
Subject: [Dzchart-svncheckins] r436 - in utilities/dzPrepBuild/trunk: src
	testdata
Message-ID: <201004111503.o3BF3DFc024426@sheep.berlios.de>

Author: twm
Date: 2010-04-11 17:03:11 +0200 (Sun, 11 Apr 2010)
New Revision: 436

Modified:
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
   utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.dproj
   utilities/dzPrepBuild/trunk/testdata/Testproject.dproj
Log:
reading .dproj files now works

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 14:30:18 UTC (rev 435)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 15:03:11 UTC (rev 436)
@@ -37,7 +37,7 @@
     <Borland.Personality>Delphi.Personality</Borland.Personality>
     <Borland.ProjectType />
     <BorlandProject>
-<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readbdsproj=testdata\testproject --updatebdsproj=testdata\testproject</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Pack!
 ages>
+<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readdproj=testdata\testproject --updateini=testdata\testproject</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dclofficexp100.bpl">Microsoft Office XP Sample Automation Server Wrapper Components</Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dcloffice2k100.bpl">Microsoft Office 2000 Sample Automation Server Wrapper Components</Excluded_Packages>
     </Excluded_Packages><Source><Source Name="MainSource">PrepBuild.dpr</Source></Source><VersionInfoKeys><VersionInfoKeys Name="CompanyName"></VersionInfoKeys><VersionInfoKeys Name="FileDescription"></VersionInfoKeys><VersionInfoKeys Name="FileVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="InternalName"></VersionInfoKeys><VersionInfoKeys Name="LegalCopyright"></VersionInfoKeys><VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys><VersionInfoKeys Name="OriginalFilename"></VersionInfoKeys><VersionInfoKeys Name="ProductName"></VersionInfoKeys><VersionInfoKeys Name="ProductVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="Comments"></VersionInfoKeys></VersionInfoKeys></Delphi.Personality><ModelSupport>False</ModelSupport></BorlandProject></BorlandProject>

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 14:30:18 UTC (rev 435)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:03:11 UTC (rev 436)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=224
-FileVersion=1.2.0.224
+Build=228
+FileVersion=1.2.0.228
 

Modified: utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas	2010-04-11 14:30:18 UTC (rev 435)
+++ utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas	2010-04-11 15:03:11 UTC (rev 436)
@@ -34,7 +34,7 @@
     procedure ReadFromFile(_VerInfo: TVersionInfo);
     procedure WriteToFile(_VerInfo: TVersionInfo);
   protected
-    FBdsProjFile: string;
+    FXmlFilename: string;
     FVersionInfo: IXMLNode;
     FVersionInfoKeys: IXMLNode;
   public
@@ -106,8 +106,8 @@
 begin
   inherited Create(nil);
   FProjectName := _Project;
-  FBdsProjFile := VerInfoFilename;
-  ProjDoc.FileName := FBdsProjFile;
+  FXmlFilename := VerInfoFilename;
+  ProjDoc.FileName := FXmlFilename;
   ProjDoc.Active := True;
   Project := ProjDoc.DocumentElement;
   ProjectExtensions := Project.ChildNodes['ProjectExtensions'];
@@ -128,7 +128,7 @@
 
 class function Tdm_DProjVersionInfo.FilenameFor(const _Project: string): string;
 begin
-  Result := ChangeFileExt(_Project, '.bdsproj');
+  Result := ChangeFileExt(_Project, '.dproj');
 end;
 
 procedure Tdm_DProjVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
@@ -169,7 +169,7 @@
   SetVersionInfoKey('ProductName', _VerInfo.ProductName);
   SetVersionInfoKey('ProductVersion', _VerInfo.ProductVersion);
   SetVersionInfo('Release', IntToStr(_VerInfo.Release));
-  ProjDoc.SaveToFile(FBdsProjFile);
+  ProjDoc.SaveToFile(FXmlFilename);
 end;
 
 procedure Tdm_DProjVersionInfo.SetVersionInfo(const _Name, _Value: string);

Modified: utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 14:30:18 UTC (rev 435)
+++ utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 15:03:11 UTC (rev 436)
@@ -34,7 +34,8 @@
   u_dzShellApiUtils,
   u_DofVersionInfo,
   d_BdsProjVersionInfo,
-  u_CentralIniVersionInfo;
+  u_CentralIniVersionInfo,
+  d_DProjVersionInfo;
 
 { TPrepBuildMain }
 
@@ -194,16 +195,22 @@
 
   if FGetOpt.OptionPassed('ReadBdsProj', Project) then begin
     if Assigned(VerInfoAccess) then
-      raise Exception.Create(_('You can only pass one of --ReadDof, --ReadBdsproj or --ReadIni'));
+      raise Exception.Create(_('You can only pass one of --ReadDof, --ReadBdsproj, --ReadDproj or --ReadIni'));
     VerInfoAccess := Tdm_BdsProjVersionInfo.Create(Project);
   end;
 
   if FGetOpt.OptionPassed('ReadIni', Project) then begin
     if Assigned(VerInfoAccess) then
-      raise Exception.Create(_('You can only pass one of --ReadDof, --ReadBdsproj or --ReadIni'));
+      raise Exception.Create(_('You can only pass one of --ReadDof, --ReadBdsproj, --ReadDproj  or --ReadIni'));
     VerInfoAccess := TCentralVersionInfo.Create(Project);
   end;
 
+  if FGetOpt.OptionPassed('ReadDproj', Project) then begin
+    if Assigned(VerInfoAccess) then
+      raise Exception.Create(_('You can only pass one of --ReadDof, --ReadBdsproj, --ReadDproj  or --ReadIni'));
+    VerInfoAccess := Tdm_DProjVersionInfo.Create(Project);
+  end;
+
   VersionInfo := TVersionInfo.Create;
   try
     if Assigned(VerInfoAccess) then begin
@@ -304,6 +311,7 @@
   FGetOpt.RegisterOption('ReadDof', _('read a .dof file to get the version information'), true);
   FGetOpt.RegisterOption('ReadBdsproj', _('read a .bdsproj file to get the version information'), true);
   FGetOpt.RegisterOption('ReadIni', _('read a .ini file to get the version information'), true);
+  FGetOpt.RegisterOption('ReadDproj', _('Read a .dproj file to get the version information'), true);
   FGetOpt.RegisterOption('Exec', _('execute the given program or script with extended environment'), true);
   FGetOpt.RegisterOption('UpdateDof', _('update a .dof file with the version information'), true);
   FGetOpt.RegisterOption('UpdateBdsproj', _('update a .bdsproj file with the version information'), true);

Modified: utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.dproj	2010-04-11 14:30:18 UTC (rev 435)
+++ utilities/dzPrepBuild/trunk/testdata/OriginalTestproject.dproj	2010-04-11 15:03:11 UTC (rev 436)
@@ -75,7 +75,7 @@
 						<VersionInfo Name="IncludeVerInfo">True</VersionInfo>
 						<VersionInfo Name="AutoIncBuild">False</VersionInfo>
 						<VersionInfo Name="MajorVer">1</VersionInfo>
-						<VersionInfo Name="MinorVer">31</VersionInfo>
+						<VersionInfo Name="MinorVer">0</VersionInfo>
 						<VersionInfo Name="Release">0</VersionInfo>
 						<VersionInfo Name="Build">0</VersionInfo>
 						<VersionInfo Name="Debug">False</VersionInfo>
@@ -88,15 +88,15 @@
 					</VersionInfo>
 					<VersionInfoKeys>
 						<VersionInfoKeys Name="FileVersion"/>
-						<VersionInfoKeys Name="ProductVersion">&quot;2007-07-14&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="CompanyName">&quot;www.dummzeuch.de&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="FileDescription">&quot;Testproject&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="InternalName">&quot;testproject&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="LegalCopyright">&quot;Copyright 2002-2007 by Thomas Mueller&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="LegalTrademarks">&quot;&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="OriginalFilename">&quot;testproject.exe&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="ProductName">&quot;Testproduct&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="Comments">&quot;internal use only&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="ProductVersion">2007-07-14</VersionInfoKeys>
+						<VersionInfoKeys Name="CompanyName">www.dummzeuch.de</VersionInfoKeys>
+						<VersionInfoKeys Name="FileDescription">Testproject</VersionInfoKeys>
+						<VersionInfoKeys Name="InternalName">testproject</VersionInfoKeys>
+						<VersionInfoKeys Name="LegalCopyright">Copyright 2002-2007 by Thomas Mueller</VersionInfoKeys>
+						<VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys>
+						<VersionInfoKeys Name="OriginalFilename">testproject.exe</VersionInfoKeys>
+						<VersionInfoKeys Name="ProductName">Testproduct</VersionInfoKeys>
+						<VersionInfoKeys Name="Comments">internal use only</VersionInfoKeys>
 					</VersionInfoKeys>
 				</Delphi.Personality>
 			</BorlandProject>

Modified: utilities/dzPrepBuild/trunk/testdata/Testproject.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/Testproject.dproj	2010-04-11 14:30:18 UTC (rev 435)
+++ utilities/dzPrepBuild/trunk/testdata/Testproject.dproj	2010-04-11 15:03:11 UTC (rev 436)
@@ -75,7 +75,7 @@
 						<VersionInfo Name="IncludeVerInfo">True</VersionInfo>
 						<VersionInfo Name="AutoIncBuild">False</VersionInfo>
 						<VersionInfo Name="MajorVer">1</VersionInfo>
-						<VersionInfo Name="MinorVer">31</VersionInfo>
+						<VersionInfo Name="MinorVer">0</VersionInfo>
 						<VersionInfo Name="Release">0</VersionInfo>
 						<VersionInfo Name="Build">0</VersionInfo>
 						<VersionInfo Name="Debug">False</VersionInfo>
@@ -88,15 +88,15 @@
 					</VersionInfo>
 					<VersionInfoKeys>
 						<VersionInfoKeys Name="FileVersion"/>
-						<VersionInfoKeys Name="ProductVersion">&quot;2007-07-14&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="CompanyName">&quot;www.dummzeuch.de&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="FileDescription">&quot;Testproject&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="InternalName">&quot;testproject&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="LegalCopyright">&quot;Copyright 2002-2007 by Thomas Mueller&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="LegalTrademarks">&quot;&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="OriginalFilename">&quot;testproject.exe&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="ProductName">&quot;Testproduct&quot;</VersionInfoKeys>
-						<VersionInfoKeys Name="Comments">&quot;internal use only&quot;</VersionInfoKeys>
+						<VersionInfoKeys Name="ProductVersion">2007-07-14</VersionInfoKeys>
+						<VersionInfoKeys Name="CompanyName">www.dummzeuch.de</VersionInfoKeys>
+						<VersionInfoKeys Name="FileDescription">Testproject</VersionInfoKeys>
+						<VersionInfoKeys Name="InternalName">testproject</VersionInfoKeys>
+						<VersionInfoKeys Name="LegalCopyright">Copyright 2002-2007 by Thomas Mueller</VersionInfoKeys>
+						<VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys>
+						<VersionInfoKeys Name="OriginalFilename">testproject.exe</VersionInfoKeys>
+						<VersionInfoKeys Name="ProductName">Testproduct</VersionInfoKeys>
+						<VersionInfoKeys Name="Comments">internal use only</VersionInfoKeys>
 					</VersionInfoKeys>
 				</Delphi.Personality>
 			</BorlandProject>



From twm at mail.berlios.de  Sun Apr 11 17:18:24 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 17:18:24 +0200
Subject: [Dzchart-svncheckins] r437 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111518.o3BFIO1W025626@sheep.berlios.de>

Author: twm
Date: 2010-04-11 17:18:20 +0200 (Sun, 11 Apr 2010)
New Revision: 437

Added:
   utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.dfm
   utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.pas
Modified:
   utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.dfm
   utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm
   utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas
Log:
refactoring: DprojVersionInfo and BdsprojVersionInfo now descend from XmlVersionInfo

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 15:18:20 UTC (rev 437)
@@ -9,7 +9,8 @@
   SysUtils,
   Forms,
   oxmldom,
-  d_DProjVersionInfo in 'd_DProjVersionInfo.pas' {dm_DProjVersionInfo: TDataModule},
+  d_XmlVersionInfo in 'd_XmlVersionInfo.pas' {dm_XmlVersionInfo: TDataModule},
+  d_DprojVersionInfo in 'd_DprojVersionInfo.pas' {dm_DprojVersionInfo: TDataModule},
   d_BdsProjVersionInfo in 'd_BdsProjVersionInfo.pas' {dm_BdsProjVersionInfo: TDataModule},
   i_VersionInfoAccess in 'i_VersionInfoAccess.pas',
   u_DofVersionInfo in 'u_DofVersionInfo.pas',

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 15:18:20 UTC (rev 437)
@@ -66,10 +66,14 @@
       <Form>dm_BdsProjVersionInfo</Form>
       <DesignClass>TDataModule</DesignClass>
     </DCCReference>
-    <DCCReference Include="d_DProjVersionInfo.pas">
-      <Form>dm_DProjVersionInfo</Form>
+    <DCCReference Include="d_DprojVersionInfo.pas">
+      <Form>dm_DprojVersionInfo</Form>
       <DesignClass>TDataModule</DesignClass>
     </DCCReference>
+    <DCCReference Include="d_XmlVersionInfo.pas">
+      <Form>dm_XmlVersionInfo</Form>
+      <DesignClass>TDataModule</DesignClass>
+    </DCCReference>
     <DCCReference Include="i_VersionInfoAccess.pas" />
     <DCCReference Include="u_CentralIniVersionInfo.pas" />
     <DCCReference Include="u_DofVersionInfo.pas" />

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:18:20 UTC (rev 437)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=228
-FileVersion=1.2.0.228
+Build=236
+FileVersion=1.2.0.236
 

Modified: utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.dfm
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.dfm	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.dfm	2010-04-11 15:18:20 UTC (rev 437)
@@ -1,11 +1,2 @@
-object dm_BdsProjVersionInfo: Tdm_BdsProjVersionInfo
-  OldCreateOrder = False
-  Height = 150
-  Width = 215
-  object ProjDoc: TXMLDocument
-    FileName = 'D:\source\incbuildno\test.bdsproj'
-    Left = 64
-    Top = 40
-    DOMVendorDesc = 'MSXML'
-  end
+inherited dm_BdsProjVersionInfo: Tdm_BdsProjVersionInfo
 end

Modified: utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas	2010-04-11 15:18:20 UTC (rev 437)
@@ -6,204 +6,42 @@
   Windows,
   SysUtils,
   Classes,
+  d_XmlVersionInfo,
   xmldom,
   XMLIntf,
   msxmldom,
-  XMLDoc,
-  u_VersionInfo,
-  i_VersionInfoAccess;
+  XMLDoc;
 
 type
-  Tdm_BdsProjVersionInfo = class(TDataModule, IVersionInfoAccess)
-    ProjDoc: TXMLDocument;
+  Tdm_BdsProjVersionInfo = class(Tdm_XmlVersionInfo)
   private
-    FProjectName: string;
-    function GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
-    function GetVersionInfo(const _Name: string): string;
-    function GetVersionInfoKey(const _Name: string): string;
-    procedure SetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName, _Value: string);
-    procedure SetVersionInfo(const _Name, _Value: string);
-    procedure SetVersionInfoKey(const _Name, _Value: string);
-  protected // IInterface
-    FRefCount: integer;
-    function QueryInterface(const IID: TGUID; out Obj): HResult; override; stdcall;
-    function _AddRef: integer; stdcall;
-    function _Release: integer; stdcall;
-  protected // implementation of IVersionInfo
-    function VerInfoFilename: string;
-    procedure ReadFromFile(_VerInfo: TVersionInfo);
-    procedure WriteToFile(_VerInfo: TVersionInfo);
   protected
-    FBdsProjFile: string;
-    FVersionInfo: IXMLNode;
-    FVersionInfoKeys: IXMLNode;
+    procedure InitVersionNodes; override;
   public
-    constructor Create(const _Project: string); reintroduce;
-    destructor Destroy; override;
-    class function FilenameFor(const _Project: string): string;
+    class function FilenameFor(const _Project: string): string; override;
   end;
 
 implementation
 
 {$R *.dfm}
 
-uses
-  StrUtils,
-  u_dzTranslator;
-
 { Tdm_BdsProjVersionInfo }
 
-function Tdm_BdsProjVersionInfo.GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
-var
-  Node: IXMLNode;
+class function Tdm_BdsProjVersionInfo.FilenameFor(const _Project: string): string;
 begin
-  // <VersionInfo Name="IncludeVerInfo">True</VersionInfo>
-  Node := _Parent.ChildNodes.First;
-  while Assigned(Node) do begin
-    if Node.nodeName = _NodeName then begin
-      if SameText(Node.Attributes['Name'], _AttrName) then begin
-        Result := Node.Text;
-        exit;
-      end;
-    end;
-    Node := Node.nextSibling;
-  end;
+  Result := ChangeFileExt(_Project, '.bdsproj');
 end;
 
-function Tdm_BdsProjVersionInfo.GetVersionInfo(const _Name: string): string;
-begin
-  Result := GetChildNodeContent(FVersionInfo, 'VersionInfo', _Name);
-end;
-
-function Tdm_BdsProjVersionInfo.GetVersionInfoKey(const _Name: string): string;
-begin
-  Result := GetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName, _Value: string);
+procedure Tdm_BdsProjVersionInfo.InitVersionNodes;
 var
-  Node: IXMLNode;
-begin
-  // <*NodeName* Name="*AttrName*">*Value*</VersionInfo>
-  Node := _Parent.ChildNodes.First;
-  while Assigned(Node) do begin
-    if Node.nodeName = _NodeName then begin
-      if SameText(Node.Attributes['Name'], _AttrName) then begin
-        Node.Text := _Value;
-        exit;
-      end;
-    end;
-    Node := Node.nextSibling;
-  end;
-end;
-
-constructor Tdm_BdsProjVersionInfo.Create(const _Project: string);
-var
   BorlandProject: IXMLNode;
   DelphiPersonality: IXMLNode;
 begin
-  inherited Create(nil);
-  FProjectName := _Project;
-  FBdsProjFile := VerInfoFilename;
-  ProjDoc.FileName := FBdsProjFile;
-  ProjDoc.Active := True;
   BorlandProject := ProjDoc.DocumentElement;
   DelphiPersonality := BorlandProject.childNodes['Delphi.Personality'];
   FVersionInfo := DelphiPersonality.childNodes['VersionInfo'];
   FVersionInfoKeys := DelphiPersonality.childNodes['VersionInfoKeys'];
-
-  if not SameText(GetChildNodeContent(FVersionInfo, 'VersionInfo', 'IncludeVerInfo'), 'True') then
-    raise ENoVersionInfo.Create(_('.bdsproj file does not contain version information'));
 end;
 
-destructor Tdm_BdsProjVersionInfo.Destroy;
-begin
-  FVersionInfo := nil;
-  inherited;
-end;
-
-class function Tdm_BdsProjVersionInfo.FilenameFor(const _Project: string): string;
-begin
-  Result := ChangeFileExt(_Project, '.bdsproj');
-end;
-
-procedure Tdm_BdsProjVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
-begin
-  _VerInfo.AutoIncBuild := SameText(GetVersionInfo('AutoIncBuild'), 'True');
-
-  _VerInfo.MajorVer := StrToIntDef(GetVersionInfo('MajorVer'), 0);
-  _VerInfo.MinorVer := StrToIntDef(GetVersionInfo('MinorVer'), 0);
-  _VerInfo.Release := StrToIntDef(GetVersionInfo('Release'), 0);
-  _VerInfo.Build := StrToIntDef(GetVersionInfo('Build'), 0);
-
-  _VerInfo.Comments := GetVersionInfoKey('Comments');
-  _VerInfo.CompanyName := GetVersionInfoKey('CompanyName');
-  _VerInfo.FileDescription := GetVersionInfoKey('FileDescription');
-  _VerInfo.FileVersion := GetVersionInfoKey('FileVersion');
-  _VerInfo.InternalName := GetVersionInfoKey('InternalName');
-  _VerInfo.LegalCopyright := GetVersionInfoKey('LegalCopyright');
-  _VerInfo.LegalTrademarks := GetVersionInfoKey('LegalTrademarks');
-  _VerInfo.OriginalFilename := GetVersionInfoKey('OriginalFilename');
-  _VerInfo.ProductName := GetVersionInfoKey('ProductName');
-  _VerInfo.ProductVersion := GetVersionInfoKey('ProductVersion');
-end;
-
-procedure Tdm_BdsProjVersionInfo.WriteToFile(_VerInfo: TVersionInfo);
-begin
-  SetVersionInfo('AutoIncBuild', IfThen(_VerInfo.AutoIncBuild, 'True', 'False'));
-  SetVersionInfo('Build', IntToStr(_VerInfo.Build));
-  SetVersionInfoKey('Comments', _VerInfo.Comments);
-  SetVersionInfoKey('CompanyName', _VerInfo.CompanyName);
-  SetVersionInfoKey('FileDescription', _VerInfo.FileDescription);
-  SetVersionInfoKey('FileVersion', _VerInfo.FileVersion);
-  SetVersionInfoKey('InternalName', _VerInfo.InternalName);
-  SetVersionInfoKey('LegalCopyright', _VerInfo.LegalCopyright);
-  SetVersionInfoKey('LegalTrademarks', _VerInfo.LegalTrademarks);
-  SetVersionInfo('MajorVer', IntToStr(_VerInfo.MajorVer));
-  SetVersionInfo('MinorVer', IntToStr(_VerInfo.MinorVer));
-  SetVersionInfoKey('OriginalFilename', _VerInfo.OriginalFilename);
-  SetVersionInfoKey('ProductName', _VerInfo.ProductName);
-  SetVersionInfoKey('ProductVersion', _VerInfo.ProductVersion);
-  SetVersionInfo('Release', IntToStr(_VerInfo.Release));
-  ProjDoc.SaveToFile(FBdsProjFile);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetVersionInfo(const _Name, _Value: string);
-begin
-  SetChildNodeContent(FVersionInfo, 'VersionInfo', _Name, _Value);
-end;
-
-procedure Tdm_BdsProjVersionInfo.SetVersionInfoKey(const _Name, _Value: string);
-begin
-  SetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name, _Value);
-end;
-
-function Tdm_BdsProjVersionInfo.VerInfoFilename: string;
-begin
-  Result := FilenameFor(FProjectName);
-end;
-
-// standard TInterfacedObject implementation of IInterface
-
-function Tdm_BdsProjVersionInfo.QueryInterface(const IID: TGUID; out Obj): HResult;
-begin
-  if GetInterface(IID, Obj) then
-    Result := S_OK
-  else
-    Result := E_NOINTERFACE
-end;
-
-function Tdm_BdsProjVersionInfo._AddRef: integer;
-begin
-  Result := InterlockedIncrement(FRefCount);
-end;
-
-function Tdm_BdsProjVersionInfo._Release: integer;
-begin
-  Result := InterlockedDecrement(FRefCount);
-  if Result = 0 then
-    Destroy;
-end;
-
 end.
 

Modified: utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm	2010-04-11 15:18:20 UTC (rev 437)
@@ -1,10 +1,2 @@
-object dm_DProjVersionInfo: Tdm_DProjVersionInfo
-  OldCreateOrder = False
-  Height = 150
-  Width = 215
-  object ProjDoc: TXMLDocument
-    Left = 64
-    Top = 40
-    DOMVendorDesc = 'MSXML'
-  end
+inherited dm_DprojVersionInfo: Tdm_DprojVersionInfo
 end

Modified: utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas	2010-04-11 15:18:20 UTC (rev 437)
@@ -1,4 +1,4 @@
-unit d_DProjVersionInfo;
+unit d_DprojVersionInfo;
 
 interface
 
@@ -6,208 +6,44 @@
   Windows,
   SysUtils,
   Classes,
+  d_XmlVersionInfo,
   xmldom,
   XMLIntf,
   msxmldom,
-  XMLDoc,
-  u_VersionInfo,
-  i_VersionInfoAccess;
+  XMLDoc;
 
 type
-  Tdm_DProjVersionInfo = class(TDataModule, IVersionInfoAccess)
-    ProjDoc: TXMLDocument;
+  Tdm_DprojVersionInfo = class(Tdm_XmlVersionInfo)
   private
-    FProjectName: string;
-    function GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
-    function GetVersionInfo(const _Name: string): string;
-    function GetVersionInfoKey(const _Name: string): string;
-    procedure SetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName, _Value: string);
-    procedure SetVersionInfo(const _Name, _Value: string);
-    procedure SetVersionInfoKey(const _Name, _Value: string);
-  protected // IInterface
-    FRefCount: integer;
-    function QueryInterface(const IID: TGUID; out Obj): HResult; override; stdcall;
-    function _AddRef: integer; stdcall;
-    function _Release: integer; stdcall;
-  protected // implementation of IVersionInfo
-    function VerInfoFilename: string;
-    procedure ReadFromFile(_VerInfo: TVersionInfo);
-    procedure WriteToFile(_VerInfo: TVersionInfo);
   protected
-    FXmlFilename: string;
-    FVersionInfo: IXMLNode;
-    FVersionInfoKeys: IXMLNode;
+    procedure InitVersionNodes; override;
   public
-    constructor Create(const _Project: string); reintroduce;
-    destructor Destroy; override;
-    class function FilenameFor(const _Project: string): string;
+    class function FilenameFor(const _Project: string): string; override;
   end;
 
 implementation
 
 {$R *.dfm}
 
-uses
-  StrUtils,
-  u_dzTranslator;
-
-{ Tdm_BdsProjVersionInfo }
-
-function Tdm_DProjVersionInfo.GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
-var
-  Node: IXMLNode;
+class function Tdm_DprojVersionInfo.FilenameFor(const _Project: string): string;
 begin
-  // <VersionInfo Name="IncludeVerInfo">True</VersionInfo>
-  Node := _Parent.ChildNodes.First;
-  while Assigned(Node) do begin
-    if Node.nodeName = _NodeName then begin
-      if SameText(Node.Attributes['Name'], _AttrName) then begin
-        Result := Node.Text;
-        exit;
-      end;
-    end;
-    Node := Node.nextSibling;
-  end;
+  Result := ChangeFileExt(_Project, '.dproj');
 end;
 
-function Tdm_DProjVersionInfo.GetVersionInfo(const _Name: string): string;
-begin
-  Result := GetChildNodeContent(FVersionInfo, 'VersionInfo', _Name);
-end;
-
-function Tdm_DProjVersionInfo.GetVersionInfoKey(const _Name: string): string;
-begin
-  Result := GetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name);
-end;
-
-procedure Tdm_DProjVersionInfo.SetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName, _Value: string);
+procedure Tdm_DprojVersionInfo.InitVersionNodes;
 var
-  Node: IXMLNode;
-begin
-  // <*NodeName* Name="*AttrName*">*Value*</VersionInfo>
-  Node := _Parent.ChildNodes.First;
-  while Assigned(Node) do begin
-    if Node.nodeName = _NodeName then begin
-      if SameText(Node.Attributes['Name'], _AttrName) then begin
-        Node.Text := _Value;
-        exit;
-      end;
-    end;
-    Node := Node.nextSibling;
-  end;
-end;
-
-constructor Tdm_DProjVersionInfo.Create(const _Project: string);
-var
-  Project: IXMLNode;
   ProjectExtensions: IXMLNode;
-  BorlandProject: IXMLNode;
   DelphiPersonality: IXMLNode;
+  BorlandProject: IXMLNode;
+  Project: IXMLNode;
 begin
-  inherited Create(nil);
-  FProjectName := _Project;
-  FXmlFilename := VerInfoFilename;
-  ProjDoc.FileName := FXmlFilename;
-  ProjDoc.Active := True;
   Project := ProjDoc.DocumentElement;
   ProjectExtensions := Project.ChildNodes['ProjectExtensions'];
   BorlandProject := ProjectExtensions.ChildNodes['BorlandProject'];
   DelphiPersonality := BorlandProject.ChildNodes['Delphi.Personality'];
   FVersionInfo := DelphiPersonality.ChildNodes['VersionInfo'];
   FVersionInfoKeys := DelphiPersonality.ChildNodes['VersionInfoKeys'];
-
-  if not SameText(GetChildNodeContent(FVersionInfo, 'VersionInfo', 'IncludeVerInfo'), 'True') then
-    raise ENoVersionInfo.Create(_('.dproj file does not contain version information'));
 end;
 
-destructor Tdm_DProjVersionInfo.Destroy;
-begin
-  FVersionInfo := nil;
-  inherited;
-end;
-
-class function Tdm_DProjVersionInfo.FilenameFor(const _Project: string): string;
-begin
-  Result := ChangeFileExt(_Project, '.dproj');
-end;
-
-procedure Tdm_DProjVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
-begin
-  _VerInfo.AutoIncBuild := SameText(GetVersionInfo('AutoIncBuild'), 'True');
-
-  _VerInfo.MajorVer := StrToIntDef(GetVersionInfo('MajorVer'), 0);
-  _VerInfo.MinorVer := StrToIntDef(GetVersionInfo('MinorVer'), 0);
-  _VerInfo.Release := StrToIntDef(GetVersionInfo('Release'), 0);
-  _VerInfo.Build := StrToIntDef(GetVersionInfo('Build'), 0);
-
-  _VerInfo.Comments := GetVersionInfoKey('Comments');
-  _VerInfo.CompanyName := GetVersionInfoKey('CompanyName');
-  _VerInfo.FileDescription := GetVersionInfoKey('FileDescription');
-  _VerInfo.FileVersion := GetVersionInfoKey('FileVersion');
-  _VerInfo.InternalName := GetVersionInfoKey('InternalName');
-  _VerInfo.LegalCopyright := GetVersionInfoKey('LegalCopyright');
-  _VerInfo.LegalTrademarks := GetVersionInfoKey('LegalTrademarks');
-  _VerInfo.OriginalFilename := GetVersionInfoKey('OriginalFilename');
-  _VerInfo.ProductName := GetVersionInfoKey('ProductName');
-  _VerInfo.ProductVersion := GetVersionInfoKey('ProductVersion');
-end;
-
-procedure Tdm_DProjVersionInfo.WriteToFile(_VerInfo: TVersionInfo);
-begin
-  SetVersionInfo('AutoIncBuild', IfThen(_VerInfo.AutoIncBuild, 'True', 'False'));
-  SetVersionInfo('Build', IntToStr(_VerInfo.Build));
-  SetVersionInfoKey('Comments', _VerInfo.Comments);
-  SetVersionInfoKey('CompanyName', _VerInfo.CompanyName);
-  SetVersionInfoKey('FileDescription', _VerInfo.FileDescription);
-  SetVersionInfoKey('FileVersion', _VerInfo.FileVersion);
-  SetVersionInfoKey('InternalName', _VerInfo.InternalName);
-  SetVersionInfoKey('LegalCopyright', _VerInfo.LegalCopyright);
-  SetVersionInfoKey('LegalTrademarks', _VerInfo.LegalTrademarks);
-  SetVersionInfo('MajorVer', IntToStr(_VerInfo.MajorVer));
-  SetVersionInfo('MinorVer', IntToStr(_VerInfo.MinorVer));
-  SetVersionInfoKey('OriginalFilename', _VerInfo.OriginalFilename);
-  SetVersionInfoKey('ProductName', _VerInfo.ProductName);
-  SetVersionInfoKey('ProductVersion', _VerInfo.ProductVersion);
-  SetVersionInfo('Release', IntToStr(_VerInfo.Release));
-  ProjDoc.SaveToFile(FXmlFilename);
-end;
-
-procedure Tdm_DProjVersionInfo.SetVersionInfo(const _Name, _Value: string);
-begin
-  SetChildNodeContent(FVersionInfo, 'VersionInfo', _Name, _Value);
-end;
-
-procedure Tdm_DProjVersionInfo.SetVersionInfoKey(const _Name, _Value: string);
-begin
-  SetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name, _Value);
-end;
-
-function Tdm_DProjVersionInfo.VerInfoFilename: string;
-begin
-  Result := FilenameFor(FProjectName);
-end;
-
-// standard TInterfacedObject implementation of IInterface
-
-function Tdm_DProjVersionInfo.QueryInterface(const IID: TGUID; out Obj): HResult;
-begin
-  if GetInterface(IID, Obj) then
-    Result := S_OK
-  else
-    Result := E_NOINTERFACE
-end;
-
-function Tdm_DProjVersionInfo._AddRef: integer;
-begin
-  Result := InterlockedIncrement(FRefCount);
-end;
-
-function Tdm_DProjVersionInfo._Release: integer;
-begin
-  Result := InterlockedDecrement(FRefCount);
-  if Result = 0 then
-    Destroy;
-end;
-
 end.
 

Copied: utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.dfm (from rev 436, utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm)
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.dfm	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.dfm	2010-04-11 15:18:20 UTC (rev 437)
@@ -0,0 +1,10 @@
+object dm_XmlVersionInfo: Tdm_XmlVersionInfo
+  OldCreateOrder = False
+  Height = 150
+  Width = 215
+  object ProjDoc: TXMLDocument
+    Left = 64
+    Top = 40
+    DOMVendorDesc = 'MSXML'
+  end
+end

Copied: utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.pas (from rev 436, utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas)
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas	2010-04-11 15:03:11 UTC (rev 436)
+++ utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.pas	2010-04-11 15:18:20 UTC (rev 437)
@@ -0,0 +1,200 @@
+unit d_XmlVersionInfo;
+
+interface
+
+uses
+  Windows,
+  SysUtils,
+  Classes,
+  xmldom,
+  XMLIntf,
+  msxmldom,
+  XMLDoc,
+  u_VersionInfo,
+  i_VersionInfoAccess;
+
+type
+  Tdm_XmlVersionInfo = class(TDataModule, IVersionInfoAccess)
+    ProjDoc: TXMLDocument;
+  private
+    FProjectName: string;
+    function GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
+    function GetVersionInfo(const _Name: string): string;
+    function GetVersionInfoKey(const _Name: string): string;
+    procedure SetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName, _Value: string);
+    procedure SetVersionInfo(const _Name, _Value: string);
+    procedure SetVersionInfoKey(const _Name, _Value: string);
+  protected // IInterface
+    FRefCount: integer;
+    function QueryInterface(const IID: TGUID; out Obj): HResult; override; stdcall;
+    function _AddRef: integer; stdcall;
+    function _Release: integer; stdcall;
+  protected // implementation of IVersionInfo
+    function VerInfoFilename: string;
+    procedure ReadFromFile(_VerInfo: TVersionInfo);
+    procedure WriteToFile(_VerInfo: TVersionInfo);
+  protected
+    FXmlFilename: string;
+    FVersionInfo: IXMLNode;
+    FVersionInfoKeys: IXMLNode;
+    procedure InitVersionNodes; virtual; abstract;
+  public
+    constructor Create(const _Project: string); reintroduce;
+    destructor Destroy; override;
+    class function FilenameFor(const _Project: string): string; virtual; abstract;
+  end;
+
+implementation
+
+{$R *.dfm}
+
+uses
+  StrUtils,
+  u_dzTranslator;
+
+{ Tdm_XmlVersionInfo }
+
+function Tdm_XmlVersionInfo.GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
+var
+  Node: IXMLNode;
+begin
+  // <VersionInfo Name="IncludeVerInfo">True</VersionInfo>
+  Node := _Parent.ChildNodes.First;
+  while Assigned(Node) do begin
+    if Node.nodeName = _NodeName then begin
+      if SameText(Node.Attributes['Name'], _AttrName) then begin
+        Result := Node.Text;
+        exit;
+      end;
+    end;
+    Node := Node.nextSibling;
+  end;
+end;
+
+function Tdm_XmlVersionInfo.GetVersionInfo(const _Name: string): string;
+begin
+  Result := GetChildNodeContent(FVersionInfo, 'VersionInfo', _Name);
+end;
+
+function Tdm_XmlVersionInfo.GetVersionInfoKey(const _Name: string): string;
+begin
+  Result := GetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name);
+end;
+
+procedure Tdm_XmlVersionInfo.SetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName, _Value: string);
+var
+  Node: IXMLNode;
+begin
+  // <*NodeName* Name="*AttrName*">*Value*</VersionInfo>
+  Node := _Parent.ChildNodes.First;
+  while Assigned(Node) do begin
+    if Node.nodeName = _NodeName then begin
+      if SameText(Node.Attributes['Name'], _AttrName) then begin
+        Node.Text := _Value;
+        exit;
+      end;
+    end;
+    Node := Node.nextSibling;
+  end;
+end;
+
+constructor Tdm_XmlVersionInfo.Create(const _Project: string);
+begin
+  inherited Create(nil);
+  FProjectName := _Project;
+  FXmlFilename := VerInfoFilename;
+  ProjDoc.FileName := FXmlFilename;
+  ProjDoc.Active := True;
+
+  InitVersionNodes;
+
+  if not SameText(GetChildNodeContent(FVersionInfo, 'VersionInfo', 'IncludeVerInfo'), 'True') then
+    raise ENoVersionInfo.Create(_('.dproj file does not contain version information'));
+end;
+
+destructor Tdm_XmlVersionInfo.Destroy;
+begin
+  FVersionInfo := nil;
+  inherited;
+end;
+
+procedure Tdm_XmlVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
+begin
+  _VerInfo.AutoIncBuild := SameText(GetVersionInfo('AutoIncBuild'), 'True');
+
+  _VerInfo.MajorVer := StrToIntDef(GetVersionInfo('MajorVer'), 0);
+  _VerInfo.MinorVer := StrToIntDef(GetVersionInfo('MinorVer'), 0);
+  _VerInfo.Release := StrToIntDef(GetVersionInfo('Release'), 0);
+  _VerInfo.Build := StrToIntDef(GetVersionInfo('Build'), 0);
+
+  _VerInfo.Comments := GetVersionInfoKey('Comments');
+  _VerInfo.CompanyName := GetVersionInfoKey('CompanyName');
+  _VerInfo.FileDescription := GetVersionInfoKey('FileDescription');
+  _VerInfo.FileVersion := GetVersionInfoKey('FileVersion');
+  _VerInfo.InternalName := GetVersionInfoKey('InternalName');
+  _VerInfo.LegalCopyright := GetVersionInfoKey('LegalCopyright');
+  _VerInfo.LegalTrademarks := GetVersionInfoKey('LegalTrademarks');
+  _VerInfo.OriginalFilename := GetVersionInfoKey('OriginalFilename');
+  _VerInfo.ProductName := GetVersionInfoKey('ProductName');
+  _VerInfo.ProductVersion := GetVersionInfoKey('ProductVersion');
+end;
+
+procedure Tdm_XmlVersionInfo.WriteToFile(_VerInfo: TVersionInfo);
+begin
+  SetVersionInfo('AutoIncBuild', IfThen(_VerInfo.AutoIncBuild, 'True', 'False'));
+  SetVersionInfo('Build', IntToStr(_VerInfo.Build));
+  SetVersionInfoKey('Comments', _VerInfo.Comments);
+  SetVersionInfoKey('CompanyName', _VerInfo.CompanyName);
+  SetVersionInfoKey('FileDescription', _VerInfo.FileDescription);
+  SetVersionInfoKey('FileVersion', _VerInfo.FileVersion);
+  SetVersionInfoKey('InternalName', _VerInfo.InternalName);
+  SetVersionInfoKey('LegalCopyright', _VerInfo.LegalCopyright);
+  SetVersionInfoKey('LegalTrademarks', _VerInfo.LegalTrademarks);
+  SetVersionInfo('MajorVer', IntToStr(_VerInfo.MajorVer));
+  SetVersionInfo('MinorVer', IntToStr(_VerInfo.MinorVer));
+  SetVersionInfoKey('OriginalFilename', _VerInfo.OriginalFilename);
+  SetVersionInfoKey('ProductName', _VerInfo.ProductName);
+  SetVersionInfoKey('ProductVersion', _VerInfo.ProductVersion);
+  SetVersionInfo('Release', IntToStr(_VerInfo.Release));
+  ProjDoc.SaveToFile(FXmlFilename);
+end;
+
+procedure Tdm_XmlVersionInfo.SetVersionInfo(const _Name, _Value: string);
+begin
+  SetChildNodeContent(FVersionInfo, 'VersionInfo', _Name, _Value);
+end;
+
+procedure Tdm_XmlVersionInfo.SetVersionInfoKey(const _Name, _Value: string);
+begin
+  SetChildNodeContent(FVersionInfoKeys, 'VersionInfoKeys', _Name, _Value);
+end;
+
+function Tdm_XmlVersionInfo.VerInfoFilename: string;
+begin
+  Result := FilenameFor(FProjectName);
+end;
+
+// standard TInterfacedObject implementation of IInterface
+
+function Tdm_XmlVersionInfo.QueryInterface(const IID: TGUID; out Obj): HResult;
+begin
+  if GetInterface(IID, Obj) then
+    Result := S_OK
+  else
+    Result := E_NOINTERFACE
+end;
+
+function Tdm_XmlVersionInfo._AddRef: integer;
+begin
+  Result := InterlockedIncrement(FRefCount);
+end;
+
+function Tdm_XmlVersionInfo._Release: integer;
+begin
+  Result := InterlockedDecrement(FRefCount);
+  if Result = 0 then
+    Destroy;
+end;
+
+end.
+



From twm at mail.berlios.de  Sun Apr 11 17:22:43 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 17:22:43 +0200
Subject: [Dzchart-svncheckins] r438 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111522.o3BFMhir025836@sheep.berlios.de>

Author: twm
Date: 2010-04-11 17:22:41 +0200 (Sun, 11 Apr 2010)
New Revision: 438

Modified:
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
Log:
* Updating .dproj files now works
* It is again possible to update mulitple files

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 15:18:20 UTC (rev 437)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 15:22:41 UTC (rev 438)
@@ -37,7 +37,7 @@
     <Borland.Personality>Delphi.Personality</Borland.Personality>
     <Borland.ProjectType />
     <BorlandProject>
-<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readdproj=testdata\testproject --updateini=testdata\testproject</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
+<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readdproj=testdata\testproject --updatedproj=testdata\testproject</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dclofficexp100.bpl">Microsoft Office XP Sample Automation Server Wrapper Components</Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dcloffice2k100.bpl">Microsoft Office 2000 Sample Automation Server Wrapper Components</Excluded_Packages>
     </Excluded_Packages><Source><Source Name="MainSource">PrepBuild.dpr</Source></Source><VersionInfoKeys><VersionInfoKeys Name="CompanyName"></VersionInfoKeys><VersionInfoKeys Name="FileDescription"></VersionInfoKeys><VersionInfoKeys Name="FileVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="InternalName"></VersionInfoKeys><VersionInfoKeys Name="LegalCopyright"></VersionInfoKeys><VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys><VersionInfoKeys Name="OriginalFilename"></VersionInfoKeys><VersionInfoKeys Name="ProductName"></VersionInfoKeys><VersionInfoKeys Name="ProductVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="Comments"></VersionInfoKeys></VersionInfoKeys></Delphi.Personality><ModelSupport>False</ModelSupport></BorlandProject></BorlandProject>

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:18:20 UTC (rev 437)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:22:41 UTC (rev 438)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=236
-FileVersion=1.2.0.236
+Build=238
+FileVersion=1.2.0.238
 

Modified: utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 15:18:20 UTC (rev 437)
+++ utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 15:22:41 UTC (rev 438)
@@ -274,18 +274,24 @@
 
     VersionInfo.UpdateFileVersion;
 
-    if FGetOpt.OptionPassed('UpdateDof', Param) then
+    if FGetOpt.OptionPassed('UpdateDof', Param) then begin
       VerInfoAccess := TDofVersionInfo.Create(Param);
+      VerInfoAccess.WriteToFile(VersionInfo);
+    end;
 
-    if FGetOpt.OptionPassed('UpdateBdsproj', Param) then
+    if FGetOpt.OptionPassed('UpdateBdsproj', Param) then begin
       VerInfoAccess := Tdm_BdsProjVersionInfo.Create(Param);
+      VerInfoAccess.WriteToFile(VersionInfo);
+    end;
 
-    if FGetOpt.OptionPassed('UpdateIni', Param) then
+    if FGetOpt.OptionPassed('UpdateIni', Param) then begin
       VerInfoAccess := TCentralVersionInfo.Create(Param);
+      VerInfoAccess.WriteToFile(VersionInfo);
+    end;
 
-    if Assigned(VerInfoAccess) then begin
+    if FGetOpt.OptionPassed('UpdateDproj', Param) then begin
+      VerInfoAccess := Tdm_DprojVersionInfo.Create(Param);
       VerInfoAccess.WriteToFile(VersionInfo);
-      VerInfoAccess := nil;
     end;
 
     if not FGetOpt.OptionPassed('Icon', IconFile) then
@@ -316,6 +322,7 @@
   FGetOpt.RegisterOption('UpdateDof', _('update a .dof file with the version information'), true);
   FGetOpt.RegisterOption('UpdateBdsproj', _('update a .bdsproj file with the version information'), true);
   FGetOpt.RegisterOption('UpdateIni', _('update a .ini file with the version information'), true);
+  FGetOpt.RegisterOption('UpdateDproj', _('update a .dproj file with the version information'), true);
   FGetOpt.RegisterOption('WriteRc', _('write version info to a .rc file'), true);
   FGetOpt.RegisterOption('Icon', _('Assign an icon file to add to the .rc file'), true);
   FGetOpt.RegisterOption('IncBuild', _('increment the build number'), false);



From twm at mail.berlios.de  Sun Apr 11 17:33:59 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 17:33:59 +0200
Subject: [Dzchart-svncheckins] r439 - utilities/dzPrepBuild/trunk/src
Message-ID: <201004111533.o3BFXxO9027033@sheep.berlios.de>

Author: twm
Date: 2010-04-11 17:33:57 +0200 (Sun, 11 Apr 2010)
New Revision: 439

Modified:
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
Log:
new options --ProductVersionToDate and --ProductVersionToDateTime


Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:22:41 UTC (rev 438)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:33:57 UTC (rev 439)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=238
-FileVersion=1.2.0.238
+Build=244
+FileVersion=1.2.0.244
 

Modified: utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 15:22:41 UTC (rev 438)
+++ utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 15:33:57 UTC (rev 439)
@@ -180,6 +180,7 @@
   IntValue: integer;
   IconFile: string;
   Project: string;
+  dt: TDateTime;
 begin
   WriteLn('dzPrepBuild version ' + TApplication_GetFileVersion + ' built ' + TApplication_GetProductVersion);
 
@@ -220,25 +221,25 @@
 
     if FGetOpt.OptionPassed('MajorVer', Param) then begin
       if not TryStrToInt(Param, IntValue) then
-        raise Exception.Create(_('Parameter to MajorVer must be a number'));
+        raise Exception.Create(_('Parameter for MajorVer must be a number'));
       VersionInfo.MajorVer := IntValue;
     end;
 
     if FGetOpt.OptionPassed('MinorVer', Param) then begin
       if not TryStrToInt(Param, IntValue) then
-        raise Exception.Create(_('Parameter to MinorVer must be a number'));
+        raise Exception.Create(_('Parameter for MinorVer must be a number'));
       VersionInfo.MinorVer := IntValue;
     end;
 
     if FGetOpt.OptionPassed('Release', Param) then begin
       if not TryStrToInt(Param, IntValue) then
-        raise Exception.Create(_('Parameter to Release must be a number'));
+        raise Exception.Create(_('Parameter for Release must be a number'));
       VersionInfo.Release := IntValue;
     end;
 
     if FGetOpt.OptionPassed('Build', Param) then begin
       if not TryStrToInt(Param, IntValue) then
-        raise Exception.Create(_('Parameter to Build must be a number'));
+        raise Exception.Create(_('Parameter for Build must be a number'));
       VersionInfo.Build := IntValue;
     end;
 
@@ -257,6 +258,13 @@
     if FGetOpt.OptionPassed('ProductVersion', Param) then
       VersionInfo.ProductVersion := UnquoteStr(Param);
 
+    dt := Now;
+    if FGetOpt.OptionPassed('ProductVersionToDate') then
+      VersionInfo.ProductVersion := DateTimeToString('yyyy-mm-dd', dt);
+
+    if FGetOpt.OptionPassed('ProductVersionToDateTime') then
+      VersionInfo.ProductVersion := DateTimeToString('yyyy-mm-dd hh:nn:ss', dt);
+
     if FGetOpt.OptionPassed('Company', Param) then
       VersionInfo.CompanyName := UnquoteStr(Param);
 
@@ -314,31 +322,41 @@
 begin
   inherited;
   FGetOpt.RegisterOption('dumpcmd', _('dump the commandline and exit (for debug purposes)'), false);
+
   FGetOpt.RegisterOption('ReadDof', _('read a .dof file to get the version information'), true);
   FGetOpt.RegisterOption('ReadBdsproj', _('read a .bdsproj file to get the version information'), true);
   FGetOpt.RegisterOption('ReadIni', _('read a .ini file to get the version information'), true);
   FGetOpt.RegisterOption('ReadDproj', _('Read a .dproj file to get the version information'), true);
-  FGetOpt.RegisterOption('Exec', _('execute the given program or script with extended environment'), true);
-  FGetOpt.RegisterOption('UpdateDof', _('update a .dof file with the version information'), true);
-  FGetOpt.RegisterOption('UpdateBdsproj', _('update a .bdsproj file with the version information'), true);
-  FGetOpt.RegisterOption('UpdateIni', _('update a .ini file with the version information'), true);
-  FGetOpt.RegisterOption('UpdateDproj', _('update a .dproj file with the version information'), true);
-  FGetOpt.RegisterOption('WriteRc', _('write version info to a .rc file'), true);
-  FGetOpt.RegisterOption('Icon', _('Assign an icon file to add to the .rc file'), true);
-  FGetOpt.RegisterOption('IncBuild', _('increment the build number'), false);
+
   FGetOpt.RegisterOption('MajorVer', _('set the major version number (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('MinorVer', _('set the minor version number (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Release', _('set the release number (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Build', _('set the build number (overwrites value from -ReadXxx option)'), true);
+
   FGetOpt.RegisterOption('FileDesc', _('set the file description (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('InternalName', _('set the internal name (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('OriginalName', _('set the original file name (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Product', _('set the product name (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('ProductVersion', _('set the product version (overwrites value from -ReadXxx option)'), true);
+  FGetOpt.RegisterOption('ProductVersionToDate', _('set the proodcut version to the current date  (overwrites value from -ReadXxx and ProductVersion option)'), false);
+  FGetOpt.RegisterOption('ProductVersionToDateTime', _('set the proodcut version to the current date and time (overwrites value from -ReadXxx and ProductVersion option)'), false);
   FGetOpt.RegisterOption('Company', _('set the company name (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Copyright', _('set the legal copyright (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Trademark', _('set the legal trademark (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Comments', _('set the comments (overwrites value from -ReadXxx option)'), true);
+
+  FGetOpt.RegisterOption('IncBuild', _('increment the build number'), false);
+
+  FGetOpt.RegisterOption('UpdateDof', _('update a .dof file with the version information'), true);
+  FGetOpt.RegisterOption('UpdateBdsproj', _('update a .bdsproj file with the version information'), true);
+  FGetOpt.RegisterOption('UpdateIni', _('update a .ini file with the version information'), true);
+  FGetOpt.RegisterOption('UpdateDproj', _('update a .dproj file with the version information'), true);
+
+  FGetOpt.RegisterOption('Icon', _('Assign an icon file to add to the .rc file'), true);
+
+  FGetOpt.RegisterOption('WriteRc', _('write version info to a .rc file'), true);
+
+  FGetOpt.RegisterOption('Exec', _('execute the given program or script with extended environment'), true);
 end;
 
 initialization



From twm at mail.berlios.de  Sun Apr 11 17:54:03 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 17:54:03 +0200
Subject: [Dzchart-svncheckins] r440 - in utilities/dzPrepBuild/trunk:
	buildtools src
Message-ID: <201004111554.o3BFs3LH028775@sheep.berlios.de>

Author: twm
Date: 2010-04-11 17:53:56 +0200 (Sun, 11 Apr 2010)
New Revision: 440

Modified:
   utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
   utilities/dzPrepBuild/trunk/buildtools/prep.cmd
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/i_VersionInfoAccess.pas
   utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
Log:
* got rid of the additional call to prepbuild in prep.cmd due to --ProductVersionToDate option
* added some output for what the program actually does for debug purposes

Modified: utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
===================================================================
(Binary files differ)

Modified: utilities/dzPrepBuild/trunk/buildtools/prep.cmd
===================================================================
--- utilities/dzPrepBuild/trunk/buildtools/prep.cmd	2010-04-11 15:33:57 UTC (rev 439)
+++ utilities/dzPrepBuild/trunk/buildtools/prep.cmd	2010-04-11 15:53:56 UTC (rev 440)
@@ -1,3 +1,2 @@
 @echo on
-%~dp0\PrepBuild --writerc=%dzProject%_Version.rc --updateini=%dzProject% --MajorVer=%dzVersion.MajorVer% --MinorVer=%dzVersion.MinorVer% --Release=%dzVersion.Release% --Build=%dzVersion.Build% --FileDesc="%dzVersion.FileDesc%" --InternalName="%dzVersion.InternalName%" --OriginalName="%dzVersion.OriginalName%" --Product="%dzVersion.Product%" --ProductVersion="%dzDate%" --Company="%dzVersion.Company%" --Copyright="%dzVersion.Copyright%" --Trademark="%dzVersion.Trademark%" --Comments="%dzVersion.Comments%"
 brcc32 %dzProject%_Version.rc

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 15:33:57 UTC (rev 439)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 15:53:56 UTC (rev 440)
@@ -45,7 +45,7 @@
   <Import Project="$(MSBuildBinPath)\Borland.Delphi.Targets" />
   <PropertyGroup>
     <PreBuildEvent>subwcrev .. SVN_Version_template.ini SVN_Version.ini
-..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
+..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --updateini=$(PROJECTPATH)  --productversiontodate --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
   </PropertyGroup>
   <ItemGroup>
     <DelphiCompile Include="PrepBuild.dpr">

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:33:57 UTC (rev 439)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 15:53:56 UTC (rev 440)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=244
-FileVersion=1.2.0.244
+Build=253
+FileVersion=1.2.0.253
 

Modified: utilities/dzPrepBuild/trunk/src/i_VersionInfoAccess.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/i_VersionInfoAccess.pas	2010-04-11 15:33:57 UTC (rev 439)
+++ utilities/dzPrepBuild/trunk/src/i_VersionInfoAccess.pas	2010-04-11 15:53:56 UTC (rev 440)
@@ -11,6 +11,7 @@
 
 type
   IVersionInfoAccess = interface ['{57B36255-0A4B-4F62-9007-B4D211C2185D}']
+    function VerInfoFilename: string;
     procedure ReadFromFile(_VerInfo: TVersionInfo);
     procedure WriteToFile(_VerInfo: TVersionInfo);
   end;

Modified: utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 15:33:57 UTC (rev 439)
+++ utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 15:53:56 UTC (rev 440)
@@ -215,6 +215,7 @@
   VersionInfo := TVersionInfo.Create;
   try
     if Assigned(VerInfoAccess) then begin
+      WriteLn('Reading ' + VerInfoAccess.VerInfoFilename);
       VerInfoAccess.ReadFromFile(VersionInfo);
       VerInfoAccess := nil;
     end;
@@ -222,94 +223,134 @@
     if FGetOpt.OptionPassed('MajorVer', Param) then begin
       if not TryStrToInt(Param, IntValue) then
         raise Exception.Create(_('Parameter for MajorVer must be a number'));
+      WriteLn('Setting MajorVer to ', IntValue);
       VersionInfo.MajorVer := IntValue;
     end;
 
     if FGetOpt.OptionPassed('MinorVer', Param) then begin
       if not TryStrToInt(Param, IntValue) then
         raise Exception.Create(_('Parameter for MinorVer must be a number'));
+      WriteLn('Setting MinorVer to ', IntValue);
       VersionInfo.MinorVer := IntValue;
     end;
 
     if FGetOpt.OptionPassed('Release', Param) then begin
       if not TryStrToInt(Param, IntValue) then
         raise Exception.Create(_('Parameter for Release must be a number'));
+      WriteLn('Setting Release to ', IntValue);
       VersionInfo.Release := IntValue;
     end;
 
     if FGetOpt.OptionPassed('Build', Param) then begin
       if not TryStrToInt(Param, IntValue) then
         raise Exception.Create(_('Parameter for Build must be a number'));
+      WriteLn('Setting Build to ', IntValue);
       VersionInfo.Build := IntValue;
     end;
 
-    if FGetOpt.OptionPassed('FileDesc', Param) then
+    if FGetOpt.OptionPassed('FileDesc', Param) then begin
       VersionInfo.FileDescription := UnquoteStr(Param);
+      WriteLn('Setting FileDescription to ', VersionInfo.FileDescription);
+    end;
 
-    if FGetOpt.OptionPassed('InternalName', Param) then
+    if FGetOpt.OptionPassed('InternalName', Param) then begin
       VersionInfo.InternalName := UnquoteStr(Param);
+      WriteLn('Setting InternalName to ', VersionInfo.InternalName);
+    end;
 
-    if FGetOpt.OptionPassed('OriginalName', Param) then
+    if FGetOpt.OptionPassed('OriginalName', Param) then begin
       VersionInfo.OriginalFilename := UnquoteStr(Param);
+      WriteLn('Setting OriginalFilename to ', VersionInfo.OriginalFilename);
+    end;
 
-    if FGetOpt.OptionPassed('Product', Param) then
+    if FGetOpt.OptionPassed('Product', Param) then begin
       VersionInfo.ProductName := UnquoteStr(Param);
+      WriteLn('Setting ProductName to ', VersionInfo.ProductName);
+    end;
 
-    if FGetOpt.OptionPassed('ProductVersion', Param) then
+    if FGetOpt.OptionPassed('ProductVersion', Param) then begin
       VersionInfo.ProductVersion := UnquoteStr(Param);
+      WriteLn('Setting ProductVersion to ', VersionInfo.ProductVersion);
+    end;
 
     dt := Now;
-    if FGetOpt.OptionPassed('ProductVersionToDate') then
+    if FGetOpt.OptionPassed('ProductVersionToDate') then begin
       VersionInfo.ProductVersion := DateTimeToString('yyyy-mm-dd', dt);
+      WriteLn('Setting ProductVersion to ', VersionInfo.ProductVersion);
+    end;
 
-    if FGetOpt.OptionPassed('ProductVersionToDateTime') then
+    if FGetOpt.OptionPassed('ProductVersionToDateTime') then begin
       VersionInfo.ProductVersion := DateTimeToString('yyyy-mm-dd hh:nn:ss', dt);
+      WriteLn('Setting ProductVersion to ', VersionInfo.ProductVersion);
+    end;
 
-    if FGetOpt.OptionPassed('Company', Param) then
+    if FGetOpt.OptionPassed('Company', Param) then begin
       VersionInfo.CompanyName := UnquoteStr(Param);
+      WriteLn('Setting CompanyName to ', VersionInfo.CompanyName);
+    end;
 
-    if FGetOpt.OptionPassed('Copyright', Param) then
+    if FGetOpt.OptionPassed('Copyright', Param) then begin
       VersionInfo.LegalCopyright := UnquoteStr(Param);
+      WriteLn('Setting LegalCopyright to ', VersionInfo.LegalCopyright);
+    end;
 
-    if FGetOpt.OptionPassed('Trademark', Param) then
+    if FGetOpt.OptionPassed('Trademark', Param) then begin
       VersionInfo.LegalTrademarks := UnquoteStr(Param);
+      WriteLn('Setting LegalTrademarks to ', VersionInfo.LegalTrademarks);
+    end;
 
-    if FGetOpt.OptionPassed('Comments', Param) then
+    if FGetOpt.OptionPassed('Comments', Param) then begin
       VersionInfo.Comments := UnquoteStr(Param);
+      WriteLn('Setting Comments to ', VersionInfo.Comments);
+    end;
 
-    if FGetOpt.OptionPassed('IncBuild') then
+    if FGetOpt.OptionPassed('IncBuild') then begin
       VersionInfo.Build := VersionInfo.Build + 1;
+      WriteLn('Incrementing build number to ', VersionInfo.Build);
+    end;
 
     VersionInfo.UpdateFileVersion;
+    WriteLn('FileVersion is now ', VersionInfo.FileVersion);
 
     if FGetOpt.OptionPassed('UpdateDof', Param) then begin
       VerInfoAccess := TDofVersionInfo.Create(Param);
+      WriteLn('Updating ', VerInfoAccess.VerInfoFilename);
       VerInfoAccess.WriteToFile(VersionInfo);
     end;
 
     if FGetOpt.OptionPassed('UpdateBdsproj', Param) then begin
       VerInfoAccess := Tdm_BdsProjVersionInfo.Create(Param);
+      WriteLn('Updating ', VerInfoAccess.VerInfoFilename);
       VerInfoAccess.WriteToFile(VersionInfo);
     end;
 
     if FGetOpt.OptionPassed('UpdateIni', Param) then begin
       VerInfoAccess := TCentralVersionInfo.Create(Param);
+      WriteLn('Updating ', VerInfoAccess.VerInfoFilename);
       VerInfoAccess.WriteToFile(VersionInfo);
     end;
 
     if FGetOpt.OptionPassed('UpdateDproj', Param) then begin
       VerInfoAccess := Tdm_DprojVersionInfo.Create(Param);
+      WriteLn('Updating ', VerInfoAccess.VerInfoFilename);
       VerInfoAccess.WriteToFile(VersionInfo);
     end;
 
-    if not FGetOpt.OptionPassed('Icon', IconFile) then
+    if FGetOpt.OptionPassed('Icon', IconFile) then
+      WriteLn('Adding icon to rcfile from ', IconFile)
+    else
       IconFile := '';
 
-    if FGetOpt.OptionPassed('WriteRc', Param) then
+    if FGetOpt.OptionPassed('WriteRc', Param) then begin
+      WriteLn('Writing rc file ', Param);
       WriteRcFile(Param, VersionInfo, IconFile);
+    end;
 
-    if FGetOpt.OptionPassed('Exec', Param) then
+    if FGetOpt.OptionPassed('Exec', Param) then begin
+      WriteLn('Executing ', Param);
+      Flush(Output);
       HandleExecOption(Param, VersionInfo, Project);
+    end;
 
   finally
     FreeAndNil(VersionInfo);



From twm at mail.berlios.de  Sun Apr 11 18:24:40 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 18:24:40 +0200
Subject: [Dzchart-svncheckins] r441 - utilities/dzLib/trunk/src
Message-ID: <201004111624.o3BGOeOt030652@sheep.berlios.de>

Author: twm
Date: 2010-04-11 18:24:39 +0200 (Sun, 11 Apr 2010)
New Revision: 441

Modified:
   utilities/dzLib/trunk/src/u_dzJclUtils.pas
Log:
Bugfix: if there is no version info, do not throw an exception but rather return "<no version/product/product version>"

Modified: utilities/dzLib/trunk/src/u_dzJclUtils.pas
===================================================================
--- utilities/dzLib/trunk/src/u_dzJclUtils.pas	2010-04-11 15:53:56 UTC (rev 440)
+++ utilities/dzLib/trunk/src/u_dzJclUtils.pas	2010-04-11 16:24:39 UTC (rev 441)
@@ -166,11 +166,15 @@
 var
   VersionInfo: TJclFileVersionInfo;
 begin
-  VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
   try
-    Result := VersionInfo.FileVersion;
-  finally
-    FreeAndNil(VersionInfo);
+    VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
+    try
+      Result := VersionInfo.FileVersion;
+    finally
+      FreeAndNil(VersionInfo);
+    end;
+  except
+    Result := '<no version>';
   end;
 end;
 
@@ -178,11 +182,15 @@
 var
   VersionInfo: TJclFileVersionInfo;
 begin
-  VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
   try
-    Result := VersionInfo.ProductName;
-  finally
-    FreeAndNil(VersionInfo);
+    VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
+    try
+      Result := VersionInfo.ProductName;
+    finally
+      FreeAndNil(VersionInfo);
+    end;
+  except
+    Result := '<no product>';
   end;
 end;
 
@@ -190,11 +198,15 @@
 var
   VersionInfo: TJclFileVersionInfo;
 begin
-  VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
   try
-    Result := VersionInfo.ProductVersion;
-  finally
-    FreeAndNil(VersionInfo);
+    VersionInfo := TJclFileVersionInfo.Create(Application.ExeName);
+    try
+      Result := VersionInfo.ProductVersion;
+    finally
+      FreeAndNil(VersionInfo);
+    end;
+  except
+    Result := '<no product version>';
   end;
 end;
 



From twm at mail.berlios.de  Sun Apr 11 18:28:43 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 18:28:43 +0200
Subject: [Dzchart-svncheckins] r442 - in utilities/dzPrepBuild/trunk:
	buildtools src
Message-ID: <201004111628.o3BGShjR030958@sheep.berlios.de>

Author: twm
Date: 2010-04-11 18:28:38 +0200 (Sun, 11 Apr 2010)
New Revision: 442

Modified:
   utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
Log:
* Bugfix: forgot to create the .rc file in the pre-build event
* automatically add '_Version.rc' to the output filename (without extension)


Modified: utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
===================================================================
(Binary files differ)

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 16:24:39 UTC (rev 441)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 16:28:38 UTC (rev 442)
@@ -37,7 +37,7 @@
     <Borland.Personality>Delphi.Personality</Borland.Personality>
     <Borland.ProjectType />
     <BorlandProject>
-<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readdproj=testdata\testproject --updatedproj=testdata\testproject</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></VersionInfo><Excluded_Packages>
+<BorlandProject><Delphi.Personality><Parameters><Parameters Name="UseLauncher">False</Parameters><Parameters Name="LoadAllSymbols">True</Parameters><Parameters Name="LoadUnspecifiedSymbols">False</Parameters><Parameters Name="RunParams">--incbuild --readini=testdata\testproject --updateini=testdata\testproject --writerc=testdata\testproject</Parameters></Parameters><VersionInfo><VersionInfo Name="IncludeVerInfo">False</VersionInfo><VersionInfo Name="AutoIncBuild">False</VersionInfo><VersionInfo Name="MajorVer">1</VersionInfo><VersionInfo Name="MinorVer">0</VersionInfo><VersionInfo Name="Release">0</VersionInfo><VersionInfo Name="Build">0</VersionInfo><VersionInfo Name="Debug">False</VersionInfo><VersionInfo Name="PreRelease">False</VersionInfo><VersionInfo Name="Special">False</VersionInfo><VersionInfo Name="Private">False</VersionInfo><VersionInfo Name="DLL">False</VersionInfo><VersionInfo Name="Locale">2057</VersionInfo><VersionInfo Name="CodePage">1252</VersionInfo></Ver!
 sionInfo><Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dclofficexp100.bpl">Microsoft Office XP Sample Automation Server Wrapper Components</Excluded_Packages>
       <Excluded_Packages Name="$(BDS)\bin\dcloffice2k100.bpl">Microsoft Office 2000 Sample Automation Server Wrapper Components</Excluded_Packages>
     </Excluded_Packages><Source><Source Name="MainSource">PrepBuild.dpr</Source></Source><VersionInfoKeys><VersionInfoKeys Name="CompanyName"></VersionInfoKeys><VersionInfoKeys Name="FileDescription"></VersionInfoKeys><VersionInfoKeys Name="FileVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="InternalName"></VersionInfoKeys><VersionInfoKeys Name="LegalCopyright"></VersionInfoKeys><VersionInfoKeys Name="LegalTrademarks"></VersionInfoKeys><VersionInfoKeys Name="OriginalFilename"></VersionInfoKeys><VersionInfoKeys Name="ProductName"></VersionInfoKeys><VersionInfoKeys Name="ProductVersion">1.0.0.0</VersionInfoKeys><VersionInfoKeys Name="Comments"></VersionInfoKeys></VersionInfoKeys></Delphi.Personality><ModelSupport>False</ModelSupport></BorlandProject></BorlandProject>
@@ -45,7 +45,7 @@
   <Import Project="$(MSBuildBinPath)\Borland.Delphi.Targets" />
   <PropertyGroup>
     <PreBuildEvent>subwcrev .. SVN_Version_template.ini SVN_Version.ini
-..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --updateini=$(PROJECTPATH)  --productversiontodate --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
+..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --updateini=$(PROJECTPATH)  --productversiontodate --WriteRc=$(PROJECTPATH) --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
   </PropertyGroup>
   <ItemGroup>
     <DelphiCompile Include="PrepBuild.dpr">

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 16:24:39 UTC (rev 441)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 16:28:38 UTC (rev 442)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=253
-FileVersion=1.2.0.253
+Build=270
+FileVersion=1.2.0.270
 

Modified: utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 16:24:39 UTC (rev 441)
+++ utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 16:28:38 UTC (rev 442)
@@ -46,9 +46,12 @@
 
 procedure TPrepBuildMain.WriteRcFile(const _Project: string; _VersionInfo: TVersionInfo; const _Icon: string);
 var
+  fn: string;
   t: TextFile;
 begin
-  Assignfile(t, ChangeFileExt(_Project, '.rc'));
+  fn := ChangeFileExt(_Project, '_Version.rc');
+  WriteLn('Writing rc file ', fn);
+  Assignfile(t, fn);
   Rewrite(t);
   try
     WriteLn(t, {    } 'LANGUAGE LANG_ENGLISH,SUBLANG_ENGLISH_US');
@@ -342,7 +345,6 @@
       IconFile := '';
 
     if FGetOpt.OptionPassed('WriteRc', Param) then begin
-      WriteLn('Writing rc file ', Param);
       WriteRcFile(Param, VersionInfo, IconFile);
     end;
 



From twm at mail.berlios.de  Sun Apr 11 18:57:21 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 18:57:21 +0200
Subject: [Dzchart-svncheckins] r444 - 3rd/jcl/0.952
Message-ID: <201004111657.o3BGvL5A018265@sheep.berlios.de>

Author: twm
Date: 2010-04-11 18:57:20 +0200 (Sun, 11 Apr 2010)
New Revision: 444

Added:
   3rd/jcl/0.952/tags/
Log:




From twm at mail.berlios.de  Sun Apr 11 18:57:44 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 18:57:44 +0200
Subject: [Dzchart-svncheckins] r445 - 3rd/jcl/0.952/tags
Message-ID: <201004111657.o3BGviDG019920@sheep.berlios.de>

Author: twm
Date: 2010-04-11 18:57:42 +0200 (Sun, 11 Apr 2010)
New Revision: 445

Added:
   3rd/jcl/0.952/tags/1/
Log:


Copied: 3rd/jcl/0.952/tags/1 (from rev 444, 3rd/jcl/0.952/trunk)



From twm at mail.berlios.de  Sun Apr 11 18:58:41 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 18:58:41 +0200
Subject: [Dzchart-svncheckins] r446 - 3rd
Message-ID: <201004111658.o3BGwfbv023766@sheep.berlios.de>

Author: twm
Date: 2010-04-11 18:58:40 +0200 (Sun, 11 Apr 2010)
New Revision: 446

Added:
   3rd/tregexpr/
Log:




From twm at mail.berlios.de  Sun Apr 11 18:59:11 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 18:59:11 +0200
Subject: [Dzchart-svncheckins] r447 - in 3rd: jcl tregexpr
Message-ID: <201004111659.o3BGxBGd026293@sheep.berlios.de>

Author: twm
Date: 2010-04-11 18:59:10 +0200 (Sun, 11 Apr 2010)
New Revision: 447

Added:
   3rd/tregexpr/0.952/
Removed:
   3rd/jcl/0.952/
Log:


Copied: 3rd/tregexpr/0.952 (from rev 446, 3rd/jcl/0.952)



From twm at mail.berlios.de  Sun Apr 11 20:12:15 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 20:12:15 +0200
Subject: [Dzchart-svncheckins] r448 - 3rd/tregexpr/0.952/tags/1/Help
Message-ID: <201004111812.o3BICFnX003541@sheep.berlios.de>

Author: twm
Date: 2010-04-11 20:12:14 +0200 (Sun, 11 Apr 2010)
New Revision: 448

Modified:
   3rd/tregexpr/0.952/tags/1/Help/
Log:



Property changes on: 3rd/tregexpr/0.952/tags/1/Help
___________________________________________________________________
Name: svn:ignore
   + TRegExpr.GID




From twm at mail.berlios.de  Sun Apr 11 20:18:47 2010
From: twm at mail.berlios.de (twm at mail.berlios.de)
Date: Sun, 11 Apr 2010 20:18:47 +0200
Subject: [Dzchart-svncheckins] r449 - in utilities/dzPrepBuild/trunk: .
	buildtools src testdata
Message-ID: <201004111818.o3BIIlol003983@sheep.berlios.de>

Author: twm
Date: 2010-04-11 20:18:29 +0200 (Sun, 11 Apr 2010)
New Revision: 449

Added:
   utilities/dzPrepBuild/trunk/testdata/SVN_Version.ini
Modified:
   utilities/dzPrepBuild/trunk/
   utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
   utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
   utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
   utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
   utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
   utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_CentralIniVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas
   utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
   utilities/dzPrepBuild/trunk/src/u_VersionInfo.pas
   utilities/dzPrepBuild/trunk/testdata/OriginalTestproject_Version.ini
Log:
* added support for variables {read:<IniFileDescriptor>}, {thisyear}, {today}, {now}
* removed switches --ProductVersionToDate and --ProductVersionToDateTime again, since they can be replaced with the new variables



Property changes on: utilities/dzPrepBuild/trunk
___________________________________________________________________
Name: svn:ignore
   - __history
dcu
IncBuildNo.cfg
IncBuildNo.exe
IncBuildNo.res
PrepBuild.exe
PrepBuild.res
PrepBuild.dsk
testproject.rc

   + __history
dcu
IncBuildNo.cfg
IncBuildNo.exe
IncBuildNo.res
PrepBuild.exe
PrepBuild.res
PrepBuild.dsk
testproject.rc
PrepBuild.dpr.lnk

Name: svn:externals
   - libs/dzlib https://svn.berlios.de/svnroot/repos/dzchart/utilities/dzLib/trunk
libs/dzCmdLineParser\src https://svn.berlios.de/svnroot/repos/dzchart/utilities/dzCmdLineParser/trunk/src
libs/dzTemplates https://svn.berlios.de/svnroot/repos/dztemplates/trunk
libs/jcl https://svn.berlios.de/svnroot/repos/dzchart/3rd/jcl/1.99/tags/2

   + libs/dzlib https://svn.berlios.de/svnroot/repos/dzchart/utilities/dzLib/trunk
libs/dzCmdLineParser\src https://svn.berlios.de/svnroot/repos/dzchart/utilities/dzCmdLineParser/trunk/src
libs/dzTemplates https://svn.berlios.de/svnroot/repos/dztemplates/trunk
libs/jcl https://svn.berlios.de/svnroot/repos/dzchart/3rd/jcl/1.99/tags/2
libs/tregexpr https://svn.berlios.de/svnroot/repos/dzchart/3rd/tregexpr/0.952/tags/1


Modified: utilities/dzPrepBuild/trunk/buildtools/PrepBuild.exe
===================================================================
(Binary files differ)

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dpr
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dpr	2010-04-11 18:18:29 UTC (rev 449)
@@ -26,7 +26,8 @@
   u_dzOptionNameList in '..\libs\dzCmdLineParsersrc\u_dzOptionNameList.pas',
   u_dzOptionFoundList in '..\libs\dzCmdLineParsersrc\u_dzOptionFoundList.pas',
   w_dzDialog in '..\libs\dzlib\forms\w_dzDialog.pas' {f_dzDialog},
-  u_dzJclUtils in '..\libs\dzlib\src\u_dzJclUtils.pas';
+  u_dzJclUtils in '..\libs\dzlib\src\u_dzJclUtils.pas',
+  RegExpr in '..\libs\tregexpr\Source\RegExpr.pas';
 
 {$R *_icon.res}
 {$R *_version.res}

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild.dproj
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild.dproj	2010-04-11 18:18:29 UTC (rev 449)
@@ -45,7 +45,7 @@
   <Import Project="$(MSBuildBinPath)\Borland.Delphi.Targets" />
   <PropertyGroup>
     <PreBuildEvent>subwcrev .. SVN_Version_template.ini SVN_Version.ini
-..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --updateini=$(PROJECTPATH)  --productversiontodate --WriteRc=$(PROJECTPATH) --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
+..\buildtools\prepbuild.exe --incbuild --readini=$(PROJECTPATH) --updateini=$(PROJECTPATH) --WriteRc=$(PROJECTPATH) --exec=..\buildtools\prep.cmd $(SAVE)</PreBuildEvent>
   </PropertyGroup>
   <ItemGroup>
     <DelphiCompile Include="PrepBuild.dpr">
@@ -62,6 +62,7 @@
       <Form>f_dzDialog</Form>
     </DCCReference>
     <DCCReference Include="..\libs\dzlib\src\u_dzJclUtils.pas" />
+    <DCCReference Include="..\libs\tregexpr\Source\RegExpr.pas" />
     <DCCReference Include="d_BdsProjVersionInfo.pas">
       <Form>dm_BdsProjVersionInfo</Form>
       <DesignClass>TDataModule</DesignClass>

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_BuildNo.ini	2010-04-11 18:18:29 UTC (rev 449)
@@ -1,4 +1,4 @@
 [Version Info]
-Build=270
-FileVersion=1.2.0.270
+Build=305
+FileVersion=1.2.0.305
 

Modified: utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/PrepBuild_Version.ini	2010-04-11 18:18:29 UTC (rev 449)
@@ -10,13 +10,10 @@
 FileDescription=commandline and IDE prebuild tool
 FileVersion=redirect:PrepBuild_BuildNo.ini,Version Info,FileVersion
 InternalName=PrepBuild
-LegalCopyright=Copyright 2002-2010 by Thomas Mueller
+LegalCopyright=Copyright 2002-{ThisYear} by Thomas Mueller
 LegalTrademarks=
 OriginalFilename=PrepBuild.exe
 ProductName=PrepBuild
-ProductVersion=2010-04-11
-Comments=Use at your own risk
-SVNURL=https://twm at svn.berlios.de/svnroot/repos/dzchart/utilities/dzPrepBuild/trunk
-SVNVersionRange=427:429
-SVNLocalModifications=no
+ProductVersion={today}
+Comments=<svn range=\"{read:svn_version.ini,SVN,VersionRange}\" modified=\"{read:svn_version.ini,SVN,LocalModifications}\" url=\"{read:svn_version.ini,SVN,url}\" />
 

Modified: utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/d_BdsProjVersionInfo.pas	2010-04-11 18:18:29 UTC (rev 449)
@@ -14,11 +14,10 @@
 
 type
   Tdm_BdsProjVersionInfo = class(Tdm_XmlVersionInfo)
-  private
   protected
     procedure InitVersionNodes; override;
   public
-    class function FilenameFor(const _Project: string): string; override;
+    constructor Create(const _Project: string);
   end;
 
 implementation
@@ -27,9 +26,9 @@
 
 { Tdm_BdsProjVersionInfo }
 
-class function Tdm_BdsProjVersionInfo.FilenameFor(const _Project: string): string;
+constructor Tdm_BdsProjVersionInfo.Create(const _Project: string);
 begin
-  Result := ChangeFileExt(_Project, '.bdsproj');
+  inherited Create(ChangeFileExt(_Project, '.bdsproj'));
 end;
 
 procedure Tdm_BdsProjVersionInfo.InitVersionNodes;

Modified: utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/d_DProjVersionInfo.pas	2010-04-11 18:18:29 UTC (rev 449)
@@ -18,16 +18,16 @@
   protected
     procedure InitVersionNodes; override;
   public
-    class function FilenameFor(const _Project: string): string; override;
+    constructor Create(const _Project: string);
   end;
 
 implementation
 
 {$R *.dfm}
 
-class function Tdm_DprojVersionInfo.FilenameFor(const _Project: string): string;
+constructor Tdm_DprojVersionInfo.Create(const _Project: string);
 begin
-  Result := ChangeFileExt(_Project, '.dproj');
+  inherited Create(ChangeFileExt(_Project, '.dproj'));
 end;
 
 procedure Tdm_DprojVersionInfo.InitVersionNodes;

Modified: utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.pas	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/d_XmlVersionInfo.pas	2010-04-11 18:18:29 UTC (rev 449)
@@ -17,7 +17,7 @@
   Tdm_XmlVersionInfo = class(TDataModule, IVersionInfoAccess)
     ProjDoc: TXMLDocument;
   private
-    FProjectName: string;
+    FProjectFilename: string;
     function GetChildNodeContent(_Parent: IXMLNode; const _NodeName, _AttrName: string): string;
     function GetVersionInfo(const _Name: string): string;
     function GetVersionInfoKey(const _Name: string): string;
@@ -39,9 +39,8 @@
     FVersionInfoKeys: IXMLNode;
     procedure InitVersionNodes; virtual; abstract;
   public
-    constructor Create(const _Project: string); reintroduce;
+    constructor Create(const _FullFilename: string); reintroduce;
     destructor Destroy; override;
-    class function FilenameFor(const _Project: string): string; virtual; abstract;
   end;
 
 implementation
@@ -98,10 +97,10 @@
   end;
 end;
 
-constructor Tdm_XmlVersionInfo.Create(const _Project: string);
+constructor Tdm_XmlVersionInfo.Create(const _FullFilename: string);
 begin
   inherited Create(nil);
-  FProjectName := _Project;
+  FProjectFilename := _FullFilename;
   FXmlFilename := VerInfoFilename;
   ProjDoc.FileName := FXmlFilename;
   ProjDoc.Active := True;
@@ -120,6 +119,8 @@
 
 procedure Tdm_XmlVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
 begin
+  _VerInfo.Source := VerInfoFilename;
+
   _VerInfo.AutoIncBuild := SameText(GetVersionInfo('AutoIncBuild'), 'True');
 
   _VerInfo.MajorVer := StrToIntDef(GetVersionInfo('MajorVer'), 0);
@@ -171,7 +172,7 @@
 
 function Tdm_XmlVersionInfo.VerInfoFilename: string;
 begin
-  Result := FilenameFor(FProjectName);
+  Result := FProjectFilename;
 end;
 
 // standard TInterfacedObject implementation of IInterface

Modified: utilities/dzPrepBuild/trunk/src/u_CentralIniVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_CentralIniVersionInfo.pas	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/u_CentralIniVersionInfo.pas	2010-04-11 18:18:29 UTC (rev 449)
@@ -18,15 +18,13 @@
      used to maintain/increment a central build number for several branches of
      a project where the files have different version numbers but the build
      number should be increased for a build of any of these versions. }
-  TCentralVersionInfo = class(TIniVersionInfo, IVersionInfoAccess)
+  TCentralIniVersionInfo = class(TIniVersionInfo, IVersionInfoAccess)
   private
     FProjectName: string;
     procedure GetRedirIdentInfo(const _RedirString: string; out _Filename, _Section, _Ident: string);
     procedure GetRedirSectionInfo(_Redir: string; out _Filename, _Section: string);
     procedure AdjustFilename(var _Filename: string);
   protected
-    function VerInfoFilename: string;
-    //
     function ReadString(const _Section, _Ident: string; _Default: string): string; override;
     procedure WriteString(const _Section, _Ident: string; _Value: string); override;
   public
@@ -35,7 +33,6 @@
                           The constructor appends "_Version.ini" to this
                           name and tries to open the file }
     constructor Create(const _ProjectName: string);
-    class function FilenameFor(const _ProjectName: string): string;
   end;
 
 implementation
@@ -51,18 +48,12 @@
 
 { TCentralVersionInfo }
 
-constructor TCentralVersionInfo.Create(const _ProjectName: string);
+constructor TCentralIniVersionInfo.Create(const _ProjectName: string);
 begin
-  FProjectName := _ProjectName;
-  inherited Create(VerInfoFilename, VERSION_INFO_SECTION, VERSION_INFO_KEYS_SECTION);
+  inherited Create(ChangeFileExt(_ProjectName, '_Version.ini'), VERSION_INFO_SECTION, VERSION_INFO_KEYS_SECTION);
 end;
 
-class function TCentralVersionInfo.FilenameFor(const _ProjectName: string): string;
-begin
-  Result := ChangeFileExt(_ProjectName, '') + '_Version.ini';
-end;
-
-procedure TCentralVersionInfo.AdjustFilename(var _Filename: string);
+procedure TCentralIniVersionInfo.AdjustFilename(var _Filename: string);
 var
   Path: string;
 begin
@@ -73,14 +64,14 @@
   end;
 end;
 
-procedure TCentralVersionInfo.GetRedirSectionInfo(_Redir: string; out _Filename, _Section: string);
+procedure TCentralIniVersionInfo.GetRedirSectionInfo(_Redir: string; out _Filename, _Section: string);
 begin
   _Filename := ExtractStr(_Redir, ',');
   _Section := _Redir;
   AdjustFilename(_Filename);
 end;
 
-procedure TCentralVersionInfo.GetRedirIdentInfo(const _RedirString: string;
+procedure TCentralIniVersionInfo.GetRedirIdentInfo(const _RedirString: string;
   out _Filename, _Section, _Ident: string);
 var
   Redir: string;
@@ -92,7 +83,7 @@
   AdjustFilename(_Filename);
 end;
 
-function TCentralVersionInfo.ReadString(const _Section, _Ident: string; _Default: string): string;
+function TCentralIniVersionInfo.ReadString(const _Section, _Ident: string; _Default: string): string;
 var
   Redir: string;
   IniFile: TMemIniFile;
@@ -123,12 +114,7 @@
   end;
 end;
 
-function TCentralVersionInfo.VerInfoFilename: string;
-begin
-  Result := FilenameFor(FProjectName);
-end;
-
-procedure TCentralVersionInfo.WriteString(const _Section, _Ident: string; _Value: string);
+procedure TCentralIniVersionInfo.WriteString(const _Section, _Ident: string; _Value: string);
 var
   Redir: string;
   IniFile: TMemIniFile;

Modified: utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/u_DofVersionInfo.pas	2010-04-11 18:18:29 UTC (rev 449)
@@ -15,8 +15,6 @@
   TDofVersionInfo = class(TIniVersionInfo, IVersionInfoAccess)
   private
     FProjectName: string;
-  protected
-    function VerInfoFilename: string;
   public
     {: Creates a TDofVersionInfo instance. Succeeds, if the file exists
        and IncludeVerInfo is <> 0
@@ -51,10 +49,5 @@
   Result := ChangeFileExt(_ProjectName, '.dof');
 end;
 
-function TDofVersionInfo.VerInfoFilename: string;
-begin
-  Result := FilenameFor(FProjectName);
-end;
-
 end.
 

Modified: utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/u_IniVersionInfo.pas	2010-04-11 18:18:29 UTC (rev 449)
@@ -23,7 +23,9 @@
     function ReadBool(const _Section, _Ident: string; _Default: boolean): boolean; virtual;
     procedure WriteBool(const _Section, _Ident: string; _Value: boolean); virtual;
   private
-  protected // implementation of IVersionInfo
+    FIniFilename: string;
+  protected // implement IVersionInfoAccess
+    function VerInfoFilename: string;
     procedure ReadFromFile(_VerInfo: TVersionInfo);
     procedure WriteToFile(_VerInfo: TVersionInfo);
   public
@@ -53,6 +55,7 @@
   const _InfoKeysSection: string);
 begin
   inherited Create;
+  FIniFilename := _FullFilename;
   if not FileExists(_FullFilename) then
     raise ENoVersionInfo.CreateFmt(_('File %s does not exist.'), [_FullFilename]);
   FInfoSection := _InfoSection;
@@ -85,6 +88,11 @@
   Result := FIniFile.ReadString(_Section, _Ident, _Default);
 end;
 
+function TIniVersionInfo.VerInfoFilename: string;
+begin
+  Result := FIniFilename;
+end;
+
 procedure TIniVersionInfo.WriteBool(const _Section, _Ident: string; _Value: boolean);
 begin
   WriteInteger(_Section, _Ident, Ord(_Value));
@@ -102,6 +110,8 @@
 
 procedure TIniVersionInfo.ReadFromFile(_VerInfo: TVersionInfo);
 begin
+  _VerInfo.Source := VerInfoFilename;
+
   _VerInfo.AutoIncBuild := ReadBool(FInfoSection, 'AutoIncBuild', False);
 
   _VerInfo.Build := ReadInteger(FInfoSection, 'Build', 0);

Modified: utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/u_PrepBuildMain.pas	2010-04-11 18:18:29 UTC (rev 449)
@@ -68,16 +68,16 @@
     WriteLn(t, {    } ' {');
     WriteLn(t, {    } '  BLOCK "040904E4"');
     WriteLn(t, {    } '  {');
-    WriteLn(t, Format('   VALUE "CompanyName", "%s\000"', [_VersionInfo.CompanyName]));
-    WriteLn(t, Format('   VALUE "FileDescription", "%s\000"', [_VersionInfo.FileDescription]));
-    WriteLn(t, Format('   VALUE "FileVersion", "%s\000"', [_VersionInfo.FileVersion]));
-    WriteLn(t, Format('   VALUE "InternalName", "%s\000"', [_VersionInfo.InternalName]));
-    WriteLn(t, Format('   VALUE "LegalCopyright", "%s\000"', [_VersionInfo.LegalCopyright]));
-    WriteLn(t, Format('   VALUE "LegalTrademarks", "%s\000"', [_VersionInfo.LegalTrademarks]));
-    WriteLn(t, Format('   VALUE "OriginalFilename", "%s\000"', [_VersionInfo.OriginalFilename]));
-    WriteLn(t, Format('   VALUE "ProductName", "%s\000"', [_VersionInfo.ProductName]));
-    WriteLn(t, Format('   VALUE "ProductVersion", "%s\000"', [_VersionInfo.ProductVersion]));
-    WriteLn(t, Format('   VALUE "Comments", "%s\000"', [_VersionInfo.Comments]));
+    WriteLn(t, Format('   VALUE "CompanyName", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.CompanyName)]));
+    WriteLn(t, Format('   VALUE "FileDescription", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.FileDescription)]));
+    WriteLn(t, Format('   VALUE "FileVersion", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.FileVersion)]));
+    WriteLn(t, Format('   VALUE "InternalName", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.InternalName)]));
+    WriteLn(t, Format('   VALUE "LegalCopyright", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.LegalCopyright)]));
+    WriteLn(t, Format('   VALUE "LegalTrademarks", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.LegalTrademarks)]));
+    WriteLn(t, Format('   VALUE "OriginalFilename", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.OriginalFilename)]));
+    WriteLn(t, Format('   VALUE "ProductName", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.ProductName)]));
+    WriteLn(t, Format('   VALUE "ProductVersion", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.ProductVersion)]));
+    WriteLn(t, Format('   VALUE "Comments", "%s\000"', [_VersionInfo.ResolveVariables(_VersionInfo.Comments)]));
     WriteLn(t, {    } '  }');
     WriteLn(t, {    } ' }');
     WriteLn(t, {    } ' BLOCK "VarFileInfo"');
@@ -206,7 +206,7 @@
   if FGetOpt.OptionPassed('ReadIni', Project) then begin
     if Assigned(VerInfoAccess) then
       raise Exception.Create(_('You can only pass one of --ReadDof, --ReadBdsproj, --ReadDproj  or --ReadIni'));
-    VerInfoAccess := TCentralVersionInfo.Create(Project);
+    VerInfoAccess := TCentralIniVersionInfo.Create(Project);
   end;
 
   if FGetOpt.OptionPassed('ReadDproj', Project) then begin
@@ -276,17 +276,6 @@
       WriteLn('Setting ProductVersion to ', VersionInfo.ProductVersion);
     end;
 
-    dt := Now;
-    if FGetOpt.OptionPassed('ProductVersionToDate') then begin
-      VersionInfo.ProductVersion := DateTimeToString('yyyy-mm-dd', dt);
-      WriteLn('Setting ProductVersion to ', VersionInfo.ProductVersion);
-    end;
-
-    if FGetOpt.OptionPassed('ProductVersionToDateTime') then begin
-      VersionInfo.ProductVersion := DateTimeToString('yyyy-mm-dd hh:nn:ss', dt);
-      WriteLn('Setting ProductVersion to ', VersionInfo.ProductVersion);
-    end;
-
     if FGetOpt.OptionPassed('Company', Param) then begin
       VersionInfo.CompanyName := UnquoteStr(Param);
       WriteLn('Setting CompanyName to ', VersionInfo.CompanyName);
@@ -328,7 +317,7 @@
     end;
 
     if FGetOpt.OptionPassed('UpdateIni', Param) then begin
-      VerInfoAccess := TCentralVersionInfo.Create(Param);
+      VerInfoAccess := TCentralIniVersionInfo.Create(Param);
       WriteLn('Updating ', VerInfoAccess.VerInfoFilename);
       VerInfoAccess.WriteToFile(VersionInfo);
     end;
@@ -381,8 +370,6 @@
   FGetOpt.RegisterOption('OriginalName', _('set the original file name (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Product', _('set the product name (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('ProductVersion', _('set the product version (overwrites value from -ReadXxx option)'), true);
-  FGetOpt.RegisterOption('ProductVersionToDate', _('set the proodcut version to the current date  (overwrites value from -ReadXxx and ProductVersion option)'), false);
-  FGetOpt.RegisterOption('ProductVersionToDateTime', _('set the proodcut version to the current date and time (overwrites value from -ReadXxx and ProductVersion option)'), false);
   FGetOpt.RegisterOption('Company', _('set the company name (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Copyright', _('set the legal copyright (overwrites value from -ReadXxx option)'), true);
   FGetOpt.RegisterOption('Trademark', _('set the legal trademark (overwrites value from -ReadXxx option)'), true);

Modified: utilities/dzPrepBuild/trunk/src/u_VersionInfo.pas
===================================================================
--- utilities/dzPrepBuild/trunk/src/u_VersionInfo.pas	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/src/u_VersionInfo.pas	2010-04-11 18:18:29 UTC (rev 449)
@@ -24,6 +24,9 @@
     FInternalName: string;
     FOriginalFilename: string;
     FComments: string;
+    FSource: string;
+    function ResolveVariable(const _s: string): string;
+    procedure AdjustFilename(var _Filename: string);
   protected
     function GetAutoIncBuild: boolean;
     procedure SetAutoIncBuild(_AutoIncBuild: Boolean); virtual;
@@ -61,6 +64,9 @@
     procedure SetProductVersion(_ProductVersion: string); virtual;
   public
     procedure UpdateFileVersion;
+    function ResolveVariables(const _s: string): string;
+
+    property Source: string read FSource write FSource;
     //
     property AutoIncBuild: boolean read GetAutoIncBuild write SetAutoIncBuild;
     //
@@ -83,10 +89,20 @@
 
 implementation
 
+uses
+  RegExpr,
+  StrUtils,
+  DateUtils,
+  IniFiles,
+  u_dzStringUtils,
+  u_dzDateUtils;
+
 { TVersionInfo }
 
 procedure TVersionInfo.Assign(_VersionInfo: TVersionInfo);
 begin
+  Source := _VersionInfo.Source;
+
   AutoIncBuild := _VersionInfo.AutoIncBuild;
 
   MajorVer := _VersionInfo.MajorVer;
@@ -106,6 +122,77 @@
   ProductVersion := _VersionInfo.ProductVersion;
 end;
 
+procedure TVersionInfo.AdjustFilename(var _Filename: string);
+var
+  Path: string;
+begin
+  Path := ExtractFilePath(_Filename);
+  if (Path = '') or ((Path[1] <> '\') and (Copy(Path, 2, 1) <> ':')) then begin
+     // Path is relative, so make it relative to the main .ini/project file
+    _Filename := ExtractFilePath(FSource) + _Filename;
+  end;
+end;
+
+function TVersionInfo.ResolveVariable(const _s: string): string;
+var
+  Redir: string;
+  fn: string;
+  Section: string;
+  Ident: string;
+  IniFile: TMemIniFile;
+begin
+  if UStartsWith('read:', _s) then begin
+    Redir := Copy(_s, Length('read:') + 1);
+    fn := ExtractStr(Redir, ',');
+    Section := ExtractStr(Redir, ',');
+    Ident := Redir;
+    AdjustFilename(fn);
+    IniFile := TMemIniFile.Create(fn);
+    try
+      Result := IniFile.ReadString(Section, Ident, '');
+    finally
+      IniFile.Free;
+    end;
+  end else if SameText('thisyear', _s) then begin
+    Result := IntToStr(YearOf(Date));
+  end else if SameText('today', _s) then begin
+    Result := DateTime2Iso(Date, False);
+  end else if SameText('now', _s) then begin
+    Result := DateTime2Iso(Date, True);
+  end else
+    Result := _s;
+end;
+
+function TVersionInfo.ResolveVariables(const _s: string): string;
+var
+  re: TRegExpr;
+  Found: Boolean;
+  s: string;
+  Start: Integer;
+  Ende: integer;
+begin
+  Result := '';
+  Start := 1;
+  re := TRegExpr.Create;
+  try
+    re.Expression := '\{(.*?)\}';
+    re.Compile;
+    Found := re.Exec(_s);
+    while Found do begin
+      Ende := re.MatchPos[0];
+      Result := Result + Copy(_s, Start, Ende - Start);
+      Start := Ende + re.MatchLen[0];
+      s := re.Match[1];
+      s := ResolveVariable(s);
+      Result := Result + s;
+      Found := re.ExecNext;
+    end;
+    Result := Result + TailStr(_s, Start);
+  finally
+    re.Free;
+  end;
+end;
+
 function TVersionInfo.GetAutoIncBuild: boolean;
 begin
   Result := FAutoIncBuild;

Modified: utilities/dzPrepBuild/trunk/testdata/OriginalTestproject_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/OriginalTestproject_Version.ini	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/testdata/OriginalTestproject_Version.ini	2010-04-11 18:18:29 UTC (rev 449)
@@ -5,23 +5,16 @@
 MinorVer=0
 Release=0
 Build=redirect:Testproject_Build.ini,Version Info,Build
-Debug=0
-PreRelease=0
-Special=0
-Private=0
-DLL=0
-Locale=1033
-CodePage=1252
 
 [Version Info Keys]
 CompanyName=www.dummzeuch.de
 FileDescription=Testproject
-FileVersion=
+FileVersion=1.0.0.3
 InternalName=testproject
-LegalCopyright=Copyright 2002-2007 by Thomas Mueller
+LegalCopyright=Copyright 2002-{ThisYear} by Thomas Mueller
 LegalTrademarks=
 OriginalFilename=testproject.exe
 ProductName=Testproduct
-ProductVersion=2007-07-22
-Comments=internal use only
+ProductVersion={today}
+Comments=<svn range="{read:svn_version.ini,SVN,VersionRange}" modified="{read:svn_version.ini,SVN,LocalModifications}" url="{read:svn_version.ini,SVN,url}" />
 

Added: utilities/dzPrepBuild/trunk/testdata/SVN_Version.ini
===================================================================
--- utilities/dzPrepBuild/trunk/testdata/SVN_Version.ini	2010-04-11 18:12:14 UTC (rev 448)
+++ utilities/dzPrepBuild/trunk/testdata/SVN_Version.ini	2010-04-11 18:18:29 UTC (rev 449)
@@ -0,0 +1,4 @@
+[SVN]
+URL=https://twm at svn.berlios.de/svnroot/repos/dzchart/utilities/dzPrepBuild/trunk
+VersionRange=434:440
+LocalModifications=yes



